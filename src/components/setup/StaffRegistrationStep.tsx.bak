'use client'

import { useState, useRef } from 'react'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Button } from '@/components/ui/button'
import { Checkbox } from '@/components/ui/checkbox'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Plus, X, Users, Upload, Download, AlertCircle } from 'lucide-react'
import * as XLSX from 'xlsx'
import { Alert, AlertDescription } from '@/components/ui/alert'

interface Staff {
  name: string
  birthDate: string
  departmentName: string
  categoryName: string
  workType: 'WEEK_4' | 'WEEK_5'
}

interface StaffRegistrationStepProps {
  data: Staff[]
  departments: { name: string; order: number }[]
  categories: { name: string; priority: number; order: number }[]
  onChange: (data: Staff[]) => void
}

export function StaffRegistrationStep({
  data,
  departments,
  categories,
  onChange,
}: StaffRegistrationStepProps) {
  const [selectedIndices, setSelectedIndices] = useState<number[]>([])
  const [uploadError, setUploadError] = useState<string>('')
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [newStaff, setNewStaff] = useState<Staff>({
    name: '',
    birthDate: '',
    departmentName: departments[0]?.name || '',
    categoryName: categories[0]?.name || '',
    workType: 'WEEK_4',
  })

  const addStaff = () => {
    if (newStaff.name.trim() && newStaff.birthDate.length === 6) {
      onChange([...data, { ...newStaff }])
      setNewStaff({
        name: '',
        birthDate: '',
        departmentName: departments[0]?.name || '',
        categoryName: categories[0]?.name || '',
        workType: 'WEEK_4',
      })
    }
  }

  const removeStaff = (index: number) => {
    onChange(data.filter((_, i) => i !== index))
    setSelectedIndices(selectedIndices.filter((i) => i !== index))
  }

  const toggleSelection = (index: number) => {
    if (selectedIndices.includes(index)) {
      setSelectedIndices(selectedIndices.filter((i) => i !== index))
    } else {
      setSelectedIndices([...selectedIndices, index])
    }
  }

  const applyWorkTypeToSelected = (workType: 'WEEK_4' | 'WEEK_5') => {
    const updated = data.map((staff, index) =>
      selectedIndices.includes(index) ? { ...staff, workType } : staff
    )
    onChange(updated)
    setSelectedIndices([])
  }

  // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
  const downloadTemplate = () => {
    const templateData = [
      {
        ì´ë¦„: 'í™ê¸¸ë™',
        ìƒë…„ì›”ì¼: '950101',
        ë¶€ì„œ: departments[0]?.name || '',
        êµ¬ë¶„: categories[0]?.name || '',
        ê·¼ë¬´í˜•íƒœ: 'ì£¼4ì¼',
      },
      {
        ì´ë¦„: 'ê¹€ì² ìˆ˜',
        ìƒë…„ì›”ì¼: '960215',
        ë¶€ì„œ: departments[0]?.name || '',
        êµ¬ë¶„: categories[1]?.name || '',
        ê·¼ë¬´í˜•íƒœ: 'ì£¼5ì¼',
      },
    ]

    const ws = XLSX.utils.json_to_sheet(templateData)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, 'ì§ì›ëª©ë¡')

    // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
    ws['!cols'] = [
      { wch: 10 }, // ì´ë¦„
      { wch: 12 }, // ìƒë…„ì›”ì¼
      { wch: 15 }, // ë¶€ì„œ
      { wch: 15 }, // êµ¬ë¶„
      { wch: 10 }, // ê·¼ë¬´í˜•íƒœ
    ]

    XLSX.writeFile(wb, 'ì§ì›ë“±ë¡_í…œí”Œë¦¿.xlsx')
  }

  // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    setUploadError('')

    const reader = new FileReader()
    reader.onload = (event) => {
      try {
        const workbook = XLSX.read(event.target?.result, { type: 'binary' })
        const sheetName = workbook.SheetNames[0]
        const worksheet = workbook.Sheets[sheetName]
        const jsonData = XLSX.utils.sheet_to_json(worksheet) as any[]

        if (jsonData.length === 0) {
          setUploadError('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')
          return
        }

        const newStaffList: Staff[] = []
        const errors: string[] = []

        jsonData.forEach((row, index) => {
          const rowNum = index + 2 // ì—‘ì…€ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)

          // í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if (!row['ì´ë¦„']) {
            errors.push(`${rowNum}í–‰: ì´ë¦„ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.`)
            return
          }

          if (!row['ìƒë…„ì›”ì¼']) {
            errors.push(`${rowNum}í–‰: ìƒë…„ì›”ì¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.`)
            return
          }

          // ìƒë…„ì›”ì¼ í˜•ì‹ ê²€ì¦ ë° ë³€í™˜
          let birthDate = String(row['ìƒë…„ì›”ì¼']).replace(/\D/g, '')
          if (birthDate.length === 8) {
            // YYYYMMDD í˜•ì‹ì¸ ê²½ìš° YYMMDDë¡œ ë³€í™˜
            birthDate = birthDate.substring(2)
          }
          if (birthDate.length !== 6) {
            errors.push(`${rowNum}í–‰: ìƒë…„ì›”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (YYMMDD 6ìë¦¬ í•„ìš”)`)
            return
          }

          // ë¶€ì„œ ê²€ì¦
          const deptName = row['ë¶€ì„œ'] || departments[0]?.name
          if (!departments.find((d) => d.name === deptName)) {
            errors.push(`${rowNum}í–‰: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë¶€ì„œì…ë‹ˆë‹¤. (${deptName})`)
            return
          }

          // êµ¬ë¶„ ê²€ì¦
          const catName = row['êµ¬ë¶„'] || categories[0]?.name
          if (!categories.find((c) => c.name === catName)) {
            errors.push(`${rowNum}í–‰: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” êµ¬ë¶„ì…ë‹ˆë‹¤. (${catName})`)
            return
          }

          // ê·¼ë¬´í˜•íƒœ ë³€í™˜
          let workType: 'WEEK_4' | 'WEEK_5' = 'WEEK_4'
          const workTypeStr = String(row['ê·¼ë¬´í˜•íƒœ'] || 'ì£¼4ì¼')
          if (workTypeStr.includes('5') || workTypeStr.includes('5ì¼')) {
            workType = 'WEEK_5'
          }

          newStaffList.push({
            name: String(row['ì´ë¦„']).trim(),
            birthDate,
            departmentName: deptName,
            categoryName: catName,
            workType,
          })
        })

        if (errors.length > 0) {
          setUploadError(errors.join('\n'))
          return
        }

        // ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€
        onChange([...data, ...newStaffList])

        // ì„±ê³µ ë©”ì‹œì§€
        alert(`${newStaffList.length}ëª…ì˜ ì§ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`)

        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        if (fileInputRef.current) {
          fileInputRef.current.value = ''
        }
      } catch (error) {
        console.error('Excel upload error:', error)
        setUploadError('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
      }
    }

    reader.readAsBinaryString(file)
  }

  return (
    <div className="space-y-6">
      <div className="text-center mb-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-2">ì§ì› ë“±ë¡</h2>
        <p className="text-gray-600">
          ì§ì› ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ê·¼ë¬´ í˜•íƒœë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”
        </p>
      </div>

      {/* ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ */}
      <div className="p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Upload className="w-5 h-5 text-green-600" />
            <div>
              <h3 className="font-semibold text-gray-900">ì—‘ì…€ë¡œ ì¼ê´„ ë“±ë¡</h3>
              <p className="text-sm text-gray-600">
                ì—¬ëŸ¬ ëª…ì˜ ì§ì›ì„ í•œ ë²ˆì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              </p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={downloadTemplate}
              className="h-9 border-green-300 hover:bg-green-50"
            >
              <Download className="w-4 h-4 mr-1" />
              í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
            </Button>
            <input
              ref={fileInputRef}
              type="file"
              accept=".xlsx,.xls"
              onChange={handleFileUpload}
              className="hidden"
            />
            <Button
              size="sm"
              onClick={() => fileInputRef.current?.click()}
              className="h-9 bg-green-600 hover:bg-green-700"
            >
              <Upload className="w-4 h-4 mr-1" />
              ì—‘ì…€ ì—…ë¡œë“œ
            </Button>
          </div>
        </div>
      </div>

      {/* ì—…ë¡œë“œ ì—ëŸ¬ ë©”ì‹œì§€ */}
      {uploadError && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription className="whitespace-pre-line">
            {uploadError}
          </AlertDescription>
        </Alert>
      )}

      {/* ì§ì› ëª©ë¡ í…Œì´ë¸” */}
      {data.length > 0 && (
        <div className="border rounded-lg overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50 border-b">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ì„ íƒ
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ì´ë¦„
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ìƒë…„ì›”ì¼
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ë¶€ì„œ
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  êµ¬ë¶„
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ê·¼ë¬´í˜•íƒœ
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                  ì‚­ì œ
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y">
              {data.map((staff, index) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-4 py-3">
                    <Checkbox
                      checked={selectedIndices.includes(index)}
                      onCheckedChange={() => toggleSelection(index)}
                    />
                  </td>
                  <td className="px-4 py-3 font-medium">{staff.name}</td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {staff.birthDate}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {staff.departmentName}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {staff.categoryName}
                  </td>
                  <td className="px-4 py-3">
                    <span
                      className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                        staff.workType === 'WEEK_4'
                          ? 'bg-blue-100 text-blue-700'
                          : 'bg-green-100 text-green-700'
                      }`}
                    >
                      {staff.workType === 'WEEK_4' ? 'ì£¼4ì¼' : 'ì£¼5ì¼'}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => removeStaff(index)}
                      className="h-8 w-8 p-0 hover:bg-red-100 hover:text-red-600"
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* ì§ì› ì¶”ê°€ í¼ */}
      <div className="p-5 bg-gray-50 rounded-lg border border-gray-200">
        <div className="flex items-center gap-2 mb-4">
          <Users className="w-5 h-5 text-blue-600" />
          <h3 className="font-semibold">ìƒˆ ì§ì› ì¶”ê°€</h3>
        </div>

        <div className="grid md:grid-cols-6 gap-3 mb-3">
          <div className="space-y-1">
            <Label className="text-xs">ì´ë¦„ *</Label>
            <Input
              value={newStaff.name}
              onChange={(e) =>
                setNewStaff({ ...newStaff, name: e.target.value })
              }
              placeholder="í™ê¸¸ë™"
              className="h-9"
            />
          </div>

          <div className="space-y-1">
            <Label className="text-xs">ìƒë…„ì›”ì¼ (YYMMDD) *</Label>
            <Input
              value={newStaff.birthDate}
              onChange={(e) => {
                const value = e.target.value.replace(/\D/g, '').slice(0, 6)
                setNewStaff({ ...newStaff, birthDate: value })
              }}
              placeholder="950101"
              maxLength={6}
              className="h-9"
            />
          </div>

          <div className="space-y-1">
            <Label className="text-xs">ë¶€ì„œ</Label>
            <Select
              value={newStaff.departmentName}
              onValueChange={(value) =>
                setNewStaff({ ...newStaff, departmentName: value })
              }
            >
              <SelectTrigger className="h-9">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {departments.map((dept) => (
                  <SelectItem key={dept.name} value={dept.name}>
                    {dept.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-1">
            <Label className="text-xs">êµ¬ë¶„</Label>
            <Select
              value={newStaff.categoryName}
              onValueChange={(value) =>
                setNewStaff({ ...newStaff, categoryName: value })
              }
            >
              <SelectTrigger className="h-9">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {categories.map((cat) => (
                  <SelectItem key={cat.name} value={cat.name}>
                    {cat.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-1">
            <Label className="text-xs">ê·¼ë¬´í˜•íƒœ</Label>
            <div className="flex gap-2 items-center h-9">
              <label className="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  checked={newStaff.workType === 'WEEK_4'}
                  onChange={() =>
                    setNewStaff({ ...newStaff, workType: 'WEEK_4' })
                  }
                  className="w-3 h-3"
                />
                <span className="text-sm">ì£¼4ì¼</span>
              </label>
              <label className="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  checked={newStaff.workType === 'WEEK_5'}
                  onChange={() =>
                    setNewStaff({ ...newStaff, workType: 'WEEK_5' })
                  }
                  className="w-3 h-3"
                />
                <span className="text-sm">ì£¼5ì¼</span>
              </label>
            </div>
          </div>

          <div className="flex items-end">
            <Button
              onClick={addStaff}
              disabled={!newStaff.name.trim() || newStaff.birthDate.length !== 6}
              className="h-9 w-full bg-blue-600"
            >
              <Plus className="w-4 h-4 mr-1" />
              ì¶”ê°€
            </Button>
          </div>
        </div>
      </div>

      {/* ì¼ê´„ ì ìš© */}
      {selectedIndices.length > 0 && (
        <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-blue-900">
              ì„ íƒí•œ {selectedIndices.length}ëª…ì—ê²Œ ì¼ê´„ ì ìš©:
            </span>
            <div className="flex gap-2">
              <Button
                size="sm"
                onClick={() => applyWorkTypeToSelected('WEEK_4')}
                className="h-8 bg-blue-600"
              >
                ì£¼4ì¼ë¡œ ë³€ê²½
              </Button>
              <Button
                size="sm"
                onClick={() => applyWorkTypeToSelected('WEEK_5')}
                className="h-8 bg-green-600"
              >
                ì£¼5ì¼ë¡œ ë³€ê²½
              </Button>
            </div>
          </div>
        </div>
      )}

      <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
        <p className="text-sm text-blue-900">
          ğŸ’¡ <strong>ì•ˆë‚´:</strong> ìƒë…„ì›”ì¼ì€ ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ë° ì¶œí‡´ê·¼ ì²´í¬
          ì‹œ ë³¸ì¸ í™•ì¸ìš©ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. (YYMMDD í˜•ì‹, 6ìë¦¬)
        </p>
      </div>
    </div>
  )
}
