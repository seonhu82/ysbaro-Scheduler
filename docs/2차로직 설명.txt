 2차 로직의 큰틀은 1차배치에서 의사스케줄에 따라 필요인력이
  세팅되고 거기에 맞춰서 형평성이나 연차 오프 신청들을 고려해서 자동으로
  이력을 배치했어 그러고 나면 추가로 배치가 이뤄져야하는데 그이유는 배치가
  되는 모든 인력은 주에 4일 근무가 전제 조건이기 때문이야 물론 이건 세팅에서
  주6일 영업기준에 주4일 근무라고 세팅이를 했기때문에 거기에 맞춰서 하는거야
  정기적인 휴무일인 일요일을 제외한 공휴일은 우선 근무날로 생각하고 배치한뒤에
  공휴일 근무를 다 휴일로 바꾸는 형식으로 배치가 이뤄져 공휴일이 있는 주는
  말이야 이는 주배치를 기본으로 진행되는 로직이기 때문에 공휴일을 제외하고
  배치를 할때 생기는 많은 버그와 설정해야하는 내용을 최소화하기 위한 방법이야
  그래서 공휴일이 있는달은 공휴일(일요일은 정기휴무니까휴업일로취금)을
  근무일로 배치하고 배치가 완료되면 다시 공휴일의 직원 배치는 모드 오프로
  변경하고 거기에 맞게 모든 형평성 펀차를 다시 계산하는게 필요해 왜냐면 배치를
  하며 나온 형평성 편차는 공휴일을 근무일로 해놓고 배치했을때 나온 편차이기
  때문에 실제 배치의 편차와 차이가 있을 수 있기 대문이야 이제 전체적인 배치
  로직을 먼저 설명을 하면 우선 최초 원장 스케줄을 만들어 이때 지난달의 형평성
  편차가 스넵샷으로 따로 저장이 되며 그 내용을 바탕으로 1차 배치가 이루워지고
  1차 배치중에는 형평성 편차가 실시간으로 변경되며 배치가 이루워지지 1차
  배치가 끝나고 나온 형평성 편차를 기반으로 2차 배치가 실행되는데 2차 배치의
  우선 1차 배치범위를 확인해서 그대로 배치범위를 확정해(기간 인원) 범위를
  주별로 나누고 주별 OFF 목표값을 설정해(설정에따라
  (주당영업일-주당근무일)*배치인원 즉 (6-4)*20=40이야)  각주의 현재 모든
  직원의 OFF수를 카운팅해서 40이 아닌 주를 순차적으로 배치해 40보다 적을땐
  근무인원을 OFF로 만들고 40보다 많을땐 근무인원을 더 배치 하며 40을 맞추고
  다음주로 넘어가는 형식이야  배치방식은 배치인력의 실제 주당근무일을 파악하고
  기준  주당근무일(지금 설정엔 4일)과 같지 않은 인원을 배치(4보다
  적을때)하거나 빼(4보다 많을때) 형식인데 이때 일 형평성 및 각 형평성(설정에
  따라 동적으로 작동해야함 지금설정은 야근, 주말, 공휴일전후)의 편차순으로
  정렬해서 배치하거나 오프로 만들어 배치할때는 일자별 오프수가 적은 날부터
  한명씩 배치를 하며 오프로 만들땐 각 형평성중편 차가 가장 낮은날을 오프로
  만드는데 한주에 해당직원이 배치된 형평과 관계있는날이 여러날이면 그중
  오프수가 적은날을 오프날로 지정하고 배치할땐 오프수가 적은날의 해당 형평성을
  고려해서 편차가 높은 순으로 인원을 배치해 예를 들어 야간이 있는나른 총근무
  편차가 높고 야근 편차가 높은 이력을 배치하는 거야 이렇게 배치를 하며 모든
  형평성 편차는 자동계산하고 다음 배치엔 계산된 편차를 기준으로 배치를하는
  로직이야
 2차 자동 배치 로직 전면 재구현 계획                                     │
     │                                                                         │
     │ 전체 배치 흐름                                                          │
     │                                                                         │
     │ 원장 스케줄 생성 (지난달 형평성 스냅샷 저장)                            │
     │   ↓                                                                     │
     │ 1차 배치 (날짜 유형별 우선순위, 주4일 최대 제한, 형평성 실시간 반영)    │
     │   ↓                                                                     │
     │ 2차 배치 (주별 OFF 목표값 기준, 개인 주4일 보장)                        │
     │   ↓                                                                     │
     │ 공휴일 처리 (모든 공휴일 근무 → OFF 변경)                               │
     │   ↓                                                                     │
     │ 최종 형평성 재계산 및 Staff 테이블 저장                                 │
     │                                                                         │
     │ 구체적인 작업 항목                                                      │
     │                                                                         │
     │ 1. RuleSettings 조회 추가                                               │
     │                                                                         │
     │ - 위치: auto-assign/route.ts 초반                                       │
     │ - 내용:                                                                 │
     │   - weekBusinessDays (주 영업일, 기본값 6)                              │
     │   - defaultWorkDays (주 근무일, 기본값 4) 조회                          │
     │   - 이 값들을 배치 로직 전체에서 동적으로 사용                          │
     │                                                                         │
     │ 2. 2차 배치 로직 완전 재구현                                            │
     │                                                                         │
     │ - 위치: auto-assign/route.ts 1차 배치 완료 후                           │
     │ - 로직:                                                                 │
     │   a. 배치 범위의 모든 주차 추출 (일~토 기준)                            │
     │   b. 각 주별로 순차 처리:                                               │
     │       - OFF 목표값 계산: (weekBusinessDays - defaultWorkDays) ×         │
     │ 배치인원                                                                │
     │           - 공휴일이 있는 주: 공휴일 수만큼 목표값 조정 필요            │
     │     - 현재 OFF 수 집계: 해당 주의 모든 직원 OFF 합계                    │
     │     - 주별 조정:                                                        │
     │           - 현재 OFF < 목표: 근무일을 OFF로 변경 (직원별 주4일 초과자   │
     │ 우선)                                                                   │
     │       - 현재 OFF > 목표: OFF를 근무로 변경 (직원별 주4일 미달자 우선)   │
     │   c. 인원 선택 기준:                                                    │
     │       - OFF로 변경 시: 해당 주에서 주4일 초과한 직원 중 해당 날짜의     │
     │ 형평성 편차가 가장 낮은 직원                                            │
     │     - 근무로 변경 시: 해당 주에서 주4일 미달한 직원 중 해당 날짜의      │
     │ 형평성 편차가 가장 높은 직원                                            │
     │   d. 날짜 선택 기준:                                                    │
     │       - OFF로 변경할 날: 현재 OFF 수가 가장 적은 날 우선                │
     │     - 근무로 변경할 날: 현재 OFF 수가 가장 많은 날 우선                 │
     │   e. 형평성 실시간 반영하며 한 명씩 조정                                │
     │                                                                         │
     │ 3. 공휴일 일괄 OFF 처리 (Phase 3 신규)                                  │
     │                                                                         │
     │ - 위치: 2차 배치 완료 후                                                │
     │ - 로직:                                                                 │
     │   a. Holiday 테이블에서 배치 범위의 모든 공휴일 조회                    │
     │   b. 각 공휴일에 대해:                                                  │
     │       - 해당 날짜의 모든 근무(DAY/NIGHT) 배정을 OFF로 변경              │
     │     - StaffAssignment 업데이트                                          │
     │   c. 로그: 변경된 공휴일 수와 인원 출력                                 │
     │                                                                         │
     │ 4. 최종 형평성 재계산 및 저장                                           │
     │                                                                         │
     │ - 위치: 공휴일 처리 완료 후                                             │
     │ - 로직:                                                                 │
     │   a. 모든 배치 인원에 대해 calculateStaffFairnessV2 호출                │
     │   b. 각 직원의 형평성 편차 계산:                                        │
     │       - fairnessScoreTotalDays                                          │
     │     - fairnessScoreNight                                                │
     │     - fairnessScoreWeekend                                              │
     │     - fairnessScoreHoliday                                              │
     │     - fairnessScoreHolidayAdjacent                                      │
     │   c. Staff 테이블에 일괄 업데이트 (updateStaffFairnessScores 함수 사용) │
     │                                                                         │
     │ 5. 주 경계 계산 개선                                                    │
     │                                                                         │
     │ - 위치: getWeekKey, calculateWeeklyWorkDays 함수                        │
     │ - 내용:                                                                 │
     │   - 다른 달이 포함된 주의 영업일 계산 명확화                            │
     │   - 이전 달 배포 범위와 현재 월 배치 범위의 겹침 처리                   │
     │   - 일요일(정기휴무)과 공휴일을 구분하여 영업일 계산                    │
     │                                                                         │
     │ 6. 디버깅 로그 강화                                                     │
     │                                                                         │
     │ - 각 단계별 상세 로그 추가:                                             │
     │   - 2차 배치: 주별 현재 OFF, 목표 OFF, 조정 수                          │
     │   - 공휴일 처리: 변경된 날짜와 인원                                     │
     │   - 최종 형평성: 평균, 최대/최소 편차                                   │
     │                                                                         │
     │ 주요 수정 파일                                                          │
     │                                                                         │
     │ - src/app/api/schedule/auto-assign/route.ts (메인 로직)                 │
     │ - 필요시 src/lib/services/fairness-calculator-v2.ts (형평성 계산 개선) 