# 성능 모니터링 대시보드 전략

## 개요

실시간으로 시스템 성능을 추적하고 병목 지점을 파악하기 위한 포괄적인 모니터링 대시보드.

**작성일**: 2025-10-28
**구현 대상**: 연세바로치과 스케줄러

## 모니터링 대상

### 1. API 성능 지표
- **응답 시간**: 평균/중앙값/P95/P99
- **처리량**: 초당 요청 수 (RPS)
- **에러율**: 4xx/5xx 에러 비율
- **느린 요청**: 5초 이상 걸린 요청

### 2. 데이터베이스 지표
- **쿼리 성능**: 평균 실행 시간
- **인덱스 사용률**: 각 인덱스의 사용 빈도
- **느린 쿼리**: 100ms 이상 걸린 쿼리
- **연결 풀**: 활성/유휴 연결 수

### 3. 캐시 성능
- **히트율**: 캐시 적중률 (%)
- **미스율**: 캐시 미스율 (%)
- **에러율**: 캐시 에러 발생률
- **메모리 사용량**: Redis 메모리 사용률

### 4. 배치 작업 성능
- **실행 시간**: 주간 배치 실행 시간
- **성공률**: 배치 성공/실패 비율
- **처리량**: 처리된 슬롯/스태프 수
- **재시도**: 재시도 횟수

### 5. 비즈니스 지표
- **활성 사용자**: 동시 접속 사용자 수
- **연차 신청**: 시간당 신청 수
- **스케줄 조회**: 인기 페이지 조회수
- **알림 발송**: 알림 발송 성공률

## 데이터 수집 전략

### 1. 메트릭 저장
```typescript
interface PerformanceMetric {
  timestamp: Date
  metricType: 'api' | 'database' | 'cache' | 'batch' | 'business'
  metricName: string
  value: number
  unit: 'ms' | 'count' | 'percentage'
  tags?: Record<string, string>
}
```

### 2. 저장소
- **단기 데이터 (24시간)**: Redis (빠른 조회)
- **장기 데이터 (90일)**: PostgreSQL (통계 분석)
- **실시간 데이터**: 메모리 (최근 5분)

### 3. 집계 간격
- **실시간**: 5초 간격
- **단기**: 1분 간격
- **중기**: 5분 간격
- **장기**: 1시간 간격

## 대시보드 구성

### 1. 개요 대시보드 (Overview)
```
┌─────────────────────────────────────────────┐
│  시스템 상태: 🟢 정상                        │
├─────────────┬─────────────┬─────────────────┤
│ API 응답시간 │  캐시 히트율 │  에러율         │
│   250ms     │    98.5%    │    0.2%        │
├─────────────┴─────────────┴─────────────────┤
│  🔄 실시간 요청 (최근 5분)                   │
│  [그래프: 요청 수 추이]                      │
├─────────────────────────────────────────────┤
│  ⚠️  느린 요청 Top 5                         │
│  1. POST /api/schedule/assign - 8.2s       │
│  2. GET /api/stats/fairness - 5.1s         │
└─────────────────────────────────────────────┘
```

### 2. API 대시보드
- 엔드포인트별 응답 시간 분포
- HTTP 상태 코드 분포
- 가장 많이 호출되는 API Top 10
- 가장 느린 API Top 10

### 3. 데이터베이스 대시보드
- 쿼리 실행 시간 분포
- 테이블별 읽기/쓰기 작업 수
- 인덱스 사용 통계
- 느린 쿼리 로그

### 4. 캐시 대시보드
- 캐시 히트/미스 추이
- 키별 캐시 성능
- 메모리 사용량 추이
- 만료된 키 통계

### 5. 배치 대시보드
- 배치 실행 이력
- 성공/실패 추이
- 평균 실행 시간
- 병목 지점 분석

## 알림 규칙

### Critical (즉시 알림)
- API 에러율 > 5%
- 평균 응답 시간 > 5초
- 캐시 히트율 < 50%
- 배치 작업 실패

### Warning (모니터링)
- API 에러율 > 2%
- 평균 응답 시간 > 3초
- 캐시 히트율 < 80%
- 느린 쿼리 증가

### Info (참고)
- 새로운 느린 엔드포인트 발견
- 캐시 히트율 개선
- 데이터베이스 인덱스 추가 권장

## 성능 목표 (SLA)

### API 성능
- P95 응답 시간: < 1초
- P99 응답 시간: < 3초
- 에러율: < 1%
- 가용성: > 99.9%

### 데이터베이스
- 평균 쿼리 시간: < 50ms
- 느린 쿼리 비율: < 5%
- 인덱스 사용률: > 90%

### 캐시
- 히트율: > 95%
- 평균 응답 시간: < 10ms

### 배치
- 주간 배치 실행 시간: < 5분
- 성공률: > 99%

## 구현 파일

1. `src/lib/monitoring/metrics-collector.ts` - 메트릭 수집
2. `src/lib/monitoring/performance-tracker.ts` - 성능 추적
3. `src/app/api/monitoring/metrics/route.ts` - 메트릭 API
4. `src/app/(dashboard)/monitoring/page.tsx` - 대시보드 UI
5. `src/components/monitoring/PerformanceChart.tsx` - 성능 차트
6. `src/components/monitoring/MetricsCard.tsx` - 지표 카드

## 데이터 보존 정책

- **실시간 (5초)**: 5분간 보존
- **단기 (1분)**: 24시간 보존 (Redis)
- **중기 (5분)**: 7일 보존 (Redis)
- **장기 (1시간)**: 90일 보존 (PostgreSQL)

## 보안 고려사항

- 민감한 쿼리 파라미터 마스킹
- IP 주소 익명화
- 개인 식별 정보 제거
- 관리자 권한만 접근 가능

## 다음 단계

1. ✅ 메트릭 수집 시스템 구축
2. ✅ 성능 추적 미들웨어 추가
3. ✅ 실시간 대시보드 UI 구현
4. ⏭️ 알림 시스템 연동
5. ⏭️ 히스토리 데이터 분석

## 참고 자료

- [Sentry Performance Monitoring](https://docs.sentry.io/product/performance/)
- [Redis Monitoring Best Practices](https://redis.io/docs/management/optimization/)
- [PostgreSQL pg_stat_statements](https://www.postgresql.org/docs/current/pgstatstatements.html)
