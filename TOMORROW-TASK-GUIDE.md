# 📋 내일 작업 가이드 - 연차/오프 신청 동적 제한 시스템 테스트

## 🎯 오늘 완료한 작업 요약

**연차/오프 신청 동적 제한 시스템**을 구현하고 커밋 완료했습니다.

**커밋 정보**:
- 커밋 ID: `a1a20af`
- 메시지: "feat: Implement dynamic leave application restriction system"

## 📦 구현된 기능

### 핵심 기능
1. **시뮬레이션 엔진**: 신청 전에 자동 배치 가능성을 검증
2. **제약 조건 검증**:
   - ✅ 주4일 제약 (공휴일 고려)
   - ✅ 구분별 필수 인원
   - ✅ 편차 범위 (확장 가능)
3. **사용자 친화적 메시지**: 거절 시 이유와 대안 명확히 제공

### 새로 생성된 API
- **엔드포인트**: `/api/leave-apply/[token]/submit-v3`
- **기능**: 기존 submit에 시뮬레이션 검증 추가

## 🧪 내일 테스트 시나리오

### 1단계: 서버 시작 및 기본 확인

```bash
# 1. 서버 시작
npm run dev

# 2. 서버가 정상 시작되는지 확인
# http://localhost:3000 접속
```

**확인 사항**:
- [ ] 서버가 에러 없이 시작되는가?
- [ ] 콘솔에 컴파일 에러가 없는가?

---

### 2단계: 연차/오프 신청 페이지 접속

```
경로: (public)/leave-apply/[token]
```

**준비물**:
- 유효한 ApplicationLink 토큰 (기존에 사용하던 것)

**확인 사항**:
- [ ] 페이지가 정상적으로 로드되는가?
- [ ] 상단에 "연차/오프 신청 안내" 박스가 표시되는가?
  - "꼭 필요한 날짜만 신청해주세요"
  - "나머지 OFF는 자동 배치 시스템이 형평성을 고려하여 자동 배분"
- [ ] 통계 카드가 표시되는가? (현재 신청 / 자동 배치 예정)

**예상 화면**:
```
┌────────────────────────────────────────────────┐
│ 📌 연차/오프 신청 안내                           │
│                                             │
│ ✓ 꼭 필요한 날짜만 신청해주세요                   │
│ ✓ 나머지는 자동 배치가 공평하게 배정합니다          │
│ ✓ 과도한 신청은 전체 스케줄 생성을 방해합니다      │
└─────────────────────────────────────────────┘

┌──────────────┬──────────────┐
│  2 / 10일    │    8일        │
│ 신청 / 예상   │  자동 배치     │
└──────────────┴──────────────┘

✅ 적절한 신청 수준입니다
```

---

### 3단계: 정상 신청 테스트 (통과 케이스)

**테스트 방법**:
1. 인증 (PIN 입력)
2. 가능한 날짜 선택 (현재 배치가 있고, 여유가 있는 날)
3. "일괄 신청하기" 클릭

**확인 사항**:
- [ ] 신청이 성공하는가?
- [ ] 성공 메시지에 다음 문구가 포함되는가?
  - "신청이 완료되었습니다. 나머지 OFF는 자동 배치 시스템이 형평성을 고려하여 배정합니다."
- [ ] 콘솔에 `✅ [동적 제한] 시뮬레이션 통과` 로그가 보이는가?

**콘솔 로그 확인**:
```
🔍 [동적 제한] 시뮬레이션 시작: 홍길동 - 2025-02-15 (OFF)
✅ [동적 제한] 시뮬레이션 통과: 자동 배치 가능
✅ [동적 제한] 신청 완료: 홍길동 (2025-02-15) - PENDING
```

---

### 4단계: 주4일 제약 위반 테스트 (거절 케이스)

**테스트 시나리오**:
1. 한 주에 이미 여러 날 OFF 신청이 있는 직원 선택
2. 그 주에 추가로 OFF 신청 시도
3. 주4일 미만이 되도록 시도

**예상 결과**:
- [ ] 신청이 거절되는가?
- [ ] 에러 메시지에 다음 내용이 포함되는가?
  - 제목: "주간 근무일 부족"
  - 메시지: "해당 주(2/11~2/17)에 이 날짜까지 OFF를 받으면 주4일 미만 근무가 됩니다"
  - 제안: "주4일 근무 원칙을 지키기 위해 이 날짜는 자동 배치에 맡겨주세요"

**콘솔 로그 확인**:
```
🔍 [동적 제한] 시뮬레이션 시작: 홍길동 - 2025-02-15 (OFF)
❌ [동적 제한] 시뮬레이션 실패: WEEK_4DAY_VIOLATION
```

---

### 5단계: 구분별 인원 부족 테스트 (거절 케이스)

**테스트 시나리오**:
1. 특정 날짜에 같은 구분의 직원들이 이미 많이 OFF 신청한 경우
2. 추가로 같은 구분 직원이 신청 시도
3. 필요 인원을 채울 수 없는 상황 만들기

**예상 결과**:
- [ ] 신청이 거절되는가?
- [ ] 에러 메시지에 다음 내용이 포함되는가?
  - 제목: "인원 부족으로 자동 배치가 어렵습니다"
  - 메시지: "이 날짜는 실팀장급 4명이 필요하지만, 귀하를 제외하면 3명만 근무 가능합니다"
  - 제안: "꼭 필요한 날짜가 아니라면 자동 배치로 형평성 있는 OFF를 받으실 수 있습니다"

**콘솔 로그 확인**:
```
🔍 [동적 제한] 시뮬레이션 시작: 홍길동 - 2025-02-15 (OFF)
❌ [동적 제한] 시뮬레이션 실패: CATEGORY_SHORTAGE
```

---

### 6단계: 과도한 신청 경고 테스트

**테스트 시나리오**:
1. 한 직원이 여러 날 (예: 5일 이상) 신청
2. 통계 카드의 상태 변화 확인

**예상 결과**:
- [ ] 신청 수가 증가하면 통계 카드 색상이 변하는가?
  - good (초록색): 권장 수준 이하
  - warning (노란색): 다소 많음
  - critical (빨간색): 매우 많음
- [ ] 경고 메시지가 표시되는가?
  - "신청이 다소 많습니다 (5/10일). 자동 배치의 유연성이 감소할 수 있습니다."

---

## 🔍 디버깅 팁

### 콘솔 로그 확인
서버 콘솔에서 다음 로그를 확인:
- `🔍 [동적 제한] 시뮬레이션 시작:` - 시뮬레이션 시작
- `✅ [동적 제한] 시뮬레이션 통과:` - 성공
- `❌ [동적 제한] 시뮬레이션 실패:` - 거절

### 브라우저 개발자 도구
1. F12로 개발자 도구 열기
2. Network 탭에서 `submit-v3` API 호출 확인
3. Response에서 상세 에러 메시지 확인

### API 직접 테스트 (선택)
Postman이나 curl로 직접 테스트:
```bash
curl -X POST http://localhost:3000/api/leave-apply/[TOKEN]/submit-v3 \
  -H "Content-Type: application/json" \
  -d '{
    "date": "2025-02-15",
    "type": "OFF",
    "pin": "123456"
  }'
```

---

## 🐛 예상 가능한 문제와 해결

### 문제 1: 서버가 시작되지 않음
**원인**: TypeScript 컴파일 에러
**해결**:
```bash
npx tsc --noEmit
# 에러 확인 후 수정
```

### 문제 2: 시뮬레이션이 항상 통과함
**원인**: 제약 조건이 제대로 작동하지 않음
**확인**:
- DailySlot이 생성되어 있는가?
- 직원 배치가 있는가?
- 콘솔 로그에서 쿼리 결과 확인

### 문제 3: 에러 메시지가 표시되지 않음
**원인**: 프론트엔드 에러 처리 누락
**확인**:
- 브라우저 콘솔에서 JavaScript 에러 확인
- API 응답의 `userMessage` 필드 확인

### 문제 4: 통계가 표시되지 않음
**원인**: statistics API 호출 실패
**확인**:
```
GET /api/leave-apply/[token]/statistics?staffId=xxx
```
- API가 정상 응답하는지 Network 탭에서 확인

---

## 📝 테스트 결과 기록 템플릿

테스트하면서 다음 형식으로 기록하세요:

```
## 테스트 날짜: 2025-11-12

### 1단계: 서버 시작
- [ ] 통과 / [ ] 실패
- 메모:

### 2단계: 페이지 로드
- [ ] 통과 / [ ] 실패
- 메모:

### 3단계: 정상 신청
- [ ] 통과 / [ ] 실패
- 메모:

### 4단계: 주4일 위반
- [ ] 통과 / [ ] 실패
- 메모:

### 5단계: 인원 부족
- [ ] 통과 / [ ] 실패
- 메모:

### 6단계: 과도한 신청
- [ ] 통과 / [ ] 실패
- 메모:

## 발견된 버그
1.
2.

## 개선 아이디어
1.
2.
```

---

## 🔧 문제 발견 시 대응

### 버그 발견 시
1. **증상 기록**: 정확히 무슨 문제가 발생했는지
2. **재현 방법**: 어떻게 하면 다시 발생하는지
3. **콘솔 로그**: 서버와 브라우저 콘솔 내용
4. **스크린샷**: 화면 캡처

### 수정이 필요한 경우
- 파일 위치는 위의 "구현된 파일" 섹션 참고
- 주요 로직:
  - 시뮬레이터: `src/lib/services/leave-eligibility-simulator.ts`
  - 메시지: `src/lib/services/leave-rejection-message-builder.ts`
  - API: `src/app/api/leave-apply/[token]/submit-v3/route.ts`

---

## 🎯 테스트 완료 후 다음 작업

### 테스트 성공 시
1. ✅ 시스템이 정상 작동 확인
2. ✅ 사용자 피드백 수집 계획
3. ✅ 필요시 메시지 문구 조정
4. ✅ Phase 5 (선택적 기능) 고려

### 추가 개선 고려사항
- [ ] 대안 날짜 추천 기능
- [ ] 편차 정보 상세 표시
- [ ] 관리자 대시보드
- [ ] 성능 모니터링
- [ ] 캐싱 전략

---

## 📚 참고 문서

프로젝트 루트의 다음 문서들을 참고하세요:

1. **DYNAMIC-RESTRICTION-SYSTEM.md**
   - 전체 시스템 상세 문서
   - 작동 원리 및 구조

2. **IMPLEMENTATION-SUMMARY.md**
   - 구현 요약
   - API 응답 형식
   - 배포 방법

3. **test-dynamic-restriction.js**
   - 직접 시뮬레이터 테스트 스크립트
   - 실행: `node test-dynamic-restriction.js`
   - (실제 데이터로 테스트하려면 ID 수정 필요)

---

## 💬 질문이나 이슈 발생 시

다음 정보를 준비해주세요:
1. 어떤 단계에서 문제가 발생했는가?
2. 에러 메시지 (콘솔 로그)
3. 재현 방법
4. 스크린샷

---

## ✅ 체크리스트 (테스트 전)

- [ ] 최신 코드로 pull 완료 (커밋 a1a20af)
- [ ] npm install 실행 (혹시 모를 의존성)
- [ ] .env 파일 확인 (DATABASE_URL 등)
- [ ] 데이터베이스 연결 확인

---

## 🚀 시작하기

```bash
# 1. 터미널 열기
cd "D:/작업/프로그램 만들기/ysbaro-Scheduler"

# 2. 최신 코드 확인
git log -1
# a1a20af이 최신 커밋인지 확인

# 3. 서버 시작
npm run dev

# 4. 브라우저에서 연차/오프 신청 페이지 접속
# http://localhost:3000/leave-apply/[TOKEN]
```

**테스트 시작!** 📋✨

문제가 있거나 질문이 있으면 이 문서를 참고하고, 필요하면 저에게 물어보세요!
