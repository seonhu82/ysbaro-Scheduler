// Prisma Schema for ì—°ì„¸ë°”ë¡œì¹˜ê³¼ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ ì‹œìŠ¤í…œ
// Generated: 2025-10-22

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// 1. ì‚¬ìš©ì ë° ë³‘ì› ì •ë³´
// ============================================

enum UserRole {
  SUPER_ADMIN // ì‹œìŠ¤í…œ ì „ì²´ ê´€ë¦¬ì (ê°œë°œì)
  ADMIN // ë³‘ì› ì‹œìŠ¤í…œ ê´€ë¦¬ì
  MANAGER // ë³‘ì› ê´€ë¦¬ì (ìŠ¤ì¼€ì¤„ ê´€ë¦¬ ê¶Œí•œ)
  STAFF // ì¼ë°˜ ì§ì› (ì¡°íšŒë§Œ ê°€ëŠ¥)
}

enum AccountStatus {
  PENDING // ê°€ì… ëŒ€ê¸° (ìŠ¹ì¸ í•„ìš”)
  APPROVED // ìŠ¹ì¸ë¨
  REJECTED // ê±°ì ˆë¨
  SUSPENDED // ì •ì§€ë¨
  DELETED // ì‚­ì œë¨
}

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  role     UserRole @default(STAFF)

  // ê°€ì… ìŠ¹ì¸ ê´€ë ¨ í•„ë“œ
  accountStatus   AccountStatus @default(PENDING)
  approvedBy      String? // ìŠ¹ì¸ì User ID
  approvedAt      DateTime?
  rejectedReason  String?
  suspendedReason String?
  suspendedUntil  DateTime?

  clinicId  String?
  clinic    Clinic?  @relation(fields: [clinicId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  notifications       Notification[]
  activityLogs        ActivityLog[]
  passwordResetTokens PasswordResetToken[]
  approvedUsers       User[]               @relation("UserApprovals") // ë‚´ê°€ ìŠ¹ì¸í•œ ì‚¬ìš©ìë“¤
  approver            User?                @relation("UserApprovals", fields: [approvedBy], references: [id])

  @@index([clinicId])
  @@index([email])
  @@index([accountStatus])
  @@index([role])
}

// ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† í°
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Clinic {
  id             String   @id @default(cuid())
  name           String
  address        String?
  phone          String?
  setupCompleted Boolean  @default(false) // ì´ˆê¸° ì„¤ì • ì™„ë£Œ ì—¬ë¶€
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ê´€ê³„
  users                 User[]
  doctors               Doctor[]
  staff                 Staff[]
  departments           Department[]
  staffCategories       StaffCategory[]
  doctorCategories      DoctorCategory[]
  doctorCombinations    DoctorCombination[]
  weeklyPatterns        WeeklyPattern[]
  closedDaySettings     ClosedDaySettings?
  schedules             Schedule[]
  holidays              Holiday[]
  leaveApplications     LeaveApplication[]
  applicationLinks      ApplicationLink[]
  scheduleViewLinks     ScheduleViewLink[]
  deploymentSettings    DeploymentSettings?
  ruleSettings          RuleSettings?
  fairnessSettings      FairnessSettings?
  categoryRatioSettings CategoryRatioSettings?
  notificationSettings  NotificationSettings?
  backupConfigs         BackupConfig[]
  backups               Backup[]
  notifications         Notification[]
  activityLogs          ActivityLog[]
  weekInfos             WeekInfo[]
  qrTokens              QRToken[]
  attendanceRecords     AttendanceRecord[]
  leavePeriods          LeavePeriod[]
  kakaoSettings         KakaoSettings?
}

// ============================================
// 2. ë¶€ì„œ ë° êµ¬ë¶„ ì„¤ì •
// ============================================

// ë¶€ì„œ (ì§ì› ì†Œì†)
model Department {
  id                String          @id @default(cuid())
  clinicId          String
  clinic            Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  name              String
  order             Int             @default(0) // í‘œì‹œ ìˆœì„œ
  useAutoAssignment Boolean         @default(true) // ìë™ë°°ì¹˜ ì‚¬ìš© ì—¬ë¶€
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  categories        StaffCategory[] // ì´ ë¶€ì„œì— ì†í•œ êµ¬ë¶„ë“¤

  @@unique([clinicId, name])
  @@index([clinicId])
}

// ì§ì› êµ¬ë¶„ (ìŠ¤ì¼€ì¤„ ë°°ì¹˜ ìš°ì„ ìˆœìœ„ìš©)
model StaffCategory {
  id           String      @id @default(cuid())
  clinicId     String
  clinic       Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  departmentId String? // ì†Œì† ë¶€ì„œ (nullable - ë¶€ì„œ ì—†ì´ êµ¬ë¶„ë§Œ ìˆì„ ìˆ˜ë„ ìˆìŒ)
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  name         String // íŒ€ì¥/ì‹¤ì¥, ê³ ë…„ì°¨, ì¤‘ê°„ë…„ì°¨, ì €ë…„ì°¨
  priority     Int // ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë¨¼ì € ë°°ì¹˜)
  order        Int         @default(0) // í‘œì‹œ ìˆœì„œ
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([clinicId, name])
  @@index([clinicId])
  @@index([departmentId])
  @@index([priority])
}

// ì›ì¥ êµ¬ë¶„ (ì„ íƒì  ì‚¬ìš©)
model DoctorCategory {
  id        String   @id @default(cuid())
  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  name      String // ìƒë‹´, ì§„ë£Œ ë“±
  shortName String   @default("") // ì¡°í•©ëª…ìš© ì¤„ì„í‘œì‹œ (ì˜ˆ: "ë°•(ìƒë‹´)")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([doctorId, name])
  @@index([clinicId])
  @@index([doctorId])
}

// ì˜ì‚¬ ì¡°í•© (ì¼ íŒ¨í„´)
model DoctorCombination {
  id                      String   @id @default(cuid())
  clinicId                String
  clinic                  Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  name                    String // ì¡°í•©ëª… (ì˜ˆ: ë°•(ìƒë‹´)êµ¬ìœ¤)
  dayOfWeek               String // MONDAY, TUESDAY ë“±
  requiredStaff           Int // í•„ìš” ì¸ì› ìˆ˜ (ë ˆê±°ì‹œ, í•˜ìœ„ í˜¸í™˜ìš©)
  departmentRequiredStaff Json? // ë¶€ì„œë³„ í•„ìš” ì¸ì› {"ë°ìŠ¤í¬": 2, "ì§„ë£Œì‹¤": 3}
  departmentCategoryStaff Json? // ë¶€ì„œë³„ êµ¬ë¶„ë³„ í•„ìš” ì¸ì› {"ì§„ë£Œì‹¤": {"ì‹¤íŒ€ì¥": {"count": 2, "minRequired": 1}}}
  doctors                 String[] // ["ë°•ì›ì¥(ìƒë‹´)", "êµ¬ì›ì¥", "ìœ¤ì›ì¥"] í˜•íƒœ
  hasNightShift           Boolean  @default(false) // ì•¼ê°„ ì§„ë£Œ ì—¬ë¶€
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // ê´€ê³„
  weeklyPatternDays WeeklyPatternDay[]

  @@index([clinicId])
  @@index([dayOfWeek])
}

// ì£¼ê°„ íŒ¨í„´ (7ì¼ ì¡°í•© ê·¸ë£¹)
model WeeklyPattern {
  id          String   @id @default(cuid())
  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  name        String // íŒ¨í„´ëª… (ì˜ˆ: "ì¼ë°˜ ì£¼ê°„ íŒ¨í„´", "ì—¬ë¦„ íŒ¨í„´")
  description String? // íŒ¨í„´ ì„¤ëª…
  isDefault   Boolean  @default(false) // ê¸°ë³¸ íŒ¨í„´ ì—¬ë¶€
  isActive    Boolean  @default(true) // í™œì„±í™” ì—¬ë¶€
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ê´€ê³„
  days WeeklyPatternDay[]

  @@index([clinicId])
  @@index([isDefault])
}

// ì£¼ê°„ íŒ¨í„´ì˜ ê° ìš”ì¼ë³„ ì¡°í•©
model WeeklyPatternDay {
  id              String             @id @default(cuid())
  weeklyPatternId String
  weeklyPattern   WeeklyPattern      @relation(fields: [weeklyPatternId], references: [id], onDelete: Cascade)
  dayOfWeek       String // MONDAY, TUESDAY, ..., SUNDAY
  combinationId   String? // ë°°ì •ëœ ì˜ì‚¬ ì¡°í•© ID (nullì´ë©´ íœ´ë¬´ì¼)
  combination     DoctorCombination? @relation(fields: [combinationId], references: [id], onDelete: SetNull)
  isClosedDay     Boolean            @default(false) // íœ´ë¬´ì¼ ì—¬ë¶€
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@unique([weeklyPatternId, dayOfWeek])
  @@index([weeklyPatternId])
  @@index([combinationId])
}

// íœ´ì—…ì¼ ì„¤ì •
model ClosedDaySettings {
  id              String   @id @default(cuid())
  clinicId        String   @unique
  clinic          Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  includeHolidays Boolean  @default(true) // ê³µíœ´ì¼ í¬í•¨ ì—¬ë¶€
  years           Int[] // ê³µíœ´ì¼ ì¡°íšŒ ì—°ë„ë“¤
  regularDays     Json // [{dayOfWeek: "SUNDAY", weekOfMonth: 2}, ...] í˜•íƒœ
  specificDates   String[] // ["2025-01-01", "2025-12-25"] í˜•íƒœ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// êµ¬ë¶„ë³„ í•„ìš”ì¸ì› ë¹„ìœ¨ ì„¤ì •
model CategoryRatioSettings {
  id        String   @id @default(cuid())
  clinicId  String   @unique
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  ratios    Json // { "íŒ€ì¥/ì‹¤ì¥": 15, "ê³ ë…„ì°¨": 30, "ì¤‘ê°„ë…„ì°¨": 35, "ì €ë…„ì°¨": 20 }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 3. ì›ì¥ ë° íŒ¨í„´ ê´€ë¦¬
// ============================================

model Doctor {
  id             String   @id @default(cuid())
  clinicId       String
  clinic         Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  name           String
  shortName      String   @default("") // ì¡°í•©ëª…ìš© ì¤„ì„í‘œì‹œ (ì˜ˆ: "ë°•", "í™©")
  specialization String?
  useCategory    Boolean  @default(false) // êµ¬ë¶„ ì‚¬ìš© ì—¬ë¶€
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ê´€ê³„
  categories      DoctorCategory[]
  patterns        DoctorPattern[]
  scheduleDoctors ScheduleDoctor[]

  @@index([clinicId])
}

model DoctorPattern {
  id          String   @id @default(cuid())
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patternName String // "ê¸°ë³¸ íŒ¨í„´", "ì—¬ë¦„ íŒ¨í„´" ë“±
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ê´€ê³„
  days DoctorPatternDay[]

  @@index([doctorId])
}

model DoctorPatternDay {
  id            String        @id @default(cuid())
  patternId     String
  pattern       DoctorPattern @relation(fields: [patternId], references: [id], onDelete: Cascade)
  dayOfWeek     Int // 0=ì¼, 1=ì›”, ..., 6=í† 
  isWorkday     Boolean       @default(true)
  hasNightShift Boolean       @default(false)

  @@unique([patternId, dayOfWeek])
  @@index([patternId])
}

// ============================================
// 4. ì§ì› ê´€ë¦¬
// ============================================

enum StaffRank {
  HYGIENIST // ìœ„ìƒì‚¬
  ASSISTANT // ì–´ì‹œìŠ¤í„´íŠ¸
  COORDINATOR // ì½”ë””ë„¤ì´í„°
  NURSE // ê°„í˜¸ì¡°ë¬´ì‚¬
  OTHER // ê¸°íƒ€
}

enum WorkType {
  WEEK_4 // ì£¼4ì¼ ê·¼ë¬´
  WEEK_5 // ì£¼5ì¼ ê·¼ë¬´
}

model Staff {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // ê¸°ë³¸ ì •ë³´
  name                  String
  rank                  StaffRank?
  departmentName        String? // ë¶€ì„œëª…
  categoryName          String? // êµ¬ë¶„ëª… (ìŠ¤ì¼€ì¤„ ë°°ì¹˜ìš©)
  position              String     @default("") // ì§ê¸‰
  flexibleForCategories String[] // ë°°ì¹˜ ìœ ì—°ì„± (ë‹¤ë¥¸ êµ¬ë¶„ìœ¼ë¡œë„ ë°°ì¹˜ ê°€ëŠ¥)
  flexibilityPriority   Int        @default(0) // ìœ ì—° ë°°ì¹˜ ìš°ì„ ìˆœìœ„
  phoneNumber           String?
  email                 String?

  // ê·¼ë¬´ ì •ë³´
  birthDate    DateTime // ìƒë…„ì›”ì¼ (í•„ìˆ˜) - PIN ìƒì„±ìš©
  birthDateStr String? // ìƒë…„ì›”ì¼ ë¬¸ìì—´ (YYMMDD, ì‹ ê·œ)
  hireDate     DateTime? // ì…ì‚¬ì¼ - ì—°ì°¨ ê³„ì‚°ìš©
  workDays     Int       @default(4) // ì£¼ë‹¹ ê·¼ë¬´ì¼ìˆ˜ (ê¸°ì¡´ í˜¸í™˜)
  workType     WorkType? // ê·¼ë¬´ í˜•íƒœ (ì‹ ê·œ)
  pin          String? // 6ìë¦¬ PIN (ì´ˆê¸°: YYMMDD)

  // ì—°ì°¨ ì •ë³´
  totalAnnualDays Int @default(15) // ì´ ì—°ì°¨ ì¼ìˆ˜
  usedAnnualDays  Int @default(0) // ì‚¬ìš©í•œ ì—°ì°¨ ì¼ìˆ˜

  // ë³´ì•ˆ ì •ë³´
  registeredDevices Json? // ë“±ë¡ëœ ê¸°ê¸° ëª©ë¡

  // í˜•í‰ì„± ëˆ„ì  ì ìˆ˜ (ì „ì›” ì´ì›”)
  fairnessScoreTotalDays       Float @default(0) // ì´ê·¼ë¬´ í˜•í‰ì„±
  fairnessScoreNight           Float @default(0) // ì•¼ê°„ í˜•í‰ì„±
  fairnessScoreWeekend         Float @default(0) // ì£¼ë§ í˜•í‰ì„±
  fairnessScoreHoliday         Float @default(0) // ê³µíœ´ì¼ í˜•í‰ì„±
  fairnessScoreHolidayAdjacent Float @default(0) // íœ´ì¼ì „í›„ í˜•í‰ì„±

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  assignments           StaffAssignment[]
  dailyStaffAssignments DailyStaffAssignment[]
  leaveApplications     LeaveApplication[]
  applicationLinks      ApplicationLink[]
  fairnessScores        FairnessScore[]
  attendanceRecords     AttendanceRecord[]
  unresolvedIssues      UnresolvedIssue[]
  fairnessAdjustments   FairnessAdjustment[]

  @@index([clinicId])
  @@index([pin])
}

model StaffRankSettings {
  id               String    @id @default(cuid())
  rank             StaffRank @unique
  requiredCount    Int // í•„ìˆ˜ ì¸ì› ìˆ˜
  distributionRate Float // ë°°ì¹˜ ë¹„ìœ¨ (0.0 ~ 1.0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// ============================================
// 4. ìŠ¤ì¼€ì¤„ ê´€ë¦¬
// ============================================

enum ScheduleStatus {
  DRAFT // ì‘ì„±ì¤‘
  PENDING // ë°°ì¹˜ ëŒ€ê¸°
  CONFIRMED // í™•ì •
  DEPLOYED // ë°°í¬ë¨
}

model Schedule {
  id           String         @id @default(cuid())
  clinicId     String
  clinic       Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  year         Int
  month        Int
  status       ScheduleStatus @default(DRAFT)
  weekPatterns Json? // ì£¼ì°¨ë³„ íŒ¨í„´ ë§¤í•‘: { "1": "patternId1", "2": "patternId2" }
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  deployedAt   DateTime?

  // ë°°í¬ëœ ë‚ ì§œ ë²”ìœ„ (ë‹¤ìŒ ë‹¬ ì´ˆë°˜ê¹Œì§€ í¬í•¨)
  deployedStartDate DateTime? @db.Date // ë°°í¬ëœ ì‹œì‘ ë‚ ì§œ (ì˜ˆ: 2025-09-28)
  deployedEndDate   DateTime? @db.Date // ë°°í¬ëœ ì¢…ë£Œ ë‚ ì§œ (ì˜ˆ: 2025-11-01)

  // ì „ì›” í¸ì°¨ ì €ì¥ (ì›ì¥ ìŠ¤ì¼€ì¤„ ì„¸íŒ… ì‹œ Staff í…Œì´ë¸”ì—ì„œ ë³µì‚¬)
  previousMonthFairness Json? // { "staffId1": { "total": 0.5, "night": -0.3, "weekend": 0.2, "holiday": -0.1, "holidayAdjacent": 0 }, ... }

  // ê´€ê³„
  doctors          ScheduleDoctor[]
  staffAssignments StaffAssignment[]

  @@unique([clinicId, year, month])
  @@index([clinicId, year, month])
  @@index([status])
  @@index([deployedStartDate, deployedEndDate])
}

model ScheduleDoctor {
  id            String   @id @default(cuid())
  scheduleId    String
  schedule      Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  doctorId      String
  doctor        Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  hasNightShift Boolean  @default(false)

  @@unique([scheduleId, doctorId, date])
  @@index([scheduleId])
  @@index([date])
}

enum ShiftType {
  DAY // ì£¼ê°„
  NIGHT // ì•¼ê°„
  OFF // ì˜¤í”„
}

model StaffAssignment {
  id         String    @id @default(cuid())
  scheduleId String
  schedule   Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  staffId    String
  staff      Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date       DateTime  @db.Date
  shiftType  ShiftType
  createdAt  DateTime  @default(now())

  // ğŸ†• ì‹¤ì œ ì¶œí‡´ê·¼ ì‹œê°„ (ì¶œí‡´ê·¼ ì—°ë™)
  actualCheckInTime  DateTime?
  actualCheckOutTime DateTime?

  // ğŸ†• ìœ ì—° ë°°ì¹˜ ì¶”ì  (í˜•í‰ì„± 1ì  í¸ì°¨ ë°©ì§€ìš©)
  isFlexible       Boolean @default(false) // ìœ ì—° ë°°ì¹˜ ì—¬ë¶€
  originalCategory String? // ì›ë˜ ì¹´í…Œê³ ë¦¬
  assignedCategory String? // ë°°ì¹˜ëœ ì¹´í…Œê³ ë¦¬

  // ğŸ†• ì¶œí‡´ê·¼ ê¸°ë¡ ì—°ê²°
  attendanceRecords AttendanceRecord[]

  @@unique([scheduleId, staffId, date])
  @@index([scheduleId])
  @@index([staffId])
  @@index([date])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([staffId, date], name: "assignment_staff_date")
  @@index([date, shiftType], name: "assignment_date_shift")
}

// ============================================
// 5. ì—°ì°¨/ì˜¤í”„ ì‹ ì²­
// ============================================

enum LinkStatus {
  ACTIVE // í™œì„±
  EXPIRED // ë§Œë£Œ
  CLOSED // ë‹«í˜
}

model ApplicationLink {
  id        String     @id @default(cuid())
  clinicId  String
  clinic    Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  staffId   String? // íŠ¹ì • ì§ì›ìš© ë§í¬ (nullì´ë©´ ì „ì²´ ì§ì›ìš©)
  staff     Staff?     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  token     String     @unique
  year      Int
  month     Int
  expiresAt DateTime
  status    LinkStatus @default(ACTIVE)
  createdAt DateTime   @default(now())

  // ê´€ê³„
  applications LeaveApplication[]

  @@index([clinicId])
  @@index([staffId])
  @@index([token])
  @@index([status])
}

// ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ê¸°ê°„ ì„¤ì •
model LeavePeriod {
  id            String   @id @default(cuid())
  clinicId      String
  clinic        Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  year          Int
  month         Int
  startDate     DateTime @db.Date // ì‹ ì²­ ê°€ëŠ¥ ì‹œì‘ì¼
  endDate       DateTime @db.Date // ì‹ ì²­ ê°€ëŠ¥ ì¢…ë£Œì¼
  maxSlots      Int      @default(0) // ì „ì²´ ìµœëŒ€ ìŠ¬ë¡¯ ìˆ˜ (0ì´ë©´ ë¬´ì œí•œ)
  categorySlots Json? // êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ì„¤ì • {"íŒ€ì¥": 2, "ê³ ë…„ì°¨": 3}
  isActive      Boolean  @default(true) // í™œì„± ìƒíƒœ
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([clinicId, year, month])
  @@index([clinicId])
  @@index([year, month])
  @@index([isActive])
}

enum DayType {
  WEEKDAY // í‰ì¼ (ì›”-ê¸ˆ)
  SATURDAY // í† ìš”ì¼
  SUNDAY // ì¼ìš”ì¼ (ì „ì› íœ´ë¬´)
  HOLIDAY // ê³µíœ´ì¼ (ì¼ìš”ì¼ ì œì™¸)
  HOLIDAY_ADJACENT // ê³µíœ´ì¼ ì „í›„ì¼ (ì¼ìš”ì¼ ì œì™¸)
  HOLIDAY_ADJACENT_SUNDAY // ê³µíœ´ì¼ ì „í›„ ì¼ìš”ì¼ (ê³µíœ´ì¼ë¡œ ì¹´ìš´íŠ¸)
}

// ì£¼ì°¨ ì •ë³´ í…Œì´ë¸” (ì£¼ë³„ ìŠ¬ë¡¯ ê³„ì‚°)
model WeekInfo {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  year       Int
  month      Int
  weekNumber Int // í•´ë‹¹ ì›”ì˜ ì£¼ì°¨ (1, 2, 3, ...)
  weekStart  DateTime @db.Date // ì›”ìš”ì¼
  weekEnd    DateTime @db.Date // í† ìš”ì¼

  // ì£¼ë³„ ìŠ¬ë¡¯ ê³„ì‚° ê²°ê³¼
  totalSlots      Int // ì£¼ë‹¹ ì´ íœ´ë¬´ ê°€ëŠ¥ ìë¦¬ (í‰ì¼6 + í† ìš”ì¼14 ë“±)
  offTarget       Int // ì˜¤í”„ ë°°ì • ëª©í‘œ (ë³´í†µ 20ëª… Ã— 2ì¼ = 40ìë¦¬)
  annualAvailable Int // ì—°ì°¨ ê°€ëŠ¥ ìë¦¬ (total - off)
  hasHoliday      Boolean @default(false) // ì£¼ ì¤‘ íœ´ë¬´ì¼ í¬í•¨ ì—¬ë¶€

  // ë°°ì¹˜ ì§„í–‰ ìƒíƒœ
  status      String?   @default("DRAFT") // DRAFT, ASSIGNING, COMPLETED, APPROVED
  completedAt DateTime?
  approvedAt  DateTime?
  approvedBy  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ê´€ê³„
  dailySlots       DailySlot[]
  unresolvedIssues UnresolvedIssue[]
  backups          WeeklyAssignmentBackup[]
  validationLogs   AssignmentValidationLog[]

  @@unique([clinicId, year, month, weekNumber])
  @@index([clinicId])
  @@index([year, month])
}

// ë‚ ì§œë³„ ìŠ¬ë¡¯ ì •ë³´ í…Œì´ë¸”
model DailySlot {
  id     String   @id @default(cuid())
  weekId String
  week   WeekInfo @relation(fields: [weekId], references: [id], onDelete: Cascade)

  date    DateTime @db.Date
  dayType DayType // WEEKDAY / SATURDAY / SUNDAY

  // ì›ì¥ ìŠ¤ì¼€ì¤„
  doctorSchedule Json // { doctors: [...], night_shift: true }

  // ìŠ¬ë¡¯ ê³„ì‚°
  requiredStaff           Int // í•„ìš” ë°°ì¹˜ ì¸ì› (ë ˆê±°ì‹œ, ì „ì²´ í•©ê³„)
  departmentRequiredStaff Json? // ë¶€ì„œë³„ í•„ìš” ì¸ì› {"ë°ìŠ¤í¬": 2, "ì§„ë£Œì‹¤": 3}
  departmentCategoryStaff Json? // ë¶€ì„œë³„ êµ¬ë¶„ë³„ í•„ìš” ì¸ì› {"ì§„ë£Œì‹¤": {"ì‹¤íŒ€ì¥": {"count": 2, "minRequired": 1}}}
  availableSlots          Int // íœ´ë¬´ ê°€ëŠ¥ ìë¦¬ (20 - required)

  // ì‚¬ìš© í˜„í™©
  offAssigned    Int @default(0) // ë°°ì •ëœ ì˜¤í”„
  annualAssigned Int @default(0) // ë°°ì •ëœ ì—°ì°¨

  // ê´€ê³„
  staffAssignments DailyStaffAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([weekId, date])
  @@index([weekId])
  @@index([date])
}

// DailySlotì— ë°°ì¹˜ëœ ì§ì›
model DailyStaffAssignment {
  id          String    @id @default(cuid())
  dailySlotId String
  dailySlot   DailySlot @relation(fields: [dailySlotId], references: [id], onDelete: Cascade)
  staffId     String
  staff       Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@unique([dailySlotId, staffId])
  @@index([dailySlotId])
  @@index([staffId])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([dailySlotId, staffId], name: "daily_slot_staff")
}

enum ApplicationStatus {
  PENDING // ëŒ€ê¸°ì¤‘ (ê´€ë¦¬ì í™•ì¸ ì „)
  ON_HOLD // ë³´ë¥˜ (êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ë¶€ì¡±, ìŠ¤ì¼€ì¤„ ë°°ì¹˜ í›„ ê²°ì •)
  CONFIRMED // í™•ì •
  REJECTED // ë°˜ë ¤
  CANCELLED // ì·¨ì†Œë¨
}

enum LeaveType {
  ANNUAL // ì—°ì°¨
  OFF // ì˜¤í”„
}

model LeaveApplication {
  id         String            @id @default(cuid())
  clinicId   String
  clinic     Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  linkId     String
  link       ApplicationLink   @relation(fields: [linkId], references: [id], onDelete: Cascade)
  staffId    String
  staff      Staff             @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date       DateTime          @db.Date
  leaveType  LeaveType
  status     ApplicationStatus @default(PENDING)
  holdReason String? // ë³´ë¥˜ ì‚¬ìœ  (ON_HOLD ìƒíƒœì¼ ë•Œ)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // ê´€ê³„
  changeLogs LeaveChangeLog[]

  @@index([clinicId])
  @@index([linkId])
  @@index([staffId])
  @@index([date])
  @@index([status])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([clinicId, date, status], name: "leave_clinic_date_status")
  @@index([staffId, date], name: "leave_staff_date")
  @@index([status, date], name: "leave_status_date")
}

// ============================================
// 6. ìŠ¤ì¼€ì¤„ ë°°í¬ ë° ì¡°íšŒ
// ============================================

model ScheduleViewLink {
  id        String   @id @default(cuid())
  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  token     String   @unique
  year      Int
  month     Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([clinicId])
  @@index([token])
}

model DeploymentSettings {
  id                  String   @id @default(cuid())
  clinicId            String   @unique
  clinic              Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  autoGenerateLink    Boolean  @default(true)
  linkValidityDays    Int      @default(30)
  allowIndividualView Boolean  @default(true)
  allowFullView       Boolean  @default(true)
  allowDoctorView     Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// ============================================
// 7. ê³µíœ´ì¼ ê´€ë¦¬
// ============================================

model Holiday {
  id        String   @id @default(cuid())
  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  name      String
  createdAt DateTime @default(now())

  @@unique([clinicId, date])
  @@index([clinicId])
  @@index([date])
}

// ============================================
// 8. ê·œì¹™ ë° ì„¤ì •
// ============================================

model RuleSettings {
  id       String @id @default(cuid())
  clinicId String @unique
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // ì£¼ ì˜ì—…ì¼ ë° ê·¼ë¬´ì¼ ê¸°ë³¸ê°’
  weekBusinessDays Int @default(6) // ì£¼ ì˜ì—…ì¼ (1~7)
  defaultWorkDays  Int @default(4) // ì‹ ê·œ ì§ì› ê¸°ë³¸ ê·¼ë¬´ì¼ìˆ˜

  // ë°°ì¹˜ êµ¬ë¶„ ì„¤ì • (ì‚¬ìš©ì ì •ì˜)
  staffCategories String[] @default(["ì‹¤íŒ€ì¥", "ê³ ë…„ì°¨", "ì¤‘ë…„ì°¨", "ì €ë…„ì°¨"])

  // ì˜¤í”„ ê´€ë ¨ ê·œì¹™
  maxWeeklyOffs     Int     @default(2) // ì£¼ ìµœëŒ€ ì˜¤í”„ íšŸìˆ˜
  preventSundayOff  Boolean @default(true) // ì¼ìš”ì¼ ì˜¤í”„ ë°©ì§€
  preventHolidayOff Boolean @default(true) // ê³µíœ´ì¼ ì˜¤í”„ ë°©ì§€

  // ê·¼ë¬´ ê´€ë ¨ ê·œì¹™
  maxConsecutiveNights Int @default(3) // ìµœëŒ€ ì—°ì† ì•¼ê°„ ê·¼ë¬´
  minRestAfterNight    Int @default(1) // ì•¼ê°„ í›„ ìµœì†Œ íœ´ì‹ì¼

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FairnessSettings {
  id                            String   @id @default(cuid())
  clinicId                      String   @unique
  clinic                        Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  enableNightShiftFairness      Boolean  @default(true) // ì•¼ê°„ ê·¼ë¬´ í˜•í‰ì„± ì‚¬ìš©
  enableWeekendFairness         Boolean  @default(true) // ì£¼ë§ ê·¼ë¬´ í˜•í‰ì„± ì‚¬ìš©
  enableHolidayFairness         Boolean  @default(true) // ê³µíœ´ì¼ ê·¼ë¬´ í˜•í‰ì„± ì‚¬ìš©
  enableHolidayAdjacentFairness Boolean  @default(false) // ê³µíœ´ì¼ ì „í›„ ê·¼ë¬´ í˜•í‰ì„± ì‚¬ìš©
  fairnessThreshold             Float    @default(0.2) // í˜•í‰ì„± í—ˆìš© ì˜¤ì°¨ (20%)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
}

model SpecialCondition {
  id          String   @id @default(cuid())
  name        String
  description String?
  condition   Json // ì¡°ê±´ (JSON í˜•ì‹)
  action      Json // ì•¡ì…˜ (JSON í˜•ì‹)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// 9. ì•Œë¦¼ ì„¤ì •
// ============================================

model NotificationSettings {
  id                        String   @id @default(cuid())
  clinicId                  String   @unique
  clinic                    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  enableBrowserNotification Boolean  @default(true)
  enableEmailNotification   Boolean  @default(false)
  notifyOnLeaveSubmit       Boolean  @default(true)
  notifyOnLeaveConfirm      Boolean  @default(true)
  notifyOnScheduleDeploy    Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// ============================================
// 10. ë°±ì—… ë° ë³µêµ¬
// ============================================

model BackupConfig {
  id               String    @id @default(cuid())
  clinicId         String
  clinic           Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  enableAutoBackup Boolean   @default(true)
  backupFrequency  String    @default("daily") // daily, weekly, monthly
  retentionDays    Int       @default(30)
  lastBackupAt     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([clinicId])
}

model Backup {
  id         String   @id @default(cuid())
  clinicId   String
  clinic     Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  fileName   String
  fileSize   Int // bytes
  backupType String // auto, manual
  createdAt  DateTime @default(now())

  @@index([clinicId])
  @@index([createdAt])
}

// ============================================
// 11. í˜•í‰ì„± ì¶”ì 
// ============================================

model FairnessScore {
  id                   String   @id @default(cuid())
  staffId              String
  staff                Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  year                 Int
  month                Int
  nightShiftCount      Int      @default(0) // ì•¼ê°„ ê·¼ë¬´ íšŸìˆ˜
  weekendCount         Int      @default(0) // ì£¼ë§(í† ìš”ì¼) ê·¼ë¬´ íšŸìˆ˜
  holidayCount         Int      @default(0) // ê³µíœ´ì¼ ê·¼ë¬´ íšŸìˆ˜
  holidayAdjacentCount Int      @default(0) // ê³µíœ´ì¼ ì „í›„ ê·¼ë¬´ íšŸìˆ˜
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([staffId, year, month])
  @@index([staffId])
  @@index([year, month])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([staffId, year], name: "fairness_staff_year")
  @@index([year, month], name: "fairness_year_month")
}

// ============================================
// 12. ì•Œë¦¼ ë° í™œë™ ë¡œê·¸
// ============================================

enum NotificationType {
  LEAVE_SUBMITTED // ì—°ì°¨ ì‹ ì²­
  LEAVE_CONFIRMED // ì—°ì°¨ í™•ì •
  LEAVE_CANCELLED // ì—°ì°¨ ì·¨ì†Œ
  SCHEDULE_DEPLOYED // ìŠ¤ì¼€ì¤„ ë°°í¬
  SYSTEM_ALERT // ì‹œìŠ¤í…œ ì•Œë¦¼
  USER_REGISTRATION // íšŒì›ê°€ì… ì•Œë¦¼ (ê´€ë¦¬ìì—ê²Œ)
  USER_APPROVED // íšŒì› ìŠ¹ì¸ ì•Œë¦¼ (ì‚¬ìš©ìì—ê²Œ)
  USER_REJECTED // íšŒì› ê±°ì ˆ ì•Œë¦¼ (ì‚¬ìš©ìì—ê²Œ)
  USER_SUSPENDED // íšŒì› ì •ì§€ ì•Œë¦¼ (ì‚¬ìš©ìì—ê²Œ)
}

model Notification {
  id        String           @id @default(cuid())
  clinicId  String
  clinic    Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([clinicId])
  @@index([userId])
  @@index([createdAt])
}

enum ActivityType {
  SCHEDULE_CREATED
  SCHEDULE_UPDATED
  SCHEDULE_DEPLOYED
  LEAVE_SUBMITTED
  LEAVE_CONFIRMED
  LEAVE_CANCELLED
  SETTINGS_UPDATED
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTERED // íšŒì›ê°€ì…
  USER_APPROVED // íšŒì› ìŠ¹ì¸
  USER_REJECTED // íšŒì› ê±°ì ˆ
  USER_SUSPENDED // íšŒì› ì •ì§€
  USER_RESTORED // íšŒì› ë³µêµ¬
  USER_ROLE_CHANGED // ì—­í•  ë³€ê²½

  // ğŸ†• ì¶”ê°€ ì´ë²¤íŠ¸ íƒ€ì…
  WEEKLY_ASSIGNMENT_STARTED // ì£¼ê°„ ë°°ì¹˜ ì‹œì‘
  WEEKLY_ASSIGNMENT_COMPLETED // ì£¼ê°„ ë°°ì¹˜ ì™„ë£Œ
  WEEKLY_ASSIGNMENT_FAILED // ì£¼ê°„ ë°°ì¹˜ ì‹¤íŒ¨
  REASSIGNMENT_TRIGGERED // ì¬ë°°ì¹˜ íŠ¸ë¦¬ê±°
  REASSIGNMENT_COMPLETED // ì¬ë°°ì¹˜ ì™„ë£Œ
  ONHOLD_AUTO_APPROVED // ON_HOLD ìë™ ìŠ¹ì¸
  LEAVE_REJECTED // ì—°ì°¨ ê±°ì ˆ
  ATTENDANCE_CHECKED // ì¶œí‡´ê·¼ ì²´í¬
  ATTENDANCE_SUSPICIOUS // ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì¶œí‡´ê·¼
  BACKUP_CREATED // ë°±ì—… ìƒì„±
  BACKUP_RESTORED // ë°±ì—… ë³µì›
  STAFF_CREATED // ì§ì› ìƒì„±
  STAFF_UPDATED // ì§ì› ìˆ˜ì •
  STAFF_DELETED // ì§ì› ì‚­ì œ
  DEPARTMENT_CREATED // ë¶€ì„œ ìƒì„±
  DEPARTMENT_UPDATED // ë¶€ì„œ ìˆ˜ì •
  DEPARTMENT_DELETED // ë¶€ì„œ ì‚­ì œ
}

model ActivityLog {
  id           String       @id @default(cuid())
  clinicId     String
  clinic       Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  activityType ActivityType
  description  String
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime     @default(now())

  @@index([clinicId])
  @@index([userId])
  @@index([createdAt])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([clinicId, createdAt], name: "activity_clinic_time")
  @@index([userId, createdAt], name: "activity_user_time")
  @@index([activityType, createdAt], name: "activity_type_time")
}

// ============================================
// 13. ë°°ì¹˜ ì‹œìŠ¤í…œ ê´€ë¦¬
// ============================================

// ë¯¸í•´ê²° ì´ìŠˆ (ì£¼ê°„ ë°°ì¹˜ì—ì„œ í•´ê²° ëª»í•œ ë¬¸ì œ)
model UnresolvedIssue {
  id         String   @id @default(cuid())
  weekInfoId String
  weekInfo   WeekInfo @relation(fields: [weekInfoId], references: [id], onDelete: Cascade)

  issueType  String // 'SHORTAGE', 'EXCESS', 'UNFAIR', 'MISSING_CATEGORY'
  severity   String // 'CRITICAL', 'WARNING', 'INFO'
  staffId    String?
  staff      Staff?    @relation(fields: [staffId], references: [id], onDelete: SetNull)
  category   String?
  date       DateTime? @db.Date
  message    String    @db.Text
  suggestion String?   @db.Text

  status     String // 'PENDING_NEXT_WEEK', 'RESOLVED', 'CARRY_TO_NEXT_MONTH'
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([weekInfoId])
  @@index([staffId])
  @@index([status])
}

// í˜•í‰ì„± ë³´ìƒ ê³„íš (ìµì›” ë°˜ì˜ìš©)
model FairnessAdjustment {
  id      String @id @default(cuid())
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  year           Int
  month          Int
  adjustmentType String // 'INCREASE' (ë” ë°°ì¹˜), 'REDUCE' (ëœ ë°°ì¹˜)
  adjustmentDays Int // ì¡°ì • ì¼ìˆ˜
  reason         String @db.Text

  status    String // 'PENDING', 'APPLIED', 'CANCELLED'
  appliedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([staffId])
  @@index([year, month])
  @@index([status])
}

// ì£¼ê°„ ë°°ì¹˜ ë°±ì—… (ë³µêµ¬ ë° ë³€ê²½ ì¶”ì ìš©)
model WeeklyAssignmentBackup {
  id         String   @id @default(cuid())
  weekInfoId String
  weekInfo   WeekInfo @relation(fields: [weekInfoId], references: [id], onDelete: Cascade)

  // ë°±ì—… ë©”íƒ€ë°ì´í„°
  backupType  String // 'AUTO_BEFORE_ASSIGN', 'AUTO_AFTER_ASSIGN', 'MANUAL', 'BEFORE_LEAVE_CHANGE'
  description String?  @db.Text
  createdBy   String? // User ID
  createdAt   DateTime @default(now())

  // ë°±ì—…ëœ ë°°ì¹˜ ë°ì´í„° (JSON)
  assignments Json // { "2025-10-28": [{ staffId, category }, ...], ... }

  // ë°±ì—…ëœ í˜•í‰ì„± ì ìˆ˜ ìŠ¤ëƒ…ìƒ·
  fairnessScores Json? // [{ staffId, nightShift, weekend, holiday, ... }, ...]

  // ë³µêµ¬ ê´€ë ¨
  restoredAt DateTime?
  restoredBy String? // User ID

  @@index([weekInfoId])
  @@index([backupType])
  @@index([createdAt])
}

// ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì´ë ¥ (ì¬ë°°ì¹˜ íŠ¸ë¦¬ê±°ìš©)
model LeaveChangeLog {
  id                 String           @id @default(cuid())
  leaveApplicationId String
  leaveApplication   LeaveApplication @relation(fields: [leaveApplicationId], references: [id], onDelete: Cascade)

  // ë³€ê²½ íƒ€ì…
  changeType String // 'STATUS_CHANGE', 'DATE_CHANGE', 'DELETION'

  // ë³€ê²½ ì „/í›„ ê°’
  oldStatus String?
  newStatus String?
  oldDate   DateTime? @db.Date
  newDate   DateTime? @db.Date

  // ì˜í–¥ë°›ëŠ” ì£¼ì°¨
  affectedWeekIds String[] // [weekInfoId1, weekInfoId2, ...]

  // ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€
  requiresReassignment Boolean   @default(false)
  reassignedAt         DateTime?
  reassignedBy         String? // User ID

  createdAt DateTime @default(now())
  createdBy String? // User ID

  @@index([leaveApplicationId])
  @@index([requiresReassignment])
  @@index([createdAt])
}

// ë°°ì¹˜ ê²€ì¦ ê²½ê³  ë¡œê·¸
model AssignmentValidationLog {
  id         String   @id @default(cuid())
  weekInfoId String
  weekInfo   WeekInfo @relation(fields: [weekInfoId], references: [id], onDelete: Cascade)

  // ê²€ì¦ íƒ€ì…
  validationType String // 'PRE_ASSIGN', 'POST_ASSIGN', 'PERIODIC_CHECK'

  // ê²½ê³  ë ˆë²¨
  severity String // 'INFO', 'WARNING', 'ERROR', 'CRITICAL'

  // ê²€ì¦ ê²°ê³¼
  issueCount    Int
  criticalCount Int
  warningCount  Int
  infoCount     Int

  // ìƒì„¸ ì´ìŠˆ ëª©ë¡ (JSON)
  issues Json // [{ type, severity, message, staffId, date, ... }, ...]

  // ìë™ ìˆ˜ì • ì‹œë„ ì—¬ë¶€
  autoFixAttempted Boolean  @default(false)
  autoFixSuccess   Boolean?
  autoFixLog       String?  @db.Text

  createdAt DateTime @default(now())

  @@index([weekInfoId])
  @@index([validationType])
  @@index([severity])
  @@index([createdAt])
}

// ============================================
// 14. QR ì¶œí‡´ê·¼ ì‹œìŠ¤í…œ
// ============================================

// QR í† í°
model QRToken {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  token     String    @unique // UUID v4
  expiresAt DateTime // ìƒì„± ì‹œê°„ + 5ë¶„
  used      Boolean   @default(false) // ì‚¬ìš© ì—¬ë¶€
  usedAt    DateTime? // ì‚¬ìš© ì‹œê°„
  usedBy    String? // ì‚¬ìš©í•œ ì§ì› ID (Staff)

  createdAt DateTime @default(now())

  @@index([clinicId])
  @@index([token])
  @@index([expiresAt])
  @@index([used])
}

// ì¶œí‡´ê·¼ ê¸°ë¡
enum CheckType {
  IN // ì¶œê·¼
  OUT // í‡´ê·¼
}

model AttendanceRecord {
  id       String @id @default(cuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  checkType CheckType // IN (ì¶œê·¼) / OUT (í‡´ê·¼)
  checkTime DateTime // ì²´í¬ ì‹œê°„
  date      DateTime  @db.Date // ì²´í¬ ë‚ ì§œ (ê²€ìƒ‰ìš©)

  // QR í† í° ì •ë³´
  tokenUsed String? // ì‚¬ìš©í•œ QR í† í°

  // ë””ë°”ì´ìŠ¤ ì •ë³´
  deviceFingerprint String // ë””ë°”ì´ìŠ¤ ê³ ìœ  ID
  userAgent         String?
  ipAddress         String?
  wifiSSID          String? // WiFi ì´ë¦„ (ì„ íƒ)

  // ìœ„ì¹˜ ì •ë³´ (ì„ íƒ)
  gpsLatitude  Float?
  gpsLongitude Float?

  // ì‚¬ì§„ (ì„ íƒ)
  photoPath String?

  // ì´ìƒ íŒ¨í„´
  isSuspicious     Boolean @default(false)
  suspiciousReason String? // ì˜ì‹¬ ì‚¬ìœ 

  // ğŸ†• ìŠ¤ì¼€ì¤„ ì—°ë™
  staffAssignmentId String? // StaffAssignmentì™€ ì—°ê²°
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)
  isScheduled       Boolean @default(true) // ìŠ¤ì¼€ì¤„ì— ì˜ˆì •ëœ ê·¼ë¬´ì¸ì§€ ì—¬ë¶€
  scheduleNote      String? // ìŠ¤ì¼€ì¤„ ê´€ë ¨ ë©”ëª¨ (ì˜ˆ: ìŠ¤ì¼€ì¤„ì— ì—†ëŠ” ê·¼ë¬´)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([staffId])
  @@index([date])
  @@index([checkType])
  @@index([staffAssignmentId])
  @@index([isSuspicious])
  // ğŸš€ ë³µí•© ì¸ë±ìŠ¤ (ì¿¼ë¦¬ ìµœì í™”)
  @@index([clinicId, date], name: "attendance_clinic_date")
  @@index([staffId, date, checkType], name: "attendance_staff_date_type")
  @@index([date, isSuspicious], name: "attendance_date_suspicious")
}

// ============================================
// 15. ì¹´ì¹´ì˜¤í†¡ ì„¤ì •
// ============================================

model KakaoSettings {
  id String @id @default(cuid())
  clinicId String @unique
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  // JavaScript í‚¤
  javascriptKey String? // ì¹´ì¹´ì˜¤ JavaScript í‚¤

  // ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ì•ˆë‚´ ë©”ì‹œì§€ í…œí”Œë¦¿
  leaveApplicationTemplate String? @db.Text // ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ë§í¬ ê³µìœ  ì‹œ ë©”ì‹œì§€

  // ê¸°ë³¸ í…œí”Œë¦¿ ì‚¬ìš© ì—¬ë¶€
  useDefaultTemplate Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
}
