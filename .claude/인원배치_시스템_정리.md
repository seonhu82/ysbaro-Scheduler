# ì—°ì„¸ë°”ë¡œì¹˜ê³¼ ìŠ¤ì¼€ì¤„ëŸ¬ - ì¸ì› ë°°ì¹˜ ì‹œìŠ¤í…œ ìƒì„¸ ë¶„ì„

**ì‘ì„±ì¼**: 2025-10-25
**ìƒíƒœ**: âœ… ì™„ë£Œ ë° ê°œì„  ì œì•ˆ í¬í•¨

---

## ğŸ“Š ì „ì²´ êµ¬ì¡° ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ì¸ì› ë°°ì¹˜ ì‹œìŠ¤í…œ (Auto-Assign)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ ë‹¨ì¼ ìŠ¬ë¡¯ â”‚                     â”‚ ì£¼ê°„ ë°°ì¹˜ â”‚
   â”‚  ë°°ì¹˜    â”‚                     â”‚          â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  â”‚
        â–¼  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        í•µì‹¬ ë¡œì§ íë¦„                    â”‚
   â”‚  1. ë‚ ì§œ ìœ í˜• ë¶„ë¥˜ (ê³µíœ´ì¼/ì£¼ë§/í‰ì¼)     â”‚
   â”‚  2. êµ¬ë¶„ë³„ í•„ìš” ì¸ì› ê³„ì‚° (ë¹„ìœ¨ ê¸°ë°˜)     â”‚
   â”‚  3. í˜•í‰ì„± ì ìˆ˜ ê¸°ë°˜ ì •ë ¬                â”‚
   â”‚  4. ìš°ì„  ë°°ì¹˜ (í•´ë‹¹ êµ¬ë¶„ ì§ì›)           â”‚
   â”‚  5. Flexible Staff ë³´ì¶© ë°°ì¹˜             â”‚
   â”‚  6. DB ì €ì¥ ë° í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ í•µì‹¬ íŒŒì¼ 3ê°œ

### 1. `auto-assign.ts` - ìë™ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜
**ìœ„ì¹˜**: `src/lib/algorithms/auto-assign.ts`

**ì£¼ìš” í•¨ìˆ˜**:
- `autoAssignSingleSlot(slotId)` - ë‹¨ì¼ ë‚ ì§œ ë°°ì¹˜
- `autoAssignWeeklySchedule({ clinicId, weekInfoId })` - ì£¼ê°„ ë°°ì¹˜

### 2. `category-slot-service.ts` - êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ê´€ë¦¬
**ìœ„ì¹˜**: `src/lib/services/category-slot-service.ts`

**ì£¼ìš” í•¨ìˆ˜**:
- `calculateCategoryRequirements()` - êµ¬ë¶„ë³„ í•„ìš” ì¸ì› ê³„ì‚°
- `calculateCategorySlots()` - êµ¬ë¶„ë³„ ìŠ¬ë¡¯ í˜„í™© ê³„ì‚°
- `getFlexibleStaff()` - ìœ ì—° ë°°ì¹˜ ê°€ëŠ¥ ì§ì› ì¡°íšŒ
- `checkCategoryAvailability()` - ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

### 3. `day-type-classifier.ts` - ë‚ ì§œ ìœ í˜• ë¶„ë¥˜
**ìœ„ì¹˜**: `src/lib/utils/day-type-classifier.ts`

**ì£¼ìš” í•¨ìˆ˜**:
- `classifyDayType()` - ë‚ ì§œë¥¼ ì—¬ëŸ¬ ìœ í˜•ìœ¼ë¡œ ë¶„ë¥˜
- `getPrimaryDayType()` - ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë†’ì€ ìœ í˜• ë°˜í™˜

---

## ğŸ¯ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ ìƒì„¸ íë¦„

### Phase 1: ì¤€ë¹„ ë‹¨ê³„

```typescript
// 1. DailySlot ì •ë³´ ë¡œë“œ
const slot = await prisma.dailySlot.findUnique({
  where: { id: slotId },
  include: { week: { include: { clinic: true } } }
})

// 2. êµ¬ë¶„ë³„ ë¹„ìœ¨ ì„¤ì • ë¡œë“œ
const ratioSettings = await prisma.categoryRatioSettings.findUnique({
  where: { clinicId }
})
// ì˜ˆ: { "íŒ€ì¥/ì‹¤ì¥": 15, "ê³ ë…„ì°¨": 30, "ì¤‘ê°„ë…„ì°¨": 35, "ì €ë…„ì°¨": 20 }

// 3. êµ¬ë¶„ë³„ í•„ìš” ì¸ì› ê³„ì‚°
const categoryRequirements = calculateCategoryRequirements(requiredStaff, ratios)
// requiredStaff=14ëª… â†’ { "íŒ€ì¥": 2ëª…, "ê³ ë…„ì°¨": 4ëª…, "ì¤‘ë…„ì°¨": 5ëª…, "ì €ë…„ì°¨": 3ëª… }
```

### Phase 2: ë‚ ì§œ ìœ í˜• ë¶„ë¥˜ (í˜•í‰ì„± ê³„ì‚°ìš©)

```typescript
// ë‚ ì§œ ìœ í˜• ë¶„ë¥˜
const dayTypes = await classifyDayType(clinicId, date)
// ì˜ˆì‹œ ê²°ê³¼:
// - 5ì›” 6ì¼ (ì›”ìš”ì¼, ì–´ë¦°ì´ë‚  ë‹¤ìŒë‚ ) â†’ ['WEEKDAY', 'HOLIDAY_ADJACENT']
// - 12ì›” 25ì¼ (í† ìš”ì¼, í¬ë¦¬ìŠ¤ë§ˆìŠ¤) â†’ ['SATURDAY', 'HOLIDAY']
// - 10ì›” 3ì¼ (í† ìš”ì¼, ê°œì²œì ˆ ì „ë‚ ) â†’ ['SATURDAY', 'HOLIDAY_ADJACENT']
```

### Phase 3: êµ¬ë¶„ë³„ ë°°ì¹˜ ë£¨í”„

```typescript
for (const [category, required] of Object.entries(categoryRequirements)) {
  // 3.1 í•´ë‹¹ êµ¬ë¶„ ì§ì› ì¡°íšŒ
  const availableStaff = await prisma.staff.findMany({
    where: {
      categoryName: category,
      isActive: true,
      leaveApplications: {
        none: {
          date,
          status: { in: ['PENDING', 'CONFIRMED'] }
        }
      }
    },
    include: { fairnessScores: true }
  })

  // 3.2 í˜•í‰ì„± ì ìˆ˜ ê³„ì‚° ë° ì •ë ¬
  const staffWithScores = availableStaff.map(staff => {
    const fairnessScore = staff.fairnessScores[0]
    let score = 0

    // ë‚ ì§œ ìœ í˜•ì— ë”°ë¼ í•´ë‹¹ í˜•í‰ì„± ì ìˆ˜ ì„ íƒ
    if (dayTypes.includes('HOLIDAY')) {
      score = fairnessScore?.holidayCount || 0  // ê³µíœ´ì¼ ê·¼ë¬´ íšŸìˆ˜
    } else if (dayTypes.includes('HOLIDAY_ADJACENT')) {
      score = fairnessScore?.holidayAdjacentCount || 0
    } else if (dayTypes.includes('SATURDAY') || dayTypes.includes('SUNDAY')) {
      score = fairnessScore?.weekendCount || 0  // ì£¼ë§ ê·¼ë¬´ íšŸìˆ˜
    } else if (hasNightShift) {
      score = fairnessScore?.nightShiftCount || 0  // ì•¼ê°„ ê·¼ë¬´ íšŸìˆ˜
    }

    return { staff, score }
  })

  // ì ìˆ˜ê°€ ë‚®ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (í˜•í‰ì„± ìœ ì§€: ì ê²Œ ê·¼ë¬´í•œ ì‚¬ëŒ ìš°ì„ )
  staffWithScores.sort((a, b) => a.score - b.score)

  // 3.3 í•„ìš” ì¸ì›ë§Œí¼ ë°°ì¹˜
  const assigned = staffWithScores.slice(0, required)
  assignments.push(...assigned)
}
```

### Phase 4: Flexible Staff ë³´ì¶© ë°°ì¹˜

```typescript
// ë¶€ì¡±í•œ ê²½ìš° Flexible Staff í™œìš©
if (assigned.length < required) {
  const shortfall = required - assigned.length

  // Flexible Staff ì¡°íšŒ
  const flexibleStaff = await getFlexibleStaff(
    clinicId,
    category,
    alreadyAssignedIds
  )
  // flexibleForCategoriesì— í•´ë‹¹ êµ¬ë¶„ì´ í¬í•¨ëœ ì§ì›ë§Œ

  // Flexible Staffë„ í˜•í‰ì„± ê¸°ë°˜ ì •ë ¬
  flexWithScores.sort((a, b) => {
    if (a.score === b.score) {
      // ì ìˆ˜ê°€ ê°™ìœ¼ë©´ ìš°ì„ ìˆœìœ„ë¡œ ì •ë ¬
      return (b.staff.flexibilityPriority || 0) - (a.staff.flexibilityPriority || 0)
    }
    return a.score - b.score
  })

  const flexAssigned = flexWithScores.slice(0, shortfall)
  assignments.push(...flexAssigned)
}
```

### Phase 5: DB ì €ì¥

```typescript
// DailyStaffAssignment í…Œì´ë¸”ì— ì €ì¥
for (const assignment of assignments) {
  await prisma.dailyStaffAssignment.create({
    data: {
      dailySlotId: assignment.slotId,
      staffId: assignment.staffId
    }
  })
}

return {
  success: errors.length === 0,
  assignments,
  errors
}
```

---

## ğŸ¨ í˜•í‰ì„± ì‹œìŠ¤í…œ ì‘ë™ ì›ë¦¬

### FairnessScore ëª¨ë¸

```prisma
model FairnessScore {
  id        String @id @default(cuid())
  staffId   String
  staff     Staff  @relation(...)

  year      Int
  month     Int

  // ê° ìœ í˜•ë³„ ëˆ„ì  ê·¼ë¬´ íšŸìˆ˜
  nightShiftCount         Int @default(0)  // ì•¼ê°„ ê·¼ë¬´
  weekendCount            Int @default(0)  // ì£¼ë§ ê·¼ë¬´
  holidayCount            Int @default(0)  // ê³µíœ´ì¼ ê·¼ë¬´
  holidayAdjacentCount    Int @default(0)  // ê³µíœ´ì¼ ì „í›„ì¼ ê·¼ë¬´

  totalWorkDays           Int @default(0)  // ì´ ê·¼ë¬´ì¼
  offDays                 Int @default(0)  // ì˜¤í”„ì¼
  annualDays              Int @default(0)  // ì—°ì°¨ì¼
}
```

### í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œì 

1. **ë°°ì¹˜ ì™„ë£Œ í›„** - ìë™ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ì´ ì™„ë£Œë˜ë©´ ê° ì§ì›ì˜ í•´ë‹¹ ì›” FairnessScore ì—…ë°ì´íŠ¸
2. **ì—°ì°¨/ì˜¤í”„ ìŠ¹ì¸ ì‹œ** - LeaveApplication ìƒíƒœê°€ CONFIRMEDë¡œ ë³€ê²½ë˜ë©´ offDays/annualDays ì¦ê°€
3. **ë°°ì¹˜ ì·¨ì†Œ ì‹œ** - DailyStaffAssignment ì‚­ì œ ì‹œ í•´ë‹¹ ì ìˆ˜ ê°ì†Œ

### í˜•í‰ì„± ê³„ì‚° ì˜ˆì‹œ

```typescript
// 10ì›” ì´ˆ ìƒí™©
ê¹€ì§ì›: { holidayCount: 0, weekendCount: 1, nightShiftCount: 2 }
ì´ì§ì›: { holidayCount: 1, weekendCount: 2, nightShiftCount: 1 }
ë°•ì§ì›: { holidayCount: 0, weekendCount: 0, nightShiftCount: 3 }

// 10ì›” 3ì¼ (í† ìš”ì¼, ê°œì²œì ˆ ì „ë‚ ) ë°°ì¹˜ ì‹œ
dayTypes = ['SATURDAY', 'HOLIDAY_ADJACENT']

// SATURDAY ìš°ì„  â†’ weekendCount ì‚¬ìš©
// ì •ë ¬: ë°•ì§ì›(0) < ê¹€ì§ì›(1) < ì´ì§ì›(2)
// â†’ ë°•ì§ì› ìš°ì„  ë°°ì¹˜

// ë°°ì¹˜ í›„ ì—…ë°ì´íŠ¸
ë°•ì§ì›: { holidayCount: 0, weekendCount: 1, nightShiftCount: 3 }
```

---

## ğŸ”§ êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ê´€ë¦¬ ì‹œìŠ¤í…œ

### êµ¬ë¶„ë³„ ë¹„ìœ¨ ì„¤ì •

```typescript
// CategoryRatioSettings
{
  clinicId: "abc123",
  ratios: {
    "íŒ€ì¥/ì‹¤ì¥": 15,   // 15%
    "ê³ ë…„ì°¨": 30,      // 30%
    "ì¤‘ê°„ë…„ì°¨": 35,    // 35%
    "ì €ë…„ì°¨": 20       // 20%
  }
}

// ì´ í•„ìš” ì¸ì› 14ëª…ì¸ ê²½ìš°
calculateCategoryRequirements(14, ratios)
// â†’ { "íŒ€ì¥": 2ëª…, "ê³ ë…„ì°¨": 4ëª…, "ì¤‘ë…„ì°¨": 5ëª…, "ì €ë…„ì°¨": 3ëª… }
```

### ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ì‹œ ìŠ¬ë¡¯ í™•ì¸

```typescript
// ì§ì›ì´ ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ì‹œ
const result = await checkCategoryAvailability(
  clinicId,
  date,
  totalRequired,
  staffCategoryName
)

// ê²°ê³¼:
if (result.shouldHold) {
  // êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ë¶€ì¡± â†’ ON_HOLD ìƒíƒœë¡œ ì €ì¥
  status = 'ON_HOLD'
  holdReason = 'êµ¬ë¶„ë³„ ìŠ¬ë¡¯ ë¶€ì¡±, ìŠ¤ì¼€ì¤„ ë°°ì¹˜ í›„ ê²°ì •ë©ë‹ˆë‹¤'
} else if (result.canApply) {
  // ìŠ¬ë¡¯ ì—¬ìœ  ìˆìŒ â†’ CONFIRMED ìƒíƒœë¡œ ì¦‰ì‹œ ìŠ¹ì¸
  status = 'CONFIRMED'
}
```

### Flexible Staff ì‹œìŠ¤í…œ

```typescript
// Staff ëª¨ë¸
{
  id: "staff001",
  name: "ê¹€ìœ ì—°",
  categoryName: "ê³ ë…„ì°¨",
  flexibleForCategories: ["íŒ€ì¥/ì‹¤ì¥", "ì¤‘ê°„ë…„ì°¨"],  // ì´ êµ¬ë¶„ë“¤ë¡œë„ ë°°ì¹˜ ê°€ëŠ¥
  flexibilityPriority: 8  // ìš°ì„ ìˆœìœ„ (ë†’ì„ìˆ˜ë¡ ìš°ì„ )
}

// "íŒ€ì¥/ì‹¤ì¥" êµ¬ë¶„ì´ ë¶€ì¡±í•  ë•Œ
const flexStaff = await getFlexibleStaff(clinicId, "íŒ€ì¥/ì‹¤ì¥", excludeIds)
// â†’ "ê³ ë…„ì°¨"ì¸ ê¹€ìœ ì—°ì´ flexibleForCategoriesì— "íŒ€ì¥/ì‹¤ì¥" í¬í•¨
// â†’ ê¹€ìœ ì—°ì„ "íŒ€ì¥/ì‹¤ì¥"ìœ¼ë¡œ ë°°ì¹˜ ê°€ëŠ¥
```

---

## âš ï¸ ë°œê²¬ëœ ë¬¸ì œì  ë° ê°œì„  ì œì•ˆ

### ğŸ”´ ë¬¸ì œ 1: í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ëˆ„ë½

**í˜„ì¬ ìƒíƒœ**:
```typescript
// auto-assign.ts
for (const assignment of assignments) {
  await prisma.dailyStaffAssignment.create({
    data: { dailySlotId: assignment.slotId, staffId: assignment.staffId }
  })
}
// âŒ í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ì½”ë“œê°€ ì—†ìŒ!
```

**ê°œì„ ì•ˆ**:
```typescript
// ë°°ì¹˜ ì™„ë£Œ í›„ í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ì¶”ê°€
for (const assignment of assignments) {
  await prisma.dailyStaffAssignment.create({
    data: { dailySlotId: assignment.slotId, staffId: assignment.staffId }
  })
}

// âœ… í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
await updateFairnessScoresAfterAssignment(
  assignments,
  date,
  dayTypes,
  hasNightShift
)
```

### ğŸŸ¡ ë¬¸ì œ 2: ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€ ë¡œì§ ë¶€ì¬

**í˜„ì¬ ìƒíƒœ**:
```typescript
// ì´ë¯¸ ë°°ì¹˜ëœ ì§ì›ë„ ë‹¤ì‹œ ì¡°íšŒë  ìˆ˜ ìˆìŒ
const availableStaff = await prisma.staff.findMany({
  where: {
    categoryName: category,
    isActive: true,
    leaveApplications: { none: { ... } }
  }
})
// âŒ ê°™ì€ ë‚ ì§œì— ì´ë¯¸ ë°°ì¹˜ëœ ì§ì› ì œì™¸ ì•ˆ ë¨
```

**ê°œì„ ì•ˆ**:
```typescript
// âœ… ì´ë¯¸ ë°°ì¹˜ëœ ì§ì› ì œì™¸
const alreadyAssignedStaffIds = await prisma.dailyStaffAssignment.findMany({
  where: {
    dailySlot: { date },
    dailySlot: { week: { clinicId } }
  },
  select: { staffId: true }
}).then(assignments => assignments.map(a => a.staffId))

const availableStaff = await prisma.staff.findMany({
  where: {
    categoryName: category,
    isActive: true,
    id: { notIn: alreadyAssignedStaffIds },  // âœ… ì¶”ê°€
    leaveApplications: { none: { ... } }
  }
})
```

### ğŸŸ¡ ë¬¸ì œ 3: íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¶€ì¬

**í˜„ì¬ ìƒíƒœ**:
```typescript
// auto-assign.ts
for (const assignment of assignments) {
  await prisma.dailyStaffAssignment.create({ ... })  // ê°œë³„ ì¿¼ë¦¬
}
// âŒ ì¤‘ê°„ì— ì‹¤íŒ¨í•˜ë©´ ì¼ë¶€ë§Œ ì €ì¥ë¨ (ë°ì´í„° ë¶ˆì¼ì¹˜)
```

**ê°œì„ ì•ˆ**:
```typescript
// âœ… íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì „ì²´ ë˜ëŠ” ì „ë¬´ ë³´ì¥
await prisma.$transaction(async (tx) => {
  // ëª¨ë“  ë°°ì¹˜ ì €ì¥
  for (const assignment of assignments) {
    await tx.dailyStaffAssignment.create({ ... })
  }

  // í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
  await updateFairnessScores(tx, assignments, date, dayTypes)
})
```

### ğŸŸ¢ ë¬¸ì œ 4: ì—ëŸ¬ ì²˜ë¦¬ ê°œì„  í•„ìš”

**í˜„ì¬ ìƒíƒœ**:
```typescript
if (assigned.length < required) {
  errors.push(`${category}: ${shortfall}ëª… ë¶€ì¡±`)
}
// âŒ ì—ëŸ¬ë§Œ ê¸°ë¡í•˜ê³  ê³„ì† ì§„í–‰ â†’ ë¶€ë¶„ì ìœ¼ë¡œ ë¶ˆì™„ì „í•œ ë°°ì¹˜ ìƒì„±
```

**ê°œì„ ì•ˆ**:
```typescript
// âœ… ì˜µì…˜ ì¶”ê°€: strict ëª¨ë“œ
if (assigned.length < required && options.strict) {
  throw new Error(`${category}: ${shortfall}ëª… ë¶€ì¡± - ë°°ì¹˜ ì¤‘ë‹¨`)
}
```

---

## âœ… ê°œì„  ì½”ë“œ ì œì•ˆ

### ê°œì„ ëœ `autoAssignSingleSlot` í•¨ìˆ˜

```typescript
export async function autoAssignSingleSlot(
  slotId: string,
  options?: {
    strict?: boolean  // ì—„ê²© ëª¨ë“œ: ì¸ì› ë¶€ì¡± ì‹œ ì „ì²´ ì‹¤íŒ¨
    updateFairness?: boolean  // í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ì—¬ë¶€
  }
) {
  const { strict = false, updateFairness = true } = options || {}

  return await prisma.$transaction(async (tx) => {
    const assignments: any[] = []
    const errors: string[] = []

    // 1. DailySlot ì¡°íšŒ
    const slot = await tx.dailySlot.findUnique({ ... })

    // 2-3. ì„¤ì • ë° ê³„ì‚°
    const ratioSettings = await tx.categoryRatioSettings.findUnique({ ... })
    const categoryRequirements = calculateCategoryRequirements(...)
    const dayTypes = await classifyDayType(...)

    // 4. ì´ë¯¸ ë°°ì¹˜ëœ ì§ì› ì¡°íšŒ
    const alreadyAssignedIds = await tx.dailyStaffAssignment
      .findMany({
        where: {
          dailySlot: {
            date: slot.date,
            week: { clinicId: slot.week.clinicId }
          }
        },
        select: { staffId: true }
      })
      .then(arr => arr.map(a => a.staffId))

    // 5. êµ¬ë¶„ë³„ ë°°ì¹˜
    for (const [category, required] of Object.entries(categoryRequirements)) {
      const availableStaff = await tx.staff.findMany({
        where: {
          categoryName: category,
          isActive: true,
          id: { notIn: alreadyAssignedIds },  // âœ… ì¤‘ë³µ ë°©ì§€
          leaveApplications: { none: { ... } }
        },
        include: { fairnessScores: true }
      })

      // í˜•í‰ì„± ê¸°ë°˜ ì •ë ¬ ë° ë°°ì¹˜
      const staffWithScores = ...
      staffWithScores.sort((a, b) => a.score - b.score)
      const assigned = staffWithScores.slice(0, required)

      // Flexible Staff ë³´ì¶©
      if (assigned.length < required) {
        const shortfall = required - assigned.length
        const flexibleStaff = await getFlexibleStaff(...)
        // ... flexible ë°°ì¹˜

        if (assigned.length + flexAssigned.length < required) {
          const stillShort = required - assigned.length - flexAssigned.length
          errors.push(`${category}: ${stillShort}ëª… ë¶€ì¡±`)

          // âœ… ì—„ê²© ëª¨ë“œì—ì„œëŠ” ì˜ˆì™¸ ë°œìƒ
          if (strict) {
            throw new Error(`ì¸ì› ë¶€ì¡±ìœ¼ë¡œ ë°°ì¹˜ ì‹¤íŒ¨: ${errors.join(', ')}`)
          }
        }
      }

      assignments.push(...assigned, ...flexAssigned)
    }

    // 6. DB ì €ì¥
    for (const assignment of assignments) {
      await tx.dailyStaffAssignment.create({
        data: {
          dailySlotId: assignment.slotId,
          staffId: assignment.staffId
        }
      })
    }

    // 7. âœ… í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
    if (updateFairness) {
      await updateFairnessScoresAfterAssignment(
        tx,
        assignments,
        slot.date,
        dayTypes,
        slot.doctorSchedule?.night_shift || false
      )
    }

    return {
      success: errors.length === 0,
      assignments,
      errors
    }
  })
}
```

### ìƒˆë¡œìš´ í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜

```typescript
async function updateFairnessScoresAfterAssignment(
  tx: any,  // Prisma transaction
  assignments: Array<{ staffId: string; slotId: string }>,
  date: Date,
  dayTypes: DayTypeValue[],
  hasNightShift: boolean
) {
  const year = date.getFullYear()
  const month = date.getMonth() + 1

  for (const assignment of assignments) {
    // í•´ë‹¹ ì§ì›ì˜ í˜•í‰ì„± ì ìˆ˜ ì¡°íšŒ ë˜ëŠ” ìƒì„±
    let fairnessScore = await tx.fairnessScore.findFirst({
      where: {
        staffId: assignment.staffId,
        year,
        month
      }
    })

    if (!fairnessScore) {
      fairnessScore = await tx.fairnessScore.create({
        data: {
          staffId: assignment.staffId,
          year,
          month
        }
      })
    }

    // ë‚ ì§œ ìœ í˜•ì— ë”°ë¼ í•´ë‹¹ ì¹´ìš´í„° ì¦ê°€
    const updates: any = { totalWorkDays: { increment: 1 } }

    if (dayTypes.includes('HOLIDAY')) {
      updates.holidayCount = { increment: 1 }
    } else if (dayTypes.includes('HOLIDAY_ADJACENT') || dayTypes.includes('HOLIDAY_ADJACENT_SUNDAY')) {
      updates.holidayAdjacentCount = { increment: 1 }
    } else if (dayTypes.includes('SATURDAY') || dayTypes.includes('SUNDAY')) {
      updates.weekendCount = { increment: 1 }
    } else if (hasNightShift) {
      updates.nightShiftCount = { increment: 1 }
    }

    await tx.fairnessScore.update({
      where: { id: fairnessScore.id },
      data: updates
    })
  }
}
```

---

## ğŸ“‹ ê°œì„  ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ì¦‰ì‹œ ìˆ˜ì • í•„ìš” (Critical)

- [ ] **í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ êµ¬í˜„**
  - `src/lib/services/fairness-score-service.ts` ìƒì„±
  - `updateFairnessScoresAfterAssignment()` í•¨ìˆ˜ ì¶”ê°€

- [ ] **íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ì¶”ê°€**
  - `autoAssignSingleSlot()` ì „ì²´ë¥¼ `prisma.$transaction()`ìœ¼ë¡œ ê°ì‹¸ê¸°

- [ ] **ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€**
  - ì´ë¯¸ ë°°ì¹˜ëœ ì§ì› ID ëª©ë¡ ì¡°íšŒ í›„ ì œì™¸

### Phase 2: ê°œì„  ê¶Œì¥ (High Priority)

- [ ] **ì—„ê²© ëª¨ë“œ ì˜µì…˜ ì¶”ê°€**
  - `options.strict` íŒŒë¼ë¯¸í„° ì¶”ê°€
  - ì¸ì› ë¶€ì¡± ì‹œ ì˜ˆì™¸ ë°œìƒ ë˜ëŠ” ê³„ì† ì§„í–‰ ì„ íƒ ê°€ëŠ¥

- [ ] **ë°°ì¹˜ ì·¨ì†Œ ê¸°ëŠ¥**
  - ê¸°ì¡´ ë°°ì¹˜ ì‚­ì œ ë° í˜•í‰ì„± ì ìˆ˜ ì°¨ê°

- [ ] **ë°°ì¹˜ ê²€ì¦ í•¨ìˆ˜**
  - ë°°ì¹˜ ì™„ë£Œ í›„ ë¬´ê²°ì„± ê²€ì‚¬
  - ì¤‘ë³µ ë°°ì¹˜, ì˜¤í”„ ì‹ ì²­ì ë°°ì¹˜ ë“± í™•ì¸

### Phase 3: ì¶”ê°€ ê¸°ëŠ¥ (Medium Priority)

- [ ] **ë°°ì¹˜ ì´ë ¥ ë¡œê¹…**
  - ëˆ„ê°€, ì–¸ì œ, ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜í–ˆëŠ”ì§€ ê¸°ë¡

- [ ] **ë°°ì¹˜ ì‹œë®¬ë ˆì´ì…˜**
  - ì‹¤ì œ ì €ì¥ ì „ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°

- [ ] **ìˆ˜ë™ ì¡°ì • ê¸°ëŠ¥**
  - ê´€ë¦¬ìê°€ ìë™ ë°°ì¹˜ ê²°ê³¼ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¡°ì •

---

## ğŸ¯ ê²°ë¡ 

### í˜„ì¬ ìƒíƒœ í‰ê°€

âœ… **ì˜ êµ¬í˜„ëœ ë¶€ë¶„**:
1. êµ¬ë¶„ë³„ ë¹„ìœ¨ ê¸°ë°˜ ë°°ì¹˜ ì‹œìŠ¤í…œ
2. í˜•í‰ì„± ê¸°ë°˜ ì •ë ¬ ì•Œê³ ë¦¬ì¦˜
3. Flexible Staff ë³´ì¶© ë©”ì»¤ë‹ˆì¦˜
4. ë‚ ì§œ ìœ í˜• ë¶„ë¥˜ ì‹œìŠ¤í…œ

âš ï¸ **ê°œì„  í•„ìš” ë¶€ë¶„**:
1. í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ ëˆ„ë½ (ê°€ì¥ ì¤‘ìš”!)
2. íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¶€ì¬
3. ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€ ë¡œì§ ë¶€ì¡±
4. ì—ëŸ¬ ì²˜ë¦¬ ê°•í™” í•„ìš”

### ì¶”ì²œ ì‘ì—… ìˆœì„œ

1. **ë¨¼ì €**: í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€ (ê°€ì¥ ì¤‘ìš”)
2. **ë‹¤ìŒ**: íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë° ì¤‘ë³µ ë°©ì§€
3. **ê·¸ ë‹¤ìŒ**: ì—„ê²© ëª¨ë“œ ë° ë°°ì¹˜ ê²€ì¦
4. **ë§ˆì§€ë§‰**: ì´ë ¥ ë¡œê¹… ë° ì‹œë®¬ë ˆì´ì…˜

---

**ë‹¤ìŒ ë‹¨ê³„**: ìœ„ ê°œì„  ì‚¬í•­ì„ ì‹¤ì œ ì½”ë“œì— ì ìš©í• ê¹Œìš”?
