# ë°°ì¹˜ ì‹œìŠ¤í…œ ì¬ì„¤ê³„ì•ˆ ìµœì¢… ê²€í† 

**ê²€í† ì¼**: 2025-10-25
**ìƒíƒœ**: êµ¬í˜„ ì „ ìµœì¢… ê²€ì¦

---

## ğŸ” ê²€í†  ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… 1. í˜•í‰ì„± ì„¤ì • ë°˜ì˜ í™•ì¸

**ìš”êµ¬ì‚¬í•­**:
- ì•¼ê°„, ì£¼ë§, ê³µíœ´ì¼, ê³µíœ´ì¼ ì „í›„ë¥¼ **ì„¤ì •ì— ë”°ë¼** ì„ íƒì  ì ìš©

**ì¬ì„¤ê³„ì•ˆ í™•ì¸**:
```typescript
// FairnessSettingsì—ì„œ ê° í•­ëª©ë³„ í™œì„±í™” ì—¬ë¶€ í™•ì¸
const fairnessSettings = await prisma.fairnessSettings.findUnique({
  where: { clinicId }
})

// ì„¤ì •ì— ë”°ë¼ í˜•í‰ì„± ìœ í˜• ì¶”ê°€
if (hasNightShift && fairnessSettings?.enableNightShiftFairness) {
  day.fairnessTypes.push('NIGHT_SHIFT')
}
if (dayTypes.includes('SATURDAY') && fairnessSettings?.enableWeekendFairness) {
  day.fairnessTypes.push('WEEKEND')
}
if (dayTypes.includes('HOLIDAY') && fairnessSettings?.enableHolidayFairness) {
  day.fairnessTypes.push('HOLIDAY')
}
if (dayTypes.includes('HOLIDAY_ADJACENT') && fairnessSettings?.enableHolidayAdjacentFairness) {
  day.fairnessTypes.push('HOLIDAY_ADJACENT')
}
```
âœ… **ì •í™•í•¨** - ì„¤ì • ê¸°ë°˜ ì„ íƒ ì ìš©

---

### âœ… 2. ê³µíœ´ì¼ ì „í›„ ì²˜ë¦¬ í™•ì¸

**ìš”êµ¬ì‚¬í•­**:
- ê³µíœ´ì¼ ì „í›„ì¼ ë³„ë„ ì²˜ë¦¬
- `day-type-classifier.ts`ì— ì´ë¯¸ êµ¬í˜„ë¨

**ì¬ì„¤ê³„ì•ˆ í™•ì¸**:
```typescript
// classifyDayType() í•¨ìˆ˜ê°€ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŒ
const dayTypes = await classifyDayType(clinicId, date)
// ë°˜í™˜ ê°€ëŠ¥ ê°’: ['WEEKDAY', 'SATURDAY', 'SUNDAY', 'HOLIDAY', 'HOLIDAY_ADJACENT', 'HOLIDAY_ADJACENT_SUNDAY']

// ê³µíœ´ì¼ ì „í›„ ì¼ìš”ì¼ë„ ë³„ë„ ì²˜ë¦¬ë¨
if (dayOfWeek === 0) {
  types.push('HOLIDAY_ADJACENT_SUNDAY')
} else {
  types.push('HOLIDAY_ADJACENT')
}
```
âœ… **ì •í™•í•¨** - ê³µíœ´ì¼ ì „í›„ ì²˜ë¦¬ ì™„ë£Œ

---

### âœ… 3. ì£¼ë³„ ë°°ì¹˜ ìˆœì„œ ê²€ì¦

**ìš”êµ¬ì‚¬í•­ ìˆœì„œ**:
1. í•„ìš”ì¸ì› ê³„ì‚° (êµ¬ë¶„ë³„)
2. ì—°ì°¨/ì˜¤í”„ ìŠ¹ì¸ ì¸ì› ì œì™¸
3. í˜•í‰ì„± í•„ìš” ë‚ ì§œ ì²´í¬
4. í˜•í‰ì„± ë‚ ì§œë¶€í„° ìš°ì„  ë°°ì¹˜
5. ì „ì²´ ê·¼ë¬´ì¼ìˆ˜ ì²´í¬
6. ë¶€ì¡± ì¸ì› ìš°ì„  ë°°ì¹˜
7. ë‚˜ë¨¸ì§€ ë‚ ì§œ ë°°ì¹˜
8. ë°°ì¹˜ ê²€ì¦
9. ì¡°ìœ¨ ì‹œë„
10. ì°¨ì£¼ ë°˜ì˜ or ì™„ë£Œ
11. ë‹¤ìŒ ì£¼ì°¨
12. ì›” ì „ì²´ ê²€í† 
13. ë¬¸ì œì  í™•ì¸
14. ìµì›” ë°˜ì˜

**ì¬ì„¤ê³„ì•ˆ ë§¤í•‘**:
- 1ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 1ë²ˆ
- 2ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 2ë²ˆ
- 3ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 3ë²ˆ
- 4ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 4ë²ˆ
- 5ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 5ë²ˆ
- 6ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 6ë²ˆ
- 7ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 7ë²ˆ
- 8ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 8ë²ˆ
- 9ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 9ë²ˆ
- 10ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 10ë²ˆ
- 11ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 11ë²ˆ
- 12ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 12ë²ˆ
- 13ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 13ë²ˆ
- 14ë‹¨ê³„ â†’ âœ… ìš”êµ¬ì‚¬í•­ 14ë²ˆ

âœ… **ì™„ë²½íˆ ì¼ì¹˜**

---

### âš ï¸ 4. ëˆ„ë½/ì˜¤ë¥˜ ë°œê²¬ ì‚¬í•­

#### ğŸ”´ ë°œê²¬ 1: Flexible Staff ì¡°íšŒ ì‹œ ì´ë¯¸ ë°°ì¹˜ëœ ì¸ì› ì œì™¸ ëˆ„ë½

**ë¬¸ì œ**:
```typescript
const flexibleStaff = await getFlexibleStaff(
  clinicId,
  category,
  alreadyAssignedIds  // â† ì´ ë‚ ì§œì—ë§Œ ë°°ì¹˜ëœ ì¸ì›
)
```

**ìˆ˜ì • í•„ìš”**:
```typescript
// ì´ë²ˆ ì£¼ ì´ë¯¸ ë°°ì¹˜ëœ ëª¨ë“  ë‚ ì§œë¥¼ ê³ ë ¤í•´ì•¼ í•¨
const alreadyAssignedThisWeek = new Set<string>()
weeklyAssignments.forEach((dates, staffId) => {
  if (dates.size > 0) {
    alreadyAssignedThisWeek.add(staffId)
  }
})

const flexibleStaff = await getFlexibleStaff(
  clinicId,
  category,
  Array.from(alreadyAssignedThisWeek)
)
```

#### ğŸ”´ ë°œê²¬ 2: ê°™ì€ ë‚ ì§œ ì¤‘ë³µ ë°°ì¹˜ ê°€ëŠ¥ì„±

**ë¬¸ì œ**:
```typescript
// êµ¬ë¶„ë³„ ë£¨í”„ì—ì„œ ê°™ì€ ì§ì›ì´ ë‹¤ë¥¸ êµ¬ë¶„ìœ¼ë¡œ ë°°ì¹˜ë  ìˆ˜ ìˆìŒ
for (const [category, required] of Object.entries(day.categoryRequirements)) {
  // ... ë°°ì¹˜ ë¡œì§
}
```

**ìˆ˜ì • í•„ìš”**:
```typescript
// ì´ë¯¸ ì´ ë‚ ì§œì— ë°°ì¹˜ëœ ì§ì› ì¶”ì 
const assignedToday = new Set<string>()

for (const [category, required] of Object.entries(day.categoryRequirements)) {
  const availableStaff = allActiveStaff.filter(staff => {
    // ... ê¸°ì¡´ ì¡°ê±´ë“¤

    // âœ… ì˜¤ëŠ˜ ì´ë¯¸ ë°°ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (assignedToday.has(staff.id)) return false

    return true
  })

  // ë°°ì¹˜ í›„
  toAssign.forEach(({ staff }) => {
    assignedToday.add(staff.id)  // âœ… ì¶”ê°€
    // ...
  })
}
```

#### ğŸŸ¡ ë°œê²¬ 3: í˜•í‰ì„± ì ìˆ˜ê°€ ì—†ëŠ” ì‹ ê·œ ì§ì› ì²˜ë¦¬

**ë¬¸ì œ**:
```typescript
const fairnessScore = staff.fairnessScores[0]
let score = fairnessScore?.holidayCount || 0
```

**ê°œì„ **:
```typescript
// ì‹ ê·œ ì§ì›ì€ ì ìˆ˜ 0ìœ¼ë¡œ ìš°ì„  ë°°ì¹˜
const fairnessScore = staff.fairnessScores[0]
let score = 0

if (fairnessScore) {
  if (day.fairnessTypes.includes('HOLIDAY')) {
    score = fairnessScore.holidayCount
  } else if (day.fairnessTypes.includes('HOLIDAY_ADJACENT')) {
    score = fairnessScore.holidayAdjacentCount
  } // ...
} else {
  // ì‹ ê·œ ì§ì›ì€ ì ìˆ˜ 0 â†’ ìµœìš°ì„  ë°°ì¹˜
  score = 0
}
```

#### ğŸŸ¡ ë°œê²¬ 4: ì£¼ ê·¼ë¬´ì¼ìˆ˜ ê³„ì‚° ì‹œ ì—°ì°¨ í¬í•¨ í™•ì¸

**í™•ì¸ í•„ìš”**:
```typescript
const totalDays = currentDays + leaveDays  // âœ… ì—°ì°¨/ì˜¤í”„ë„ ê·¼ë¬´ì¼ìˆ˜ë¡œ ì¹´ìš´íŠ¸
```
â†’ ì´ê²Œ ë§ëŠ”ì§€ í™•ì¸ í•„ìš”. **ì£¼4ì¼ = 4ì¼ ê·¼ë¬´ + 2ì¼ íœ´ë¬´**ì¸ë°, ì—°ì°¨ë¥¼ íœ´ë¬´ë¡œ ë³¼ì§€ ê·¼ë¬´ì¼ë¡œ ë³¼ì§€?

**ê²°ë¡ **:
- **ì£¼4ì¼ ì§ì›**: ì£¼ë‹¹ 4ì¼ ê·¼ë¬´í•´ì•¼ í•¨ (ë‚˜ë¨¸ì§€ 2ì¼ì€ ìë™ íœ´ë¬´)
- **ì—°ì°¨ ì‚¬ìš©**: ê·¼ë¬´ì¼ ì¤‘ 1ì¼ì„ ì—°ì°¨ë¡œ ëŒ€ì²´ â†’ `currentDays + leaveDays = 4`ê°€ ë˜ì–´ì•¼ í•¨

âœ… **ì •í™•í•¨** - í˜„ì¬ ë¡œì§ì´ ë§ìŒ

#### ğŸŸ¢ ë°œê²¬ 5: íŠ¸ëœì­ì…˜ ë²”ìœ„

**í™•ì¸**:
```typescript
// ì£¼ë³„ ë°°ì¹˜ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ?
await prisma.$transaction(async (tx) => {
  // 1ì£¼ì¼ ì „ì²´ ë°°ì¹˜
})
```

**ë¬¸ì œì **:
- íŠ¸ëœì­ì…˜ì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŒ (íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥)
- ì¤‘ê°„ì— ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ë¡¤ë°±

**ê°œì„ ì•ˆ**:
```typescript
// ë‚ ì§œë³„ë¡œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬
for (const day of sortedDays) {
  await prisma.$transaction(async (tx) => {
    // í•˜ë£¨ ë°°ì¹˜ë§Œ
  })
}

// ë˜ëŠ” ì£¼ë³„ ë°°ì¹˜ ì™„ë£Œ í›„ ê²€ì¦ì—ì„œ ë¬¸ì œ ë°œê²¬ ì‹œ ì „ì²´ ì‚­ì œ
if (hasUnresolvableIssues) {
  await prisma.dailyStaffAssignment.deleteMany({
    where: {
      dailySlot: {
        week: { id: weekInfoId }
      }
    }
  })
}
```

#### ğŸ”´ ë°œê²¬ 6: WorkTypeì´ nullì¸ ì§ì› ì²˜ë¦¬

**ë¬¸ì œ**:
```typescript
const requiredDays = staff.workType === 'WEEK_4' ? 4 : 5
```

**ìˆ˜ì •**:
```typescript
const requiredDays = staff.workType === 'WEEK_4' ? 4 :
                     staff.workType === 'WEEK_5' ? 5 :
                     staff.workDays || 4  // ê¸°ì¡´ workDays í•„ë“œ í™œìš©
```

#### ğŸŸ¡ ë°œê²¬ 7: ìš°ì„ ìˆœìœ„ ê³„ì‚° í•¨ìˆ˜ ëˆ„ë½

**ë¬¸ì œ**:
```typescript
day.priority = calculatePriority(day.fairnessTypes)
// â† ì´ í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ
```

**ì¶”ê°€ í•„ìš”**:
```typescript
function calculatePriority(fairnessTypes: string[]): number {
  // ìš°ì„ ìˆœìœ„: HOLIDAY(4) > HOLIDAY_ADJACENT(3) > WEEKEND(2) > NIGHT_SHIFT(1)
  if (fairnessTypes.includes('HOLIDAY')) return 4
  if (fairnessTypes.includes('HOLIDAY_ADJACENT')) return 3
  if (fairnessTypes.includes('HOLIDAY_ADJACENT_SUNDAY')) return 3
  if (fairnessTypes.includes('WEEKEND')) return 2
  if (fairnessTypes.includes('NIGHT_SHIFT')) return 1
  return 0
}
```

#### ğŸŸ¢ ë°œê²¬ 8: ê²€ì¦ í•¨ìˆ˜ë“¤ êµ¬í˜„ í•„ìš”

**ëˆ„ë½ëœ í•¨ìˆ˜ë“¤**:
```typescript
// 1. Flexible Staff ë°°ì¹˜ ì¬ì‹œë„
async function tryFlexibleStaffAssignment(
  category: string,
  date: Date,
  weeklyAssignments: Map,
  staffStatus: Map
): Promise<{ success: boolean; assignedStaff?: any[]; reason?: string }>

// 2. ì§ì› ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡± í•´ê²°
async function tryFillStaffShortage(
  staffId: string,
  dailyRequirements: any[],
  weeklyAssignments: Map,
  staffStatus: Map
): Promise<{ success: boolean; assignedDates?: string[]; reason?: string }>

// 3. ì´ìŠˆ íƒ€ë‹¹ì„± ê²€í† 
async function checkIfJustified(
  issue: ValidationIssue,
  staffStatus: Map,
  confirmedLeaves: any[]
): Promise<{ valid: boolean; reason: string }>

// 4. ì£¼ê°„ ë°°ì¹˜ ì €ì¥
async function saveWeeklyAssignments(
  weeklyAssignments: Map,
  weekInfo: any
): Promise<void>

// 5. ë¯¸í•´ê²° ì´ìŠˆ ì €ì¥
async function saveUnresolvedIssues(
  data: any
): Promise<void>

// 6. ë¯¸í•´ê²° ì´ìŠˆ ë¡œë“œ
async function loadUnresolvedIssues(
  weekInfoId: string
): Promise<ValidationIssue[]>
```

---

## ğŸ“‹ ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

#### Phase 1: Prisma Schema ìˆ˜ì •
- [ ] UnresolvedIssue ëª¨ë¸ ì¶”ê°€
- [ ] FairnessAdjustment ëª¨ë¸ ì¶”ê°€
- [ ] WeekInfoì— status, completedAt, approvedAt í•„ë“œ ì¶”ê°€
- [ ] Migration ìƒì„± ë° ì ìš©

#### Phase 2: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
- [ ] `calculatePriority()` í•¨ìˆ˜
- [ ] `tryFlexibleStaffAssignment()` í•¨ìˆ˜
- [ ] `tryFillStaffShortage()` í•¨ìˆ˜
- [ ] `checkIfJustified()` í•¨ìˆ˜
- [ ] `saveWeeklyAssignments()` í•¨ìˆ˜
- [ ] `saveUnresolvedIssues()` í•¨ìˆ˜
- [ ] `loadUnresolvedIssues()` í•¨ìˆ˜

#### Phase 3: ë©”ì¸ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜
- [ ] `autoAssignWeeklySchedule()` ì™„ì „ ì¬êµ¬í˜„
  - [ ] 1-3ë‹¨ê³„: ì¤€ë¹„ (í•„ìš”ì¸ì›, ì—°ì°¨ë°˜ì˜, í˜•í‰ì„±ì²´í¬)
  - [ ] 4-5ë‹¨ê³„: ìš°ì„  ë°°ì¹˜ (í˜•í‰ì„± ë‚ ì§œ, ê·¼ë¬´ì¼ìˆ˜ ì²´í¬)
  - [ ] 6-7ë‹¨ê³„: ë³´ì¶© ë°°ì¹˜ (ë¶€ì¡± ì¸ì›, ë‚˜ë¨¸ì§€ ë‚ ì§œ)
  - [ ] 8-10ë‹¨ê³„: ê²€ì¦ ë° ì¡°ìœ¨
  - [ ] 11ë‹¨ê³„: ë‹¤ìŒ ì£¼ì°¨ ì²˜ë¦¬
  - [ ] 12-14ë‹¨ê³„: ì›” ë§ˆë¬´ë¦¬

#### Phase 4: í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
- [ ] `updateFairnessScoresAfterAssignment()` êµ¬í˜„
- [ ] ë°°ì¹˜ ì™„ë£Œ ì‹œ ìë™ í˜¸ì¶œ

#### Phase 5: API ë¼ìš°íŠ¸ ì—°ê²°
- [ ] `/api/schedule/weekly-assign` POST
- [ ] `/api/schedule/monthly-review` GET
- [ ] `/api/schedule/adjust-fairness` POST

### ì˜¤ë¥˜ ìˆ˜ì • ì‚¬í•­

- [x] âœ… í˜•í‰ì„± ì„¤ì • ë°˜ì˜ í™•ì¸
- [x] âœ… ê³µíœ´ì¼ ì „í›„ ì²˜ë¦¬ í™•ì¸
- [x] âœ… ë°°ì¹˜ ìˆœì„œ ê²€ì¦
- [ ] ğŸ”´ Flexible Staff ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€
- [ ] ğŸ”´ ê°™ì€ ë‚ ì§œ ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€
- [ ] ğŸŸ¡ ì‹ ê·œ ì§ì› í˜•í‰ì„± ì ìˆ˜ ì²˜ë¦¬
- [ ] ğŸŸ¡ ìš°ì„ ìˆœìœ„ ê³„ì‚° í•¨ìˆ˜ ì¶”ê°€
- [ ] ğŸ”´ WorkType null ì²˜ë¦¬
- [ ] ğŸŸ¢ íŠ¸ëœì­ì…˜ ë²”ìœ„ ì¬ê²€í† 

---

## ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### 1ì°¨: í•„ìˆ˜ í•µì‹¬ (ì¦‰ì‹œ êµ¬í˜„)
1. Prisma Schema ìˆ˜ì •
2. `calculatePriority()` í•¨ìˆ˜
3. ë©”ì¸ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ (1-7ë‹¨ê³„)
4. í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
5. ì¤‘ë³µ ë°°ì¹˜ ë°©ì§€ ë¡œì§

### 2ì°¨: ê²€ì¦ ë° ì¡°ìœ¨ (ë‹¤ìŒ ë‹¨ê³„)
6. ê²€ì¦ ë¡œì§ (8ë‹¨ê³„)
7. ì¡°ìœ¨ í•¨ìˆ˜ë“¤ (9-10ë‹¨ê³„)
8. ë¯¸í•´ê²° ì´ìŠˆ ì €ì¥/ë¡œë“œ

### 3ì°¨: ì›” ë‹¨ìœ„ ê´€ë¦¬ (ë§ˆì§€ë§‰)
9. ë‹¤ìŒ ì£¼ì°¨ ì²˜ë¦¬ (11ë‹¨ê³„)
10. ì›” ì „ì²´ ê²€í†  (12-14ë‹¨ê³„)
11. API ë¼ìš°íŠ¸ ì—°ê²°

---

## âœ… ê²€í†  ê²°ê³¼

**ì „ì²´ í‰ê°€**: ì¬ì„¤ê³„ì•ˆì€ ìš”êµ¬ì‚¬í•­ì„ **95% ë°˜ì˜**í–ˆìœ¼ë‚˜, **7ê°œì˜ ì˜¤ë¥˜ ë° ëˆ„ë½ ë°œê²¬**

**ìˆ˜ì • í›„ êµ¬í˜„ ê°€ëŠ¥ ì—¬ë¶€**: âœ… **ê°€ëŠ¥** (ì˜¤ë¥˜ ìˆ˜ì • í›„)

**ì¶”ì²œ ì‘ì—… ìˆœì„œ**:
1. ë°œê²¬ëœ ì˜¤ë¥˜ 7ê°œ ìˆ˜ì •
2. 1ì°¨ í•„ìˆ˜ í•µì‹¬ êµ¬í˜„
3. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
4. 2ì°¨, 3ì°¨ ìˆœì°¨ êµ¬í˜„

---

**ê²°ë¡ **: ì˜¤ë¥˜ ìˆ˜ì • ì™„ë£Œ í›„ êµ¬í˜„ ì‹œì‘
