# 관리자 페이지 설계

## 1. 개요

시스템의 보안과 안정적인 운영을 위한 관리자 전용 페이지

### 목적
- 무분별한 회원가입 방지
- 사용자 권한 관리
- 시스템 전체 모니터링
- 병원별 데이터 관리

## 2. 사용자 역할 체계

### 2.1 역할 정의

```typescript
enum UserRole {
  SUPER_ADMIN   // 시스템 전체 관리자 (개발자)
  ADMIN         // 병원 시스템 관리자
  MANAGER       // 병원 관리자 (스케줄 관리 권한)
  STAFF         // 일반 직원 (조회만 가능)
}

enum AccountStatus {
  PENDING       // 가입 대기 (승인 필요)
  APPROVED      // 승인됨
  REJECTED      // 거절됨
  SUSPENDED     // 정지됨
  DELETED       // 삭제됨
}
```

### 2.2 권한 매트릭스

| 기능 | SUPER_ADMIN | ADMIN | MANAGER | STAFF |
|------|-------------|-------|---------|-------|
| 회원 승인/거절 | ✅ | ✅ (본인 병원만) | ❌ | ❌ |
| 사용자 역할 변경 | ✅ | ✅ (본인 병원만) | ❌ | ❌ |
| 병원 생성/삭제 | ✅ | ❌ | ❌ | ❌ |
| 전체 사용자 조회 | ✅ | ✅ (본인 병원만) | ❌ | ❌ |
| 시스템 설정 | ✅ | ✅ | ✅ | ❌ |
| 스케줄 관리 | ✅ | ✅ | ✅ | ❌ |
| 스케줄 조회 | ✅ | ✅ | ✅ | ✅ |

## 3. 데이터베이스 스키마 수정

### 3.1 User 모델 확장

```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(STAFF)

  // 가입 승인 관련 (NEW)
  accountStatus  AccountStatus @default(PENDING)
  approvedBy     String?       // 승인자 ID
  approvedAt     DateTime?     // 승인 날짜
  rejectedReason String?       // 거절 사유
  suspendedReason String?      // 정지 사유
  suspendedUntil  DateTime?    // 정지 기한

  clinicId  String?
  clinic    Clinic?  @relation(fields: [clinicId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  notifications       Notification[]
  activityLogs        ActivityLog[]
  passwordResetTokens PasswordResetToken[]
  approvedUsers       User[] @relation("UserApprovals") // 내가 승인한 사용자들

  @@index([clinicId])
  @@index([email])
  @@index([accountStatus])
}

enum UserRole {
  SUPER_ADMIN // 시스템 전체 관리자
  ADMIN       // 병원 시스템 관리자
  MANAGER     // 병원 관리자
  STAFF       // 일반 직원
}

enum AccountStatus {
  PENDING    // 가입 대기
  APPROVED   // 승인됨
  REJECTED   // 거절됨
  SUSPENDED  // 정지됨
  DELETED    // 삭제됨
}
```

## 4. 관리자 페이지 구조

### 4.1 슈퍼 관리자 페이지 (`/admin`)

#### 4.1.1 대시보드 (`/admin/dashboard`)
**기능:**
- 전체 시스템 통계
  - 총 병원 수
  - 총 사용자 수 (역할별)
  - 대기 중인 승인 요청 수
  - 일별 가입자 추이
- 최근 활동 로그
- 시스템 상태 모니터링
- 빠른 액션 버튼

**UI:**
```
┌─────────────────────────────────────────────┐
│  시스템 대시보드                               │
├─────────────────────────────────────────────┤
│  📊 통계 카드                                 │
│  [병원: 15개] [사용자: 243명] [대기: 8명]      │
├─────────────────────────────────────────────┤
│  📈 가입 추이 차트                            │
│  (최근 30일 일별 가입자 그래프)                │
├─────────────────────────────────────────────┤
│  🔔 알림                                      │
│  • 8명의 가입 승인 대기 중                     │
│  • 병원 "ABC치과" 초기 설정 완료               │
└─────────────────────────────────────────────┘
```

#### 4.1.2 회원 관리 (`/admin/users`)
**기능:**
- 전체 사용자 목록 조회
  - 상태별 필터 (PENDING, APPROVED, etc.)
  - 역할별 필터
  - 병원별 필터
  - 검색 (이름, 이메일)
- 사용자 상세 정보 조회
- 계정 승인/거절
- 역할 변경
- 계정 정지/복구/삭제
- 비밀번호 재설정
- 활동 로그 조회

**UI:**
```
┌─────────────────────────────────────────────┐
│  회원 관리                                    │
├─────────────────────────────────────────────┤
│  필터: [상태 ▼] [역할 ▼] [병원 ▼]  🔍 검색   │
├─────────────────────────────────────────────┤
│  [승인 대기: 8명] [전체: 243명]               │
├─────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────┐│
│  │ 🟡 홍길동 | hong@example.com             ││
│  │ 역할: STAFF | 병원: ABC치과               ││
│  │ 가입: 2025-10-25  [승인] [거절]          ││
│  └─────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────┐│
│  │ 🟢 김철수 | kim@example.com              ││
│  │ 역할: MANAGER | 병원: ABC치과             ││
│  │ 승인: 2025-10-20  [정보] [정지] [삭제]    ││
│  └─────────────────────────────────────────┘│
└─────────────────────────────────────────────┘
```

**승인/거절 모달:**
```
┌─────────────────────────────┐
│  회원 승인                    │
├─────────────────────────────┤
│  이름: 홍길동                 │
│  이메일: hong@example.com    │
│  병원: ABC치과                │
│                              │
│  역할 선택:                   │
│  ○ STAFF (일반 직원)          │
│  ○ MANAGER (관리자)           │
│  ○ ADMIN (시스템 관리자)       │
│                              │
│  [취소] [승인]                │
└─────────────────────────────┘
```

#### 4.1.3 병원 관리 (`/admin/clinics`)
**기능:**
- 병원 목록 조회
- 병원 상세 정보
- 병원별 사용자 현황
- 병원별 데이터 통계
- 병원 생성/수정/삭제
- 초기 설정 상태 확인

**UI:**
```
┌─────────────────────────────────────────────┐
│  병원 관리                                    │
├─────────────────────────────────────────────┤
│  🔍 검색  [+ 새 병원 추가]                    │
├─────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────┐│
│  │ 🏥 ABC치과                               ││
│  │ 주소: 서울시 강남구...                    ││
│  │ 사용자: 15명 | 설정: ✅ 완료              ││
│  │ 생성: 2025-08-15  [상세] [수정]          ││
│  └─────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────┐│
│  │ 🏥 XYZ치과                               ││
│  │ 주소: 서울시 서초구...                    ││
│  │ 사용자: 8명 | 설정: ⏳ 진행중             ││
│  │ 생성: 2025-09-20  [상세] [수정]          ││
│  └─────────────────────────────────────────┘│
└─────────────────────────────────────────────┘
```

#### 4.1.4 시스템 로그 (`/admin/logs`)
**기능:**
- 전체 활동 로그 조회
- 로그 필터링 (사용자, 액션, 날짜)
- 로그 내보내기
- 중요 이벤트 알림

#### 4.1.5 시스템 설정 (`/admin/settings`)
**기능:**
- 전역 설정
- 이메일 설정
- 알림 설정
- 백업 설정
- 보안 설정

### 4.2 병원 관리자 페이지 (`/admin/clinic`)

#### 4.2.1 본인 병원 회원 관리 (`/admin/clinic/users`)
**기능:**
- 본인 병원 사용자만 조회
- 가입 승인/거절
- 역할 변경 (STAFF, MANAGER만)
- 계정 정지/복구

#### 4.2.2 병원 설정 관리 (`/admin/clinic/settings`)
**기능:**
- 병원 정보 수정
- 초기 설정 재실행
- 병원 관리자 지정

## 5. 회원가입 프로세스 개선

### 5.1 현재 프로세스
1. 사용자가 가입 폼 작성
2. 즉시 계정 생성 및 로그인 가능

### 5.2 새로운 프로세스
1. 사용자가 가입 폼 작성
   - 이름, 이메일, 비밀번호
   - 병원 선택 (기존 병원 / 새 병원)
   - 신청 사유 (선택)
2. 계정 생성 (status: PENDING)
3. 승인 대기 안내 화면 표시
4. 관리자에게 알림 발송
5. 관리자가 승인/거절
6. 사용자에게 이메일 알림
7. 승인된 경우 로그인 가능

### 5.3 회원가입 페이지 수정

**가입 폼:**
```
┌─────────────────────────────┐
│  회원가입                     │
├─────────────────────────────┤
│  이름: [_____________]        │
│  이메일: [_____________]      │
│  비밀번호: [_____________]    │
│  비밀번호 확인: [_______]     │
│                              │
│  병원 선택:                   │
│  ○ 기존 병원 [병원 선택 ▼]    │
│  ○ 새 병원 [병원명 입력...]   │
│                              │
│  신청 사유: (선택)             │
│  [_____________________]     │
│                              │
│  [가입 신청]                  │
└─────────────────────────────┘
```

**승인 대기 안내:**
```
┌─────────────────────────────┐
│  ✅ 가입 신청 완료             │
├─────────────────────────────┤
│  관리자의 승인을 기다리는 중입니다│
│                              │
│  승인 결과는 이메일로           │
│  안내해 드립니다.              │
│                              │
│  [확인]                       │
└─────────────────────────────┘
```

## 6. API 설계

### 6.1 슈퍼 관리자 API

```typescript
// 회원 관리
GET    /api/admin/users              // 전체 사용자 목록
GET    /api/admin/users/:id          // 사용자 상세
POST   /api/admin/users/:id/approve  // 승인
POST   /api/admin/users/:id/reject   // 거절
PATCH  /api/admin/users/:id/role     // 역할 변경
POST   /api/admin/users/:id/suspend  // 정지
POST   /api/admin/users/:id/restore  // 복구
DELETE /api/admin/users/:id          // 삭제

// 병원 관리
GET    /api/admin/clinics            // 병원 목록
GET    /api/admin/clinics/:id        // 병원 상세
POST   /api/admin/clinics            // 병원 생성
PATCH  /api/admin/clinics/:id        // 병원 수정
DELETE /api/admin/clinics/:id        // 병원 삭제

// 시스템
GET    /api/admin/stats              // 통계
GET    /api/admin/logs               // 로그
GET    /api/admin/settings           // 설정 조회
PATCH  /api/admin/settings           // 설정 수정
```

### 6.2 병원 관리자 API

```typescript
// 본인 병원 회원 관리
GET    /api/admin/clinic/users              // 본인 병원 사용자 목록
POST   /api/admin/clinic/users/:id/approve  // 승인
POST   /api/admin/clinic/users/:id/reject   // 거절
PATCH  /api/admin/clinic/users/:id/role     // 역할 변경
```

## 7. 보안 고려사항

### 7.1 접근 제어
- 미들웨어로 역할 검증
- SUPER_ADMIN만 접근 가능한 경로
- ADMIN은 본인 병원만 관리

### 7.2 감사 로그
- 모든 관리 작업 로그 기록
- 승인/거절/정지 사유 필수 입력
- IP 주소 기록

### 7.3 초기 슈퍼 관리자 설정
- 환경변수로 초기 관리자 이메일 지정
- 시드 데이터로 SUPER_ADMIN 계정 생성

```typescript
// prisma/seed.ts
const superAdmin = await prisma.user.create({
  data: {
    email: process.env.SUPER_ADMIN_EMAIL || 'admin@system.com',
    password: await hash(process.env.SUPER_ADMIN_PASSWORD || 'ChangeMe123!'),
    name: '시스템 관리자',
    role: 'SUPER_ADMIN',
    accountStatus: 'APPROVED',
  }
});
```

## 8. 구현 우선순위

### Phase 0 (관리자 시스템 기반)
1. **DB 스키마 수정** - AccountStatus 추가
2. **회원가입 프로세스 개선** - 승인 대기 로직
3. **슈퍼 관리자 페이지**
   - 회원 관리 (승인/거절)
   - 병원 관리 (목록/상세)
   - 대시보드 (통계)
4. **병원 관리자 페이지**
   - 본인 병원 회원 관리

이 작업을 Phase 1 이전에 먼저 진행하는 것이 좋을 것 같습니다.

---

**작성일**: 2025-10-26
**작성자**: Claude
**버전**: 1.0
