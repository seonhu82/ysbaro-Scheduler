# 최종 결정사항 및 작업 계획

**작성일**: 2025-10-22
**상태**: 승인됨 ✅
**우선순위**: High

---

## 📋 최종 결정사항

### 1. ✅ work_type 필드 추가 (확장성 고려)

**결정**:
- 추후 확장성을 위해 설정에서 주4일/주5일 구분
- 직원별로 적용 가능하게 구현

**변경 필요**:
```prisma
enum WorkType {
  WEEK_4         // 주4일 근무
  WEEK_5         // 주5일 근무
}

model Staff {
  // ... 기존 필드들
  workType           WorkType            @default(WEEK_4)  // ⭐ 추가

  // ... 관계들
}

model RuleSettings {
  // ... 기존 필드들

  // 주4일 관련 설정 ⭐ 추가
  week4WorkDays      Int      @default(4)    // 주4일: 주당 근무일
  week4OffDays       Int      @default(2)    // 주4일: 주당 오프일

  // 주5일 관련 설정 ⭐ 추가
  week5WorkDays      Int      @default(5)    // 주5일: 주당 근무일
  week5OffDays       Int      @default(1)    // 주5일: 주당 오프일
}
```

**영향 범위**:
- [ ] Prisma 스키마 수정
- [ ] 직원 관리 API 수정
- [ ] 직원 관리 UI 수정 (workType 선택 추가)
- [ ] 설정 페이지에 주4일/주5일 설정 추가
- [ ] 오프 배정 로직에 workType 고려
- [ ] 검증 로직 수정

---

### 2. ✅ 연차 시스템 (모든 직원 연차 있음)

**결정**:
- 모든 직원이 연차를 가짐
- 근속 연수에 따라 연차 일수 자동 계산

**개념 정리**:
```
오프 (OFF):
- 주4일 직원: 주 2일 (의무)
- 주5일 직원: 주 1일 (의무)
- 매주 자동 배정

연차 (ANNUAL):
- 모든 직원 공통
- 근속 연수에 따라 부여 (15일~25일)
- 직접 신청
```

**변경 필요**:
```prisma
model Staff {
  // ... 기존 필드들
  workType           WorkType            @default(WEEK_4)
  hireDate           DateTime?                              // ⭐ 추가 (입사일)

  // ... 관계들
}

// 연차 계산 로직
function calculateAnnualLeaveDays(hireDate) {
  const yearsOfService = getYearsOfService(hireDate);

  if (yearsOfService < 1) return 15;
  if (yearsOfService < 3) return 15;

  // 3년차부터 2년마다 1일 추가, 최대 25일
  return Math.min(15 + Math.floor((yearsOfService - 1) / 2), 25);
}
```

**영향 범위**:
- [ ] Prisma 스키마에 hireDate 추가
- [ ] 연차 계산 로직 구현
- [ ] 직원 상세 화면에 연차 정보 표시
- [ ] 연차 신청 시 잔여 연차 확인

---

### 3. ✅ 슬롯 계산 로직 - 주별로 변경 (중요 ⚠️)

**결정**:
- 주4일제는 주 기준 4일 근무이므로 **주별로 구분하여 계산**
- 나중에 오류를 줄이기 위해 주 단위 관리 필수

**현재 구현 (날짜별)**:
```prisma
model SlotLimit {
  id              String          @id @default(cuid())
  linkId          String
  date            DateTime  @db.Date        // ⚠️ 날짜별
  dayType         DayType
  maxSlots        Int
  currentSlots    Int             @default(0)
}
```

**변경 후 (주별)**:
```prisma
model WeekInfo {
  id                 String   @id @default(cuid())
  clinicId           String
  clinic             Clinic   @relation(fields: [clinicId], references: [id])
  year               Int
  month              Int
  weekNumber         Int                    // 1, 2, 3, 4, 5
  weekStart          DateTime  @db.Date    // 월요일
  weekEnd            DateTime  @db.Date    // 토요일

  // 주차 계산 정보
  totalSlots         Int                    // 총 휴무 가능 자리
  offTarget          Int                    // 오프 배정 목표
  annualAvailable    Int                    // 연차 가능 자리
  hasHoliday         Boolean  @default(false)  // 일요일/공휴일 포함 여부

  isLocked           Boolean  @default(false)  // 이월되어 수정 불가
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // 관계
  dailySlots         DailySlot[]

  @@unique([clinicId, year, month, weekNumber])
  @@index([clinicId, year, month])
}

model DailySlot {
  id                 String   @id @default(cuid())
  weekId             String
  week               WeekInfo @relation(fields: [weekId], references: [id], onDelete: Cascade)
  date               DateTime @db.Date
  dayOfWeek          Int                    // 0=월, 5=토, 6=일

  // 슬롯 정보
  requiredStaff      Int                    // 필요 배치 인원
  availableSlots     Int                    // 휴무 가능 자리
  usedOff            Int      @default(0)  // 사용된 오프 자리
  usedAnnual         Int      @default(0)  // 사용된 연차 자리

  createdAt          DateTime @default(now())

  @@unique([weekId, date])
  @@index([date])
}
```

**영향 범위** (⚠️ 큰 변경):
- [ ] Prisma 스키마 대폭 수정
- [ ] WeekInfo, DailySlot 테이블 추가
- [ ] 슬롯 계산 로직 전면 재작성
- [ ] 연차 신청 API 수정 (주별 검증)
- [ ] 연차 관리 대시보드 수정
- [ ] 기존 SlotLimit 데이터 마이그레이션

---

### 4. ✅ QR 출퇴근 시스템 추가 (Phase 3)

**결정**:
- QR 기반 모바일 출퇴근 체크 시스템
- Phase 3에 포함하여 개발

**추가 필요 테이블**:
```prisma
// QR 토큰 관리
model QRToken {
  id             String   @id @default(cuid())
  clinicId       String
  clinic         Clinic   @relation(fields: [clinicId], references: [id])
  token          String   @unique
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  isActive       Boolean  @default(true)
  usedCount      Int      @default(0)
  lastUsedAt     DateTime?

  @@index([clinicId])
  @@index([token, isActive, expiresAt])
}

// 디바이스 정보
model DeviceInfo {
  id                String   @id @default(cuid())
  fingerprint       String   @unique
  userAgent         String
  platform          String?
  screenWidth       Int?
  screenHeight      Int?
  timezone          String?
  deviceNickname    String?
  firstSeen         DateTime @default(now())
  lastSeen          DateTime @default(now())
  usageCount        Int      @default(1)
  isBlocked         Boolean  @default(false)
  blockReason       String?

  // 관계
  attendanceRecords AttendanceRecord[]
  suspiciousLogs    SuspiciousLog[]

  @@index([fingerprint])
  @@index([isBlocked])
}

// 출퇴근 기록
model AttendanceRecord {
  id                String      @id @default(cuid())
  clinicId          String
  clinic            Clinic      @relation(fields: [clinicId], references: [id])
  staffId           String
  staff             Staff       @relation(fields: [staffId], references: [id])

  checkType         CheckType   // IN, OUT
  checkTime         DateTime
  checkDate         DateTime    @db.Date

  deviceFingerprint String
  device            DeviceInfo  @relation(fields: [deviceFingerprint], references: [fingerprint])

  tokenUsed         String
  wifiSSID          String?
  ipAddress         String?
  gpsLatitude       Float?
  gpsLongitude      Float?
  photoPath         String?

  isSuspicious      Boolean     @default(false)
  isLate            Boolean     @default(false)
  isEarlyLeave      Boolean     @default(false)
  notes             String?

  createdAt         DateTime    @default(now())

  @@unique([staffId, checkDate, checkType])
  @@index([clinicId, checkDate])
  @@index([staffId, checkDate])
  @@index([isSuspicious])
}

enum CheckType {
  IN             // 출근
  OUT            // 퇴근
}

// 의심 패턴 로그
model SuspiciousLog {
  id                String      @id @default(cuid())
  clinicId          String
  clinic            Clinic      @relation(fields: [clinicId], references: [id])
  detectedAt        DateTime    @default(now())

  patternType       String      // RAPID_CHECK, UNUSUAL_TIME, etc.
  severity          Severity

  deviceFingerprint String?
  device            DeviceInfo? @relation(fields: [deviceFingerprint], references: [fingerprint])

  staffIds          Json        // [staffId1, staffId2]
  description       String
  metadata          Json?

  adminReviewed     Boolean     @default(false)
  adminNotes        String?
  reviewedAt        DateTime?
  reviewedBy        String?

  @@index([clinicId, adminReviewed])
  @@index([severity, detectedAt])
}

enum Severity {
  LOW
  MEDIUM
  HIGH
}
```

**새로운 기능**:
1. QR 코드 5분 주기 자동 갱신
2. 디바이스 핑거프린팅
3. 출퇴근 체크 (중복 방지)
4. 의심 패턴 감지
5. 실시간 출근 현황
6. 지각/조퇴 통계

**새로운 페이지**:
- [ ] `/attendance` - 출퇴근 현황 대시보드
- [ ] `/attendance/qr` - QR 코드 표시 화면 (태블릿용)
- [ ] `/attendance/check` - 모바일 체크 페이지
- [ ] `/attendance/history` - 출퇴근 이력
- [ ] `/attendance/statistics` - 출퇴근 통계
- [ ] `/settings/attendance` - 출퇴근 설정

**영향 범위**:
- [ ] Prisma 스키마에 5개 테이블 추가
- [ ] QR 토큰 자동 갱신 백그라운드 작업
- [ ] 출퇴근 체크 API 구현
- [ ] 디바이스 핑거프린팅 클라이언트 JS
- [ ] 의심 패턴 감지 알고리즘
- [ ] 관리자 알림 시스템 연동
- [ ] 6개 페이지 UI 구현

---

### 5. ✅ 용어 통일

**결정**:
- **슬롯** (slot) - 휴무 가능 인원 수
- **오프** (OFF) - 주간 의무 휴무
- **연차** (ANNUAL) - 년차별 휴가

**용어 사전**:
```
슬롯 (Slot):
- 특정 날짜/주에 휴무 가능한 직원 수
- 총 직원 - 필요 배치 인원 = 가용 슬롯

오프 (OFF):
- 주 단위로 배정되는 의무 휴무
- 주4일: 주 2일, 주5일: 주 1일
- 자동 배정 또는 직접 신청

연차 (ANNUAL):
- 근속 연수에 따라 부여되는 유급 휴가
- 15일~25일 (근속 연수에 따라)
- 오프와 별개로 사용 가능

직원 (Staff):
- 스태프, 직원

원장 (Doctor):
- 닥터, 의사

주차 (Week):
- 월요일~토요일 6일 단위
- 일요일은 전원 휴무로 별도 관리

신청 기간 (Application Period):
- 연차/오프 신청을 받는 기간
- ApplicationLink로 관리
```

---

## 🎯 작업 우선순위

### Phase 2 완료 작업 (현재 40%)

#### 🔴 Priority 1: 핵심 변경 (2-3일 소요)

**1. Prisma 스키마 수정**
- [ ] WorkType enum 추가
- [ ] Staff 모델에 workType, hireDate 추가
- [ ] WeekInfo, DailySlot 테이블 추가
- [ ] QR 출퇴근 관련 테이블 추가
- [ ] 마이그레이션 실행

**예상 시간**: 4시간

**2. 설정 페이지 - 근무 형태 설정**
- [ ] `/settings/work-type` 페이지 생성
- [ ] 주4일/주5일 기본 설정 UI
- [ ] 설정 저장 API

**예상 시간**: 3시간

**3. 직원 관리 - workType 필드 추가**
- [ ] StaffForm에 workType 선택 추가
- [ ] StaffList에 workType 표시
- [ ] API에 workType 처리 추가

**예상 시간**: 2시간

#### 🟡 Priority 2: 슬롯 계산 로직 재작성 (3-4일 소요)

**4. 주별 슬롯 계산 로직**
- [ ] `src/lib/algorithms/week-slots-calculator.ts` 새로 작성
- [ ] 주차 정보 생성 함수
- [ ] 날짜별 슬롯 계산 함수
- [ ] 오프 목표 계산 (workType 고려)
- [ ] 연차 가능 자리 계산

**예상 시간**: 8시간

**5. 연차 신청 API 수정**
- [ ] 주별 검증으로 변경
- [ ] WeekInfo 기반 슬롯 확인
- [ ] workType별 오프 일수 검증

**예상 시간**: 4시간

**6. 연차 관리 대시보드 수정**
- [ ] 주별 뷰 추가
- [ ] 슬롯 현황 표시 변경
- [ ] 통계 계산 수정

**예상 시간**: 6시간

#### 🟢 Priority 3: QR 출퇴근 시스템 (5-7일 소요)

**7. QR 토큰 시스템**
- [ ] QR 토큰 생성 API
- [ ] 5분 주기 자동 갱신 (APScheduler)
- [ ] QR 코드 표시 페이지

**예상 시간**: 6시간

**8. 출퇴근 체크 시스템**
- [ ] 디바이스 핑거프린팅 클라이언트 JS
- [ ] 출퇴근 체크 API
- [ ] 중복 체크 방지 로직
- [ ] 모바일 체크 페이지

**예상 시간**: 8시간

**9. 의심 패턴 감지**
- [ ] 연속 체크 감지 알고리즘
- [ ] 비정상 시간 감지
- [ ] 관리자 알림 연동

**예상 시간**: 6시간

**10. 출퇴근 관리 페이지**
- [ ] 출퇴근 현황 대시보드
- [ ] 출퇴근 이력 조회
- [ ] 출퇴근 통계
- [ ] 설정 페이지

**예상 시간**: 10시간

---

## 📅 개발 일정 (예상)

### Week 1: 핵심 변경 (Priority 1)
- **Day 1**: Prisma 스키마 수정, 마이그레이션
- **Day 2**: 설정 페이지 (근무 형태)
- **Day 3**: 직원 관리 workType 추가

**목표**: workType 기능 완성, 설정 가능

### Week 2: 슬롯 로직 재작성 (Priority 2)
- **Day 1-2**: 주별 슬롯 계산 로직 작성
- **Day 3**: 연차 신청 API 수정
- **Day 4-5**: 연차 관리 대시보드 수정

**목표**: 주별 관리 시스템 완성

### Week 3: QR 출퇴근 시스템 (Priority 3, Part 1)
- **Day 1-2**: QR 토큰 시스템 + 자동 갱신
- **Day 3-4**: 출퇴근 체크 시스템

**목표**: 기본 출퇴근 체크 동작

### Week 4: QR 출퇴근 완성 (Priority 3, Part 2)
- **Day 1-2**: 의심 패턴 감지
- **Day 3-5**: 출퇴근 관리 페이지 4개

**목표**: QR 출퇴근 시스템 완성

### Week 5: 통합 테스트 및 버그 수정
- 전체 기능 테스트
- 버그 수정
- 문서 업데이트

---

## 📊 진행률 업데이트 계획

현재: **70%** (Phase 0: 100%, Phase 1: 100%, Phase 2: 40%)

목표:
- Week 1 후: 73% (Priority 1 완료)
- Week 2 후: 80% (Priority 2 완료, Phase 2: 80%)
- Week 3 후: 85% (QR Part 1 완료)
- Week 4 후: 95% (QR Part 2 완료, Phase 2: 100%)
- Week 5 후: 97% (테스트 완료, Phase 3 시작 준비)

---

## 🚀 다음 세션 시작 시

### 즉시 시작할 작업

**1단계: Prisma 스키마 수정** (30분)
```bash
# 1. schema.prisma 백업
cp prisma/schema.prisma prisma/schema.prisma.backup

# 2. WorkType enum, workType 필드, hireDate 추가
# 3. WeekInfo, DailySlot 테이블 추가
# 4. QR 출퇴근 테이블 추가

# 5. 마이그레이션 생성
npx prisma migrate dev --name add_work_type_and_attendance

# 6. Prisma Client 재생성
npx prisma generate
```

**2단계: 기존 데이터 마이그레이션** (30분)
```typescript
// prisma/migrations/migrate-to-weekly-slots.ts
// SlotLimit → WeekInfo + DailySlot 데이터 변환
```

**3단계: 설정 페이지 구현** (2시간)
```bash
# 페이지 생성
mkdir -p src/app/\(dashboard\)/settings/work-type
touch src/app/\(dashboard\)/settings/work-type/page.tsx

# API 생성
mkdir -p src/app/api/settings/work-type
touch src/app/api/settings/work-type/route.ts
```

---

## 📝 체크리스트

### Phase 2 완료 기준
- [ ] workType 필드 추가 및 설정 가능
- [ ] 주별 슬롯 계산 로직 완성
- [ ] 모든 직원 연차 사용 가능
- [ ] 연차 관리 대시보드 주별 뷰
- [ ] QR 출퇴근 기본 기능 동작
- [ ] 의심 패턴 감지 동작
- [ ] 출퇴근 관리 페이지 완성
- [ ] 전체 통합 테스트 완료

---

**작성자**: Claude Code
**승인**: 사용자 ✅
**다음 작업**: Prisma 스키마 수정부터 시작

**예상 완료일**: 5주 후
**예상 진행률**: 95%
