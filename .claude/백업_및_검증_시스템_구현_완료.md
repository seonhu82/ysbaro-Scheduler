# ë°°ì¹˜ ë°±ì—… ë° ê²€ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-10-25
**ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ
**TypeScript ì˜¤ë¥˜**: 0ê±´

---

## ğŸ“‹ ê°œìš”

ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ëŒ€ë¹„í•˜ì—¬ **ë°°ì¹˜ ë°±ì—…**, **ë³µêµ¬**, **ë³€ê²½ ì¶”ì **, **ê²€ì¦ ê°•í™”** ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### êµ¬í˜„ ëª©ì 

1. **ì•ˆì „ì„±**: ë°°ì¹˜ ë³€ê²½ ì „í›„ ìë™ ë°±ì—…ìœ¼ë¡œ ì–¸ì œë“  ë³µêµ¬ ê°€ëŠ¥
2. **ì¶”ì ì„±**: ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì´ë ¥ ì™„ì „ ì¶”ì  ë° ì˜í–¥ ë²”ìœ„ íŒŒì•…
3. **ìë™í™”**: ë³€ê²½ ê°ì§€ ì‹œ ìë™ ì¬ë°°ì¹˜ ìˆ˜í–‰
4. **ê²€ì¦**: 5ë‹¨ê³„ ê²€ì¦ìœ¼ë¡œ ë°°ì¹˜ ì˜¤ë¥˜ ì‚¬ì „ íƒì§€ ë° ìë™ ìˆ˜ì •

---

## ğŸ—‚ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì¶”ê°€

### 1. WeeklyAssignmentBackup (ë°°ì¹˜ ë°±ì—…)

```prisma
model WeeklyAssignmentBackup {
  id          String   @id @default(cuid())
  weekInfoId  String
  weekInfo    WeekInfo @relation(...)

  // ë°±ì—… ë©”íƒ€ë°ì´í„°
  backupType  String // 'AUTO_BEFORE_ASSIGN', 'AUTO_AFTER_ASSIGN', 'MANUAL', 'BEFORE_LEAVE_CHANGE'
  description String?  @db.Text
  createdBy   String? // User ID
  createdAt   DateTime @default(now())

  // ë°±ì—…ëœ ë°°ì¹˜ ë°ì´í„° (JSON)
  assignments Json // { "2025-10-28": [{ staffId, staffName, category }, ...], ... }

  // ë°±ì—…ëœ í˜•í‰ì„± ì ìˆ˜ ìŠ¤ëƒ…ìƒ·
  fairnessScores Json? // [{ staffId, staffName, nightShift, weekend, holiday, ... }, ...]

  // ë³µêµ¬ ê´€ë ¨
  restoredAt  DateTime?
  restoredBy  String? // User ID

  @@index([weekInfoId])
  @@index([backupType])
  @@index([createdAt])
}
```

**íŠ¹ì§•**:
- ë°°ì¹˜ ë°ì´í„°ì™€ í˜•í‰ì„± ì ìˆ˜ë¥¼ JSONìœ¼ë¡œ ìŠ¤ëƒ…ìƒ· ì €ì¥
- ë³µêµ¬ ì´ë ¥ ì¶”ì  ê°€ëŠ¥
- ë°±ì—… ìœ í˜•ë³„ ë¶„ë¥˜

### 2. LeaveChangeLog (ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì¶”ì )

```prisma
model LeaveChangeLog {
  id                  String           @id @default(cuid())
  leaveApplicationId  String
  leaveApplication    LeaveApplication @relation(...)

  // ë³€ê²½ íƒ€ì…
  changeType String // 'STATUS_CHANGE', 'DATE_CHANGE', 'DELETION'

  // ë³€ê²½ ì „/í›„ ê°’
  oldStatus  String?
  newStatus  String?
  oldDate    DateTime? @db.Date
  newDate    DateTime? @db.Date

  // ì˜í–¥ë°›ëŠ” ì£¼ì°¨
  affectedWeekIds String[] // [weekInfoId1, weekInfoId2, ...]

  // ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€
  requiresReassignment Boolean  @default(false)
  reassignedAt         DateTime?
  reassignedBy         String? // User ID

  createdAt DateTime @default(now())
  createdBy String? // User ID

  @@index([leaveApplicationId])
  @@index([requiresReassignment])
  @@index([createdAt])
}
```

**íŠ¹ì§•**:
- ëª¨ë“  ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì´ë ¥ ê¸°ë¡
- ì˜í–¥ë°›ëŠ” ì£¼ì°¨ ìë™ íŒŒì•…
- ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€ ìë™ íŒë‹¨

### 3. AssignmentValidationLog (ë°°ì¹˜ ê²€ì¦ ë¡œê·¸)

```prisma
model AssignmentValidationLog {
  id         String   @id @default(cuid())
  weekInfoId String
  weekInfo   WeekInfo @relation(...)

  // ê²€ì¦ íƒ€ì…
  validationType String // 'PRE_ASSIGN', 'POST_ASSIGN', 'PERIODIC_CHECK'

  // ê²½ê³  ë ˆë²¨
  severity String // 'INFO', 'WARNING', 'ERROR', 'CRITICAL'

  // ê²€ì¦ ê²°ê³¼
  issueCount    Int
  criticalCount Int
  warningCount  Int
  infoCount     Int

  // ìƒì„¸ ì´ìŠˆ ëª©ë¡ (JSON)
  issues Json // [{ type, severity, message, staffId, date, ... }, ...]

  // ìë™ ìˆ˜ì • ì‹œë„ ì—¬ë¶€
  autoFixAttempted Boolean   @default(false)
  autoFixSuccess   Boolean?
  autoFixLog       String?   @db.Text

  createdAt DateTime @default(now())

  @@index([weekInfoId])
  @@index([validationType])
  @@index([severity])
  @@index([createdAt])
}
```

**íŠ¹ì§•**:
- ëª¨ë“  ê²€ì¦ ê²°ê³¼ ì´ë ¥ ì €ì¥
- ìë™ ìˆ˜ì • ì‹œë„ ê¸°ë¡
- ì‹œê°„ëŒ€ë³„ ê²€ì¦ ì¶”ì´ ë¶„ì„ ê°€ëŠ¥

---

## ğŸ”§ êµ¬í˜„ëœ ì„œë¹„ìŠ¤

### 1. assignment-backup-service.ts

**ì£¼ìš” í•¨ìˆ˜**:

#### `createWeeklyAssignmentBackup()`
```typescript
// ë°°ì¹˜ ë°±ì—… ìƒì„±
await createWeeklyAssignmentBackup(
  weekInfoId,
  'AUTO_BEFORE_ASSIGN',  // ë°±ì—… ìœ í˜•
  'ìë™ ë°°ì¹˜ ì „ ë°±ì—…',    // ì„¤ëª…
  userId                // ìƒì„±ì (ì„ íƒ)
)
```

**ë°±ì—… ë‚´ìš©**:
- ëª¨ë“  DailyStaffAssignment ë°ì´í„°
- í˜•í‰ì„± ì ìˆ˜ ìŠ¤ëƒ…ìƒ·
- ë©”íƒ€ë°ì´í„° (ë°±ì—… ìœ í˜•, ìƒì„±ì¼ì‹œ, ìƒì„±ì)

#### `restoreWeeklyAssignmentFromBackup()`
```typescript
// ë°±ì—…ì—ì„œ ë³µêµ¬
const result = await restoreWeeklyAssignmentFromBackup(
  backupId,
  userId  // ë³µêµ¬ ì‹¤í–‰ì
)

// ê²°ê³¼
{
  success: true,
  message: "ë°±ì—…ì—ì„œ 84ëª…ì˜ ë°°ì¹˜ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤",
  restoredCount: 84
}
```

**ë³µêµ¬ í”„ë¡œì„¸ìŠ¤**:
1. ê¸°ì¡´ ë°°ì¹˜ ì „ì²´ ì‚­ì œ
2. ë°±ì—… ë°ì´í„°ë¡œ DailyStaffAssignment ì¬ìƒì„±
3. ë³µêµ¬ ì •ë³´ ê¸°ë¡ (restoredAt, restoredBy)
4. WeekInfo ìƒíƒœ COMPLETEDë¡œ ë³€ê²½

#### `compareWithBackup()`
```typescript
// í˜„ì¬ ë°°ì¹˜ì™€ ë°±ì—… ë¹„êµ
const diff = await compareWithBackup(weekInfoId, backupId)

// ê²°ê³¼
{
  added: [    // ë°±ì—… ì´í›„ ì¶”ê°€ëœ ë°°ì¹˜
    { date: "2025-10-28", staffId: "...", staffName: "ê¹€ì² ìˆ˜" }
  ],
  removed: [  // ë°±ì—… ì´í›„ ì œê±°ëœ ë°°ì¹˜
    { date: "2025-10-29", staffId: "...", staffName: "ì´ì˜í¬" }
  ],
  unchanged: 78  // ë³€ê²½ë˜ì§€ ì•Šì€ ë°°ì¹˜ ìˆ˜
}
```

#### `cleanupOldBackups()`
```typescript
// ì˜¤ë˜ëœ ë°±ì—… ìë™ ì •ë¦¬ (ê¸°ë³¸ 5ê°œ ìœ ì§€)
const deletedCount = await cleanupOldBackups(weekInfoId, 5)
```

---

### 2. leave-change-tracking-service.ts

**ì£¼ìš” í•¨ìˆ˜**:

#### `logLeaveChange()`
```typescript
// ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ë¡œê·¸ ìƒì„±
const changeLogId = await logLeaveChange({
  leaveApplicationId: "...",
  changeType: 'STATUS_CHANGE',
  oldStatus: 'PENDING',
  newStatus: 'CONFIRMED',
  createdBy: userId
})
```

**ìë™ ë¶„ì„**:
- ë³€ê²½ìœ¼ë¡œ ì˜í–¥ë°›ëŠ” ì£¼ì°¨ ìë™ íŒŒì•…
- ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€ ìë™ íŒë‹¨

**ì¬ë°°ì¹˜ í•„ìš” íŒë‹¨ ë¡œì§**:
| ë³€ê²½ íƒ€ì… | ì¡°ê±´ | ì¬ë°°ì¹˜ í•„ìš” |
|----------|------|------------|
| STATUS_CHANGE | PENDING â†’ CONFIRMED | âœ… ì˜ˆ |
| STATUS_CHANGE | CONFIRMED â†’ REJECTED/CANCELLED | âœ… ì˜ˆ |
| STATUS_CHANGE | PENDING â†’ REJECTED/CANCELLED | âŒ ì•„ë‹ˆì˜¤ |
| DATE_CHANGE | ëª¨ë“  ê²½ìš° | âœ… ì˜ˆ |
| DELETION | CONFIRMED ìƒíƒœì˜€ë˜ ê²½ìš° | âœ… ì˜ˆ |

#### `performAutoReassignment()`
```typescript
// ì˜í–¥ë°›ëŠ” ì£¼ì°¨ ìë™ ì¬ë°°ì¹˜
const result = await performAutoReassignment(
  changeLogId,
  userId
)

// ê²°ê³¼
{
  success: true,
  message: "ì¬ë°°ì¹˜ ì™„ë£Œ: ì„±ê³µ 2ê°œ, ì‹¤íŒ¨ 0ê°œ",
  results: [
    {
      weekInfoId: "...",
      success: true,
      message: "ì£¼ê°„ ë°°ì¹˜ ì™„ë£Œ: 84ëª… ë°°ì¹˜, 0ê±´ì˜ ê²½ë¯¸í•œ ì´ìŠˆ"
    }
  ]
}
```

**ì¬ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤**:
1. ì¬ë°°ì¹˜ ì „ ìë™ ë°±ì—… ìƒì„±
2. ê° ì˜í–¥ë°›ëŠ” ì£¼ì°¨ì— ëŒ€í•´ `autoAssignWeeklySchedule()` ì‹¤í–‰
3. ê²°ê³¼ ê¸°ë¡ (ì„±ê³µ/ì‹¤íŒ¨)
4. ë³€ê²½ ë¡œê·¸ ì—…ë°ì´íŠ¸ (reassignedAt, reassignedBy)

#### `handleLeaveChange()` (í†µí•© í•¨ìˆ˜)
```typescript
// ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì‹œ í•œ ë²ˆì— ì²˜ë¦¬
const result = await handleLeaveChange({
  leaveApplicationId: "...",
  changeType: 'STATUS_CHANGE',
  oldData: { status: 'PENDING' },
  newData: { status: 'CONFIRMED' },
  userId,
  autoReassign: true  // ìë™ ì¬ë°°ì¹˜ ì‹¤í–‰ ì—¬ë¶€
})

// ê²°ê³¼
{
  changeLogId: "...",
  reassignmentTriggered: true,  // ì¬ë°°ì¹˜ ì‹¤í–‰ë¨
  reassignmentResults: { ... }  // ì¬ë°°ì¹˜ ê²°ê³¼
}
```

---

### 3. assignment-validation-service.ts

**ì£¼ìš” í•¨ìˆ˜**:

#### `validateWeeklyAssignment()`
```typescript
// ì£¼ê°„ ë°°ì¹˜ ê²€ì¦
const result = await validateWeeklyAssignment(
  weekInfoId,
  'POST_ASSIGN',  // ê²€ì¦ íƒ€ì…
  true            // ìë™ ìˆ˜ì • ì‹œë„
)

// ê²°ê³¼
{
  success: true,  // CRITICAL ì´ìŠˆ ì—†ìŒ
  issues: [
    {
      type: 'STAFF_SHORTAGE',
      severity: 'WARNING',
      staffId: "...",
      staffName: "ê¹€ì² ìˆ˜",
      message: "ê¹€ì² ìˆ˜: ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡± (3/4ì¼, ë¶€ì¡± 1ì¼)",
      suggestion: "ì¶”ê°€ ë°°ì¹˜ ê°€ëŠ¥ ë‚ ì§œ í™•ì¸ ë˜ëŠ” ë‹¤ìŒ ì£¼ ì¡°ì •"
    }
  ],
  criticalCount: 0,
  warningCount: 1,
  infoCount: 0,
  autoFixSuccess: false,  // ìë™ ìˆ˜ì • ì‹œë„ ê²°ê³¼
  autoFixLog: "..."
}
```

**5ë‹¨ê³„ ê²€ì¦**:

1. **ìŠ¬ë¡¯ ì¸ì› ê²€ì¦**
   - ë°°ì¹˜ ì¸ì› ë¶€ì¡±/ì´ˆê³¼ í™•ì¸
   - Severity: CRITICAL (ë¶€ì¡±), WARNING (ì´ˆê³¼)

2. **ì§ì›ë³„ ê·¼ë¬´ì¼ìˆ˜ ê²€ì¦**
   - ì£¼4ì¼/ì£¼5ì¼ ìš”êµ¬ì‚¬í•­ ì¶©ì¡± í™•ì¸
   - ì—°ì°¨/ì˜¤í”„ í¬í•¨ ê³„ì‚°
   - Severity: WARNING (ë¶€ì¡± 2ì¼ ì´ìƒ), INFO (ë¶€ì¡± 1ì¼)

3. **ì¤‘ë³µ ë°°ì¹˜ ê²€ì¦**
   - ê°™ì€ ë‚ ì§œì— ì¤‘ë³µ ë°°ì¹˜ í™•ì¸
   - Severity: CRITICAL

4. **ì¹´í…Œê³ ë¦¬ë³„ ì¸ì› ê²€ì¦**
   - ì¹´í…Œê³ ë¦¬ë³„ í•„ìš” ì¸ì› ì¶©ì¡± í™•ì¸
   - Severity: WARNING

5. **ì—°ì°¨/ì˜¤í”„ ì¶©ëŒ ê²€ì¦**
   - CONFIRMED ìƒíƒœì¸ë° ë°°ì¹˜ëœ ê²½ìš°
   - Severity: CRITICAL

**ìë™ ìˆ˜ì •**:
- CRITICAL ì´ìŠˆë§Œ ìë™ ìˆ˜ì • ì‹œë„
- ì¤‘ë³µ ë°°ì¹˜: ì²« ë²ˆì§¸ë§Œ ë‚¨ê¸°ê³  ì œê±°
- ì—°ì°¨/ì˜¤í”„ ì¶©ëŒ: ë°°ì¹˜ ì œê±°

#### `validateAllWeeksInMonth()`
```typescript
// ì›” ì „ì²´ ì£¼ì°¨ ê²€ì¦
const result = await validateAllWeeksInMonth(
  clinicId,
  2025,
  10
)

// ê²°ê³¼
{
  totalWeeks: 4,
  validWeeks: 3,
  invalidWeeks: [
    {
      weekInfoId: "...",
      weekNumber: 2,
      issueCount: 3
    }
  ]
}
```

---

## ğŸ”„ ì£¼ê°„ ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ í†µí•©

`weekly-assign-v2.ts`ì— ë°±ì—… ë° ê²€ì¦ ìë™í™”:

```typescript
export async function autoAssignWeeklySchedule(weekInfoId: string) {
  try {
    // === 1. ë°°ì¹˜ ì „ ìë™ ë°±ì—… ===
    await createWeeklyAssignmentBackup(
      weekInfoId,
      'AUTO_BEFORE_ASSIGN',
      `ìë™ ë°°ì¹˜ ì‹¤í–‰ ì „ ë°±ì—… (${new Date().toLocaleString('ko-KR')})`
    )

    // === 2. ë°°ì¹˜ ì‹¤í–‰ (Phase 1-10) ===
    // ... ê¸°ì¡´ ë°°ì¹˜ ë¡œì§

    // === 3. ë°°ì¹˜ ì„±ê³µ ì‹œ ===
    if (!hasCriticalIssues) {
      // 3-1. í˜•í‰ì„± ì ìˆ˜ ì—…ë°ì´íŠ¸
      await updateFairnessScoresAfterAssignment(weekInfoId)

      // 3-2. ë°°ì¹˜ í›„ ìë™ ë°±ì—…
      await createWeeklyAssignmentBackup(
        weekInfoId,
        'AUTO_AFTER_ASSIGN',
        `ìë™ ë°°ì¹˜ ì™„ë£Œ í›„ ë°±ì—…`
      )

      // 3-3. ë°°ì¹˜ í›„ ìë™ ê²€ì¦
      const validation = await validateWeeklyAssignment(
        weekInfoId,
        'POST_ASSIGN',
        true  // ìë™ ìˆ˜ì • ì‹œë„
      )

      // ê²€ì¦ ê²°ê³¼ ë¡œê¹…
      if (validation.criticalCount > 0) {
        console.log(`âš ï¸ ê²€ì¦ì—ì„œ ${validation.criticalCount}ê±´ì˜ CRITICAL ì´ìŠˆ ë°œê²¬`)
        console.log(`ìë™ ìˆ˜ì • ${validation.autoFixSuccess ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`)
      }
    }

    return result
  } catch (error) {
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒíƒœ ë¡¤ë°±
    await updateWeekStatus(weekInfoId, 'DRAFT')
    throw error
  }
}
```

---

## ğŸ“Š ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë°°ì¹˜ í›„ ë¬¸ì œ ë°œê²¬ ì‹œ ë³µêµ¬

```typescript
// 1. ë¬¸ì œ ë°œê²¬
const backups = await getWeeklyBackups(weekInfoId)
// [
//   { id: "backup1", backupType: "AUTO_AFTER_ASSIGN", createdAt: "..." },
//   { id: "backup2", backupType: "AUTO_BEFORE_ASSIGN", createdAt: "..." }
// ]

// 2. ë°±ì—…ê³¼ ë¹„êµ
const diff = await compareWithBackup(weekInfoId, "backup1")
// ë³€ê²½ ì‚¬í•­ í™•ì¸

// 3. ë³µêµ¬ ê²°ì • ì‹œ
const result = await restoreWeeklyAssignmentFromBackup("backup2", userId)
// âœ… ë°°ì¹˜ ì „ ìƒíƒœë¡œ ë³µêµ¬ ì™„ë£Œ
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì—°ì°¨ ìŠ¹ì¸ ì‹œ ìë™ ì¬ë°°ì¹˜

```typescript
// ì—°ì°¨ ì‹ ì²­ ìƒíƒœ ë³€ê²½ (PENDING â†’ CONFIRMED)
const result = await handleLeaveChange({
  leaveApplicationId: "...",
  changeType: 'STATUS_CHANGE',
  oldData: { status: 'PENDING' },
  newData: { status: 'CONFIRMED' },
  userId,
  autoReassign: true
})

// ìë™ ì‹¤í–‰ëœ ì‘ì—…:
// 1. âœ… ë³€ê²½ ë¡œê·¸ ìƒì„±
// 2. âœ… ì˜í–¥ë°›ëŠ” ì£¼ì°¨ íŒŒì•… (1ê°œ)
// 3. âœ… ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€ íŒë‹¨ (í•„ìš”)
// 4. âœ… ì¬ë°°ì¹˜ ì „ ë°±ì—… ìƒì„±
// 5. âœ… ìë™ ì¬ë°°ì¹˜ ì‹¤í–‰
// 6. âœ… ì¬ë°°ì¹˜ ê²°ê³¼ ê¸°ë¡
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì£¼ê¸°ì  ê²€ì¦

```typescript
// ë§¤ì¼ ìë™ ì‹¤í–‰ (cron job)
const result = await validateAllWeeksInMonth(clinicId, 2025, 10)

if (result.invalidWeeks.length > 0) {
  // ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
  for (const week of result.invalidWeeks) {
    const validation = await validateWeeklyAssignment(
      week.weekInfoId,
      'PERIODIC_CHECK',
      true  // ìë™ ìˆ˜ì • ì‹œë„
    )

    if (validation.autoFixSuccess) {
      // âœ… ìë™ ìˆ˜ì • ì™„ë£Œ
    } else {
      // âš ï¸ ê´€ë¦¬ì ê°œì… í•„ìš”
    }
  }
}
```

---

## âœ… êµ¬í˜„ ê²°ê³¼

| í•­ëª© | ê²°ê³¼ |
|------|------|
| **ìƒˆ ëª¨ë¸** | 3ê°œ (WeeklyAssignmentBackup, LeaveChangeLog, AssignmentValidationLog) |
| **ìƒˆ ì„œë¹„ìŠ¤ íŒŒì¼** | 3ê°œ (backup, leave-change, validation) |
| **ìƒˆ í•¨ìˆ˜** | 15ê°œ |
| **ì½”ë“œ ë¼ì¸ ìˆ˜** | 950+ ë¼ì¸ |
| **TypeScript ì˜¤ë¥˜** | 0ê±´ âœ… |
| **ë§ˆì´ê·¸ë ˆì´ì…˜** | 1ê°œ (20251025103814) |

---

## ğŸ¯ í•µì‹¬ ê¸°ëŠ¥ ìš”ì•½

### 1. ìë™ ë°±ì—…
- âœ… ë°°ì¹˜ ì „ ìë™ ë°±ì—…
- âœ… ë°°ì¹˜ í›„ ìë™ ë°±ì—…
- âœ… ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì‹œ ìë™ ë°±ì—…
- âœ… ìˆ˜ë™ ë°±ì—… ì§€ì›
- âœ… ë°±ì—… ë¹„êµ ê¸°ëŠ¥
- âœ… ì˜¤ë˜ëœ ë°±ì—… ìë™ ì •ë¦¬

### 2. ì—°ì°¨/ì˜¤í”„ ì¶”ì 
- âœ… ëª¨ë“  ë³€ê²½ ì´ë ¥ ê¸°ë¡
- âœ… ì˜í–¥ë°›ëŠ” ì£¼ì°¨ ìë™ íŒŒì•…
- âœ… ì¬ë°°ì¹˜ í•„ìš” ì—¬ë¶€ ìë™ íŒë‹¨
- âœ… ìë™ ì¬ë°°ì¹˜ ì‹¤í–‰
- âœ… ë¯¸ì²˜ë¦¬ ì¬ë°°ì¹˜ ëª©ë¡ ì¡°íšŒ

### 3. ë°°ì¹˜ ê²€ì¦
- âœ… 5ë‹¨ê³„ ê²€ì¦ (ìŠ¬ë¡¯, ê·¼ë¬´ì¼ìˆ˜, ì¤‘ë³µ, ì¹´í…Œê³ ë¦¬, ì—°ì°¨ì¶©ëŒ)
- âœ… ìë™ ìˆ˜ì • ê¸°ëŠ¥
- âœ… ê²€ì¦ ì´ë ¥ ì €ì¥
- âœ… ì›” ì „ì²´ ê²€ì¦ ì§€ì›
- âœ… ì‹¬ê°ë„ë³„ ë¶„ë¥˜ (CRITICAL, WARNING, INFO)

### 4. ë³µêµ¬
- âœ… ë°±ì—…ì—ì„œ ì™„ì „ ë³µêµ¬
- âœ… ë³µêµ¬ ì´ë ¥ ì¶”ì 
- âœ… íŠ¸ëœì­ì…˜ ì•ˆì „ì„± ë³´ì¥

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒì‚¬í•­)

1. **API ë¼ìš°íŠ¸ ì¶”ê°€**
   - POST /api/schedule/backup - ìˆ˜ë™ ë°±ì—…
   - POST /api/schedule/restore - ë³µêµ¬
   - GET /api/schedule/validate - ê²€ì¦
   - GET /api/schedule/leave-changes - ë³€ê²½ ì´ë ¥

2. **ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ**
   - ë°±ì—… ëª©ë¡ ë° ë³µêµ¬ UI
   - ê²€ì¦ ê²°ê³¼ ì‹œê°í™”
   - ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì´ë ¥ ì¡°íšŒ
   - ìë™ ìˆ˜ì • ë¡œê·¸ í™•ì¸

3. **ì•Œë¦¼ ì‹œìŠ¤í…œ**
   - CRITICAL ì´ìŠˆ ë°œê²¬ ì‹œ ì¦‰ì‹œ ì•Œë¦¼
   - ì¬ë°°ì¹˜ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
   - ì£¼ê¸°ì  ê²€ì¦ ê²°ê³¼ ìš”ì•½ ì•Œë¦¼

---

## ğŸ“ ì‚¬ìš© ì˜ˆì‹œ

### LeaveApplication APIì—ì„œ ì‚¬ìš©

```typescript
// src/app/api/leave-applications/[id]/route.ts
import { handleLeaveChange } from '@/lib/services/leave-change-tracking-service'

export async function PATCH(request: Request, { params }: { params: { id: string } }) {
  const session = await auth()
  const body = await request.json()
  const { status } = body

  // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
  const oldLeave = await prisma.leaveApplication.findUnique({
    where: { id: params.id }
  })

  // ìƒíƒœ ì—…ë°ì´íŠ¸
  const updatedLeave = await prisma.leaveApplication.update({
    where: { id: params.id },
    data: { status }
  })

  // ë³€ê²½ ì¶”ì  ë° ìë™ ì¬ë°°ì¹˜
  const result = await handleLeaveChange({
    leaveApplicationId: params.id,
    changeType: 'STATUS_CHANGE',
    oldData: { status: oldLeave.status },
    newData: { status },
    userId: session.user.id,
    autoReassign: true
  })

  return NextResponse.json({
    success: true,
    data: updatedLeave,
    reassignment: result.reassignmentTriggered ? result.reassignmentResults : null
  })
}
```

---

**ìƒíƒœ**: ğŸŸ¢ í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ

ëª¨ë“  ë°±ì—…, ë³µêµ¬, ì¶”ì , ê²€ì¦ ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ì–´ ì‹¤ì œ ì—°ì°¨/ì˜¤í”„ ë³€ê²½ ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì— ì™„ë²½íˆ ëŒ€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!
