# ì—°ì„¸ë°”ë¡œì¹˜ê³¼ ìŠ¤ì¼€ì¤„ëŸ¬ - ë°°ì¹˜ ì‹œìŠ¤í…œ ì™„ì „ ì¬ì„¤ê³„

**ì‘ì„±ì¼**: 2025-10-25
**ì¤‘ìš”ë„**: ğŸ”´ CRITICAL - í˜„ì¬ êµ¬í˜„ì€ ì‹¤ì œ ì‚¬ìš© ë¶ˆê°€

---

## âš ï¸ í˜„ì¬ ë¬¸ì œì 

í˜„ì¬ êµ¬í˜„ëœ `autoAssignSingleSlot()` ë°©ì‹:
- âŒ **ì¼ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ë°°ì¹˜** â†’ ì£¼ê°„ ì „ì²´ë¥¼ ê³ ë ¤í•˜ì§€ ì•ŠìŒ
- âŒ **ì£¼ 4ì¼/5ì¼ ê·¼ë¬´ ë³´ì¥ ì•ˆ ë¨** â†’ ì–´ë–¤ ì§ì›ì€ 2ì¼ë§Œ, ì–´ë–¤ ì§ì›ì€ 6ì¼ ê·¼ë¬´ ê°€ëŠ¥
- âŒ **í˜•í‰ì„± ì„¤ì • ë¬´ì‹œ** â†’ ëª¨ë“  ìœ í˜•(ì•¼ê°„/ì£¼ë§/ê³µíœ´ì¼/ê³µíœ´ì¼ì „í›„)ì„ ë¬´ì¡°ê±´ ì ìš©
- âŒ **ìŠ¹ì¸ëœ ì—°ì°¨/ì˜¤í”„ ë°˜ì˜ ì•ˆ ë¨** â†’ ë°°ì¹˜ ì‹œ ì œì™¸ëŠ” í•˜ì§€ë§Œ ìŠ¬ë¡¯ ê³„ì‚° ì•ˆ ë¨
- âŒ **ê²€ì¦ ë° ì¡°ìœ¨ ë¡œì§ ì—†ìŒ** â†’ ë°°ì¹˜ í›„ ë¬¸ì œê°€ ìˆì–´ë„ ê·¸ëŒ€ë¡œ ì €ì¥

---

## ğŸ¯ ì˜¬ë°”ë¥¸ ë°°ì¹˜ ë¡œì§ (ì£¼ë³„ ë°°ì¹˜)

### ì „ì œ ì¡°ê±´

1. **ì£¼ ë‹¨ìœ„ ë°°ì¹˜**: ì›”~í† ìš”ì¼ (6ì¼)ì„ í•˜ë‚˜ì˜ ì£¼ë¡œ ë°°ì¹˜
2. **ì§ì› ê·¼ë¬´ ì¼ìˆ˜ ë³´ì¥**:
   - ì£¼4ì¼ ì§ì›: ì£¼ë‹¹ 4ì¼ ê·¼ë¬´ (2ì¼ ì˜¤í”„)
   - ì£¼5ì¼ ì§ì›: ì£¼ë‹¹ 5ì¼ ê·¼ë¬´ (1ì¼ ì˜¤í”„)
3. **í˜•í‰ì„± ì„¤ì • ì ìš©**:
   ```typescript
   FairnessSettings {
     enableNightShiftFairness: true/false      // ì•¼ê°„ í˜•í‰ì„±
     enableWeekendFairness: true/false         // ì£¼ë§(í† ) í˜•í‰ì„±
     enableHolidayFairness: true/false         // ê³µíœ´ì¼ í˜•í‰ì„±
     enableHolidayAdjacentFairness: true/false // ê³µíœ´ì¼ ì „í›„ í˜•í‰ì„±
   }
   ```
4. **ì—°ì°¨/ì˜¤í”„ ìš°ì„  ì ìš©**: CONFIRMED ìƒíƒœ ì‹ ì²­ì€ ë¬´ì¡°ê±´ ë°˜ì˜

---

## ğŸ“‹ ì£¼ë³„ ë°°ì¹˜ 14ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤

### Phase 1: ì¤€ë¹„ ë‹¨ê³„ (1-3ë‹¨ê³„)

#### **1ë‹¨ê³„: ì£¼ì°¨ ì •ë³´ ë° í•„ìš” ì¸ì› ê³„ì‚°**

```typescript
// WeekInfo ì¡°íšŒ
const weekInfo = await prisma.weekInfo.findUnique({
  where: { id: weekInfoId },
  include: {
    dailySlots: {
      orderBy: { date: 'asc' },
      include: {
        staffAssignments: true  // ê¸°ì¡´ ë°°ì¹˜ í™•ì¸
      }
    }
  }
})

// ê° ë‚ ì§œë³„ í•„ìš” ì¸ì› ê³„ì‚°
const dailyRequirements = weekInfo.dailySlots.map(slot => ({
  date: slot.date,
  dayOfWeek: slot.date.getDay(),
  requiredStaff: slot.requiredStaff,  // ì˜ˆ: 14ëª…
  categoryRequirements: calculateCategoryRequirements(
    slot.requiredStaff,
    ratioSettings.ratios
  )
  // ì˜ˆ: { "íŒ€ì¥": 2, "ê³ ë…„ì°¨": 4, "ì¤‘ë…„ì°¨": 5, "ì €ë…„ì°¨": 3 }
}))

// ì£¼ê°„ ì´ í•„ìš” ìŠ¬ë¡¯
const weeklyTotalSlots = dailyRequirements.reduce(
  (sum, day) => sum + day.requiredStaff,
  0
)
// ì˜ˆ: ì›”~í†  ê° 14ëª… â†’ 84 ìŠ¬ë¡¯
```

#### **2ë‹¨ê³„: ìŠ¹ì¸ëœ ì—°ì°¨/ì˜¤í”„ ë°˜ì˜ (ì¸ì› ì œì™¸)**

```typescript
// CONFIRMED ìƒíƒœì˜ ì—°ì°¨/ì˜¤í”„ ì‹ ì²­ ì¡°íšŒ
const confirmedLeaves = await prisma.leaveApplication.findMany({
  where: {
    clinicId,
    date: { in: weekDates },  // í•´ë‹¹ ì£¼ì˜ ëª¨ë“  ë‚ ì§œ
    status: 'CONFIRMED'
  },
  include: {
    staff: {
      select: {
        id: true,
        name: true,
        categoryName: true,
        workType: true
      }
    }
  }
})

// ë‚ ì§œë³„ë¡œ ì œì™¸í•  ì§ì› ëª©ë¡ ìƒì„±
const excludedStaffByDate = new Map<string, Set<string>>()
confirmedLeaves.forEach(leave => {
  const dateKey = leave.date.toISOString().split('T')[0]
  if (!excludedStaffByDate.has(dateKey)) {
    excludedStaffByDate.set(dateKey, new Set())
  }
  excludedStaffByDate.get(dateKey)!.add(leave.staffId)
})

// ê° ë‚ ì§œë³„ ì‹¤ì œ ë°°ì¹˜ ê°€ëŠ¥ ì¸ì› ê³„ì‚°
dailyRequirements.forEach(day => {
  const dateKey = day.date.toISOString().split('T')[0]
  const excludedCount = excludedStaffByDate.get(dateKey)?.size || 0

  day.actualRequired = day.requiredStaff  // ì—¬ì „íˆ 14ëª… í•„ìš”
  day.excludedStaff = excludedStaffByDate.get(dateKey) || new Set()
  day.availableSlots = day.requiredStaff - excludedCount
  // ì˜ˆ: 14ëª… í•„ìš”, 2ëª… ì˜¤í”„ â†’ 12ëª…ë§Œ ë°°ì¹˜ ê°€ëŠ¥
})
```

#### **3ë‹¨ê³„: í˜•í‰ì„± í•„ìš” ë‚ ì§œ ì²´í¬ (ì„¤ì • ê¸°ë°˜)**

```typescript
// í˜•í‰ì„± ì„¤ì • ì¡°íšŒ
const fairnessSettings = await prisma.fairnessSettings.findUnique({
  where: { clinicId }
})

// ê° ë‚ ì§œë³„ë¡œ í˜•í‰ì„± ì ìš© ì—¬ë¶€ íŒë‹¨
for (const day of dailyRequirements) {
  const dayTypes = await classifyDayType(clinicId, day.date)
  const doctorSchedule = day.dailySlot.doctorSchedule as any
  const hasNightShift = doctorSchedule?.night_shift || false

  day.fairnessTypes = []

  // ì„¤ì •ì— ë”°ë¼ í˜•í‰ì„± ìœ í˜• ì¶”ê°€
  if (hasNightShift && fairnessSettings?.enableNightShiftFairness) {
    day.fairnessTypes.push('NIGHT_SHIFT')
  }

  if (dayTypes.includes('SATURDAY') && fairnessSettings?.enableWeekendFairness) {
    day.fairnessTypes.push('WEEKEND')
  }

  if (dayTypes.includes('HOLIDAY') && fairnessSettings?.enableHolidayFairness) {
    day.fairnessTypes.push('HOLIDAY')
  }

  if (
    (dayTypes.includes('HOLIDAY_ADJACENT') || dayTypes.includes('HOLIDAY_ADJACENT_SUNDAY')) &&
    fairnessSettings?.enableHolidayAdjacentFairness
  ) {
    day.fairnessTypes.push('HOLIDAY_ADJACENT')
  }

  day.needsFairness = day.fairnessTypes.length > 0
  day.priority = calculatePriority(day.fairnessTypes)
  // ìš°ì„ ìˆœìœ„: HOLIDAY(4) > HOLIDAY_ADJACENT(3) > WEEKEND(2) > NIGHT_SHIFT(1) > ì¼ë°˜(0)
}

// í˜•í‰ì„± í•„ìš”í•œ ë‚ ë¶€í„° ìš°ì„  ë°°ì¹˜í•˜ë„ë¡ ì •ë ¬
const sortedDays = [...dailyRequirements].sort((a, b) => {
  if (a.priority !== b.priority) {
    return b.priority - a.priority  // ìš°ì„ ìˆœìœ„ ë†’ì€ ë‚ ë¶€í„°
  }
  return a.date.getTime() - b.date.getTime()  // ê°™ìœ¼ë©´ ë‚ ì§œìˆœ
})
```

---

### Phase 2: ìš°ì„  ë°°ì¹˜ ë‹¨ê³„ (4-5ë‹¨ê³„)

#### **4ë‹¨ê³„: í˜•í‰ì„± í•„ìš” ë‚ ì§œ ìš°ì„  ë°°ì¹˜**

```typescript
// ì£¼ê°„ ë°°ì¹˜ ìƒíƒœ ì¶”ì 
const weeklyAssignments = new Map<string, Set<string>>()  // staffId â†’ Set<ë‚ ì§œ>
const staffWorkDayCount = new Map<string, number>()       // staffId â†’ ê·¼ë¬´ì¼ìˆ˜

// í™œì„± ì§ì› ì „ì²´ ì¡°íšŒ (ì£¼ ê·¼ë¬´ì¼ìˆ˜ í¬í•¨)
const allActiveStaff = await prisma.staff.findMany({
  where: {
    clinicId,
    isActive: true
  },
  include: {
    fairnessScores: {
      where: {
        year: weekInfo.year,
        month: weekInfo.month
      }
    }
  }
})

// ê° ì§ì›ì˜ ì´ë²ˆ ì£¼ í•„ìš” ê·¼ë¬´ì¼ìˆ˜ ê³„ì‚°
allActiveStaff.forEach(staff => {
  const requiredDays = staff.workType === 'WEEK_4' ? 4 : 5
  staffWorkDayCount.set(staff.id, requiredDays)
  weeklyAssignments.set(staff.id, new Set())
})

// í˜•í‰ì„± í•„ìš” ë‚ ì§œë¶€í„° ë°°ì¹˜
for (const day of sortedDays.filter(d => d.needsFairness)) {
  console.log(`\në°°ì¹˜: ${day.date} (${day.fairnessTypes.join(', ')})`)

  // êµ¬ë¶„ë³„ ë°°ì¹˜
  for (const [category, required] of Object.entries(day.categoryRequirements)) {
    // í•´ë‹¹ êµ¬ë¶„ ì§ì› ì¤‘ ë°°ì¹˜ ê°€ëŠ¥í•œ ì§ì› ì¡°íšŒ
    const availableStaff = allActiveStaff.filter(staff => {
      // ê¸°ë³¸ ì¡°ê±´
      if (staff.categoryName !== category) return false
      if (!staff.isActive) return false

      // ì´ë¯¸ ì˜¤í”„/ì—°ì°¨ì¸ì§€ í™•ì¸
      const dateKey = day.date.toISOString().split('T')[0]
      if (day.excludedStaff.has(staff.id)) return false

      // ì´ë¯¸ ì´ ë‚ ì§œì— ë°°ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
      const assignedDates = weeklyAssignments.get(staff.id)
      if (assignedDates?.has(dateKey)) return false

      // ì£¼ê°„ ê·¼ë¬´ì¼ìˆ˜ ì²´í¬: ì•„ì§ ê·¼ë¬´ ê°€ëŠ¥í•œì§€
      const assignedCount = assignedDates?.size || 0
      const requiredDays = staffWorkDayCount.get(staff.id) || 4
      if (assignedCount >= requiredDays) return false

      return true
    })

    // í˜•í‰ì„± ì ìˆ˜ ê¸°ë°˜ ì •ë ¬
    const staffWithScores = availableStaff.map(staff => {
      const fairnessScore = staff.fairnessScores[0]
      let score = 0

      // ë‚ ì§œ ìœ í˜•ì— ë”°ë¼ í•´ë‹¹ ì ìˆ˜ ì‚¬ìš©
      if (day.fairnessTypes.includes('HOLIDAY')) {
        score = fairnessScore?.holidayCount || 0
      } else if (day.fairnessTypes.includes('HOLIDAY_ADJACENT')) {
        score = fairnessScore?.holidayAdjacentCount || 0
      } else if (day.fairnessTypes.includes('WEEKEND')) {
        score = fairnessScore?.weekendCount || 0
      } else if (day.fairnessTypes.includes('NIGHT_SHIFT')) {
        score = fairnessScore?.nightShiftCount || 0
      }

      return { staff, score }
    })

    // ì ìˆ˜ ë‚®ì€ ìˆœ ì •ë ¬ (í˜•í‰ì„±: ì ê²Œ ê·¼ë¬´í•œ ì‚¬ëŒ ìš°ì„ )
    staffWithScores.sort((a, b) => {
      if (a.score !== b.score) return a.score - b.score
      // ì ìˆ˜ ê°™ìœ¼ë©´ ì´ë²ˆ ì£¼ ëœ ê·¼ë¬´í•œ ì‚¬ëŒ ìš°ì„ 
      const aCount = weeklyAssignments.get(a.staff.id)?.size || 0
      const bCount = weeklyAssignments.get(b.staff.id)?.size || 0
      return aCount - bCount
    })

    // í•„ìš” ì¸ì›ë§Œí¼ ë°°ì¹˜
    const toAssign = staffWithScores.slice(0, required)
    toAssign.forEach(({ staff }) => {
      const dateKey = day.date.toISOString().split('T')[0]
      weeklyAssignments.get(staff.id)!.add(dateKey)

      // ì„ì‹œ ë°°ì¹˜ ê¸°ë¡
      if (!day.assignments) day.assignments = []
      day.assignments.push({
        staffId: staff.id,
        staffName: staff.name,
        category: staff.categoryName
      })
    })

    // ë¶€ì¡±í•˜ë©´ Flexible Staff í™œìš©
    if (toAssign.length < required) {
      const shortfall = required - toAssign.length
      // ... flexible staff ë¡œì§
    }
  }
}
```

#### **5ë‹¨ê³„: ì „ì²´ ì¸ì› ê·¼ë¬´ì¼ìˆ˜ ë° íœ´ë¬´ì¼ ì²´í¬**

```typescript
// í˜•í‰ì„± ë°°ì¹˜ í›„ ê° ì§ì›ì˜ ìƒíƒœ í™•ì¸
const staffStatus = new Map()

allActiveStaff.forEach(staff => {
  const assignedDates = weeklyAssignments.get(staff.id) || new Set()
  const requiredDays = staffWorkDayCount.get(staff.id) || 4
  const currentDays = assignedDates.size

  // ìŠ¹ì¸ëœ ì—°ì°¨/ì˜¤í”„ ì¼ìˆ˜
  const approvedLeaves = confirmedLeaves.filter(l => l.staffId === staff.id)
  const leaveDays = approvedLeaves.length

  // ì‹¤ì œ ê·¼ë¬´ + ì˜¤í”„/ì—°ì°¨ = ì£¼ ê·¼ë¬´ì¼ìˆ˜ë¥¼ ë§Œì¡±í•˜ëŠ”ì§€
  const totalDays = currentDays + leaveDays
  const needsMore = totalDays < requiredDays
  const shortage = needsMore ? requiredDays - totalDays : 0

  staffStatus.set(staff.id, {
    staff,
    requiredDays,
    assignedDays: currentDays,
    leaveDays,
    totalDays,
    shortage,
    needsMore,
    assignedDates: Array.from(assignedDates)
  })
})

console.log('\n=== ì§ì›ë³„ ê·¼ë¬´ í˜„í™© ===')
staffStatus.forEach((status, staffId) => {
  if (status.needsMore) {
    console.log(`âš ï¸ ${status.staff.name}: ${status.shortage}ì¼ ë¶€ì¡± (${status.assignedDays}/${status.requiredDays})`)
  }
})
```

---

### Phase 3: ë³´ì¶© ë°°ì¹˜ ë‹¨ê³„ (6-7ë‹¨ê³„)

#### **6ë‹¨ê³„: ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡± ì¸ì› ì²´í¬**

```typescript
// ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡±í•œ ì§ì› ëª©ë¡ (ìš°ì„ ìˆœìœ„ë³„ ì •ë ¬)
const underworkedStaff = Array.from(staffStatus.values())
  .filter(s => s.needsMore)
  .sort((a, b) => {
    // 1ìˆœìœ„: ë¶€ì¡± ì¼ìˆ˜ê°€ ë§ì€ ìˆœ
    if (a.shortage !== b.shortage) {
      return b.shortage - a.shortage
    }

    // 2ìˆœìœ„: êµ¬ë¶„ë³„ ìš°ì„ ìˆœìœ„ (íŒ€ì¥ > ê³ ë…„ì°¨ > ì¤‘ë…„ì°¨ > ì €ë…„ì°¨)
    const categoryOrder = {
      'íŒ€ì¥/ì‹¤ì¥': 1,
      'ê³ ë…„ì°¨': 2,
      'ì¤‘ê°„ë…„ì°¨': 3,
      'ì €ë…„ì°¨': 4
    }
    const aOrder = categoryOrder[a.staff.categoryName] || 99
    const bOrder = categoryOrder[b.staff.categoryName] || 99
    return aOrder - bOrder
  })

console.log('\n=== ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡± ì¸ì› (ìš°ì„ ìˆœìœ„ìˆœ) ===')
underworkedStaff.forEach((status, index) => {
  console.log(`${index + 1}. ${status.staff.name} (${status.staff.categoryName}): ${status.shortage}ì¼ ë¶€ì¡±`)
})
```

#### **7ë‹¨ê³„: ë‚˜ë¨¸ì§€ ë‚ ì§œì— ìš°ì„ ìˆœìœ„ë³„ ë°°ì¹˜**

```typescript
// í˜•í‰ì„± ì ìš© ì•ˆ ë˜ëŠ” ì¼ë°˜ ë‚ ì§œë“¤
const remainingDays = sortedDays.filter(d => !d.needsFairness)

for (const day of remainingDays) {
  console.log(`\në°°ì¹˜: ${day.date} (ì¼ë°˜ ë‚ ì§œ)`)

  for (const [category, required] of Object.entries(day.categoryRequirements)) {
    // í•´ë‹¹ êµ¬ë¶„ì˜ ë°°ì¹˜ ê°€ëŠ¥ ì§ì›
    const availableStaff = allActiveStaff.filter(staff => {
      if (staff.categoryName !== category) return false
      if (day.excludedStaff.has(staff.id)) return false

      const dateKey = day.date.toISOString().split('T')[0]
      const assignedDates = weeklyAssignments.get(staff.id)
      if (assignedDates?.has(dateKey)) return false

      const assignedCount = assignedDates?.size || 0
      const requiredDays = staffWorkDayCount.get(staff.id) || 4
      if (assignedCount >= requiredDays) return false

      return true
    })

    // ìš°ì„ ìˆœìœ„ ì •ë ¬:
    // 1. ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡±í•œ ì§ì› ìš°ì„ 
    // 2. êµ¬ë¶„ë³„ ìš°ì„ ìˆœìœ„
    // 3. ì´ë²ˆ ì£¼ ëœ ê·¼ë¬´í•œ ì§ì›
    availableStaff.sort((a, b) => {
      const aStatus = staffStatus.get(a.id)
      const bStatus = staffStatus.get(b.id)

      // 1ìˆœìœ„: ë¶€ì¡± ì¸ì› ìš°ì„ 
      if (aStatus.shortage !== bStatus.shortage) {
        return bStatus.shortage - aStatus.shortage
      }

      // 2ìˆœìœ„: ì´ë²ˆ ì£¼ ì ê²Œ ê·¼ë¬´í•œ ì‚¬ëŒ
      if (aStatus.assignedDays !== bStatus.assignedDays) {
        return aStatus.assignedDays - bStatus.assignedDays
      }

      // 3ìˆœìœ„: ì›” ëˆ„ì  ê·¼ë¬´ì¼ìˆ˜ ì ì€ ì‚¬ëŒ
      const aFairness = a.fairnessScores[0]
      const bFairness = b.fairnessScores[0]
      const aTotal = aFairness?.totalWorkDays || 0
      const bTotal = bFairness?.totalWorkDays || 0
      return aTotal - bTotal
    })

    // ë°°ì¹˜
    const toAssign = availableStaff.slice(0, required)
    toAssign.forEach(staff => {
      const dateKey = day.date.toISOString().split('T')[0]
      weeklyAssignments.get(staff.id)!.add(dateKey)

      if (!day.assignments) day.assignments = []
      day.assignments.push({
        staffId: staff.id,
        staffName: staff.name,
        category: staff.categoryName
      })

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      const status = staffStatus.get(staff.id)
      status.assignedDays++
      status.totalDays++
      status.shortage = Math.max(0, status.requiredDays - status.totalDays)
      status.needsMore = status.shortage > 0
    })
  }
}
```

---

### Phase 4: ê²€ì¦ ë° ì¡°ìœ¨ ë‹¨ê³„ (8-10ë‹¨ê³„)

#### **8ë‹¨ê³„: ë°°ì¹˜ ì¸ë ¥ ê²€ì¦**

```typescript
interface ValidationIssue {
  type: 'SHORTAGE' | 'EXCESS' | 'UNFAIR' | 'MISSING_CATEGORY'
  severity: 'CRITICAL' | 'WARNING' | 'INFO'
  staffId?: string
  staffName?: string
  category?: string
  date?: Date
  message: string
  canAdjust: boolean
  suggestion?: string
}

const validationIssues: ValidationIssue[] = []

// ê²€ì¦ 1: ë¹ ì§„ ì¸ì› ì²´í¬ (ê° ë‚ ì§œë³„ í•„ìš” ì¸ì› ì¶©ì¡± ì—¬ë¶€)
dailyRequirements.forEach(day => {
  for (const [category, required] of Object.entries(day.categoryRequirements)) {
    const assigned = day.assignments?.filter(a => a.category === category).length || 0

    if (assigned < required) {
      validationIssues.push({
        type: 'SHORTAGE',
        severity: 'CRITICAL',
        category,
        date: day.date,
        message: `${day.date.toLocaleDateString()}: ${category} ${required - assigned}ëª… ë¶€ì¡± (${assigned}/${required})`,
        canAdjust: true,
        suggestion: 'Flexible Staff í™œìš© ë˜ëŠ” êµ¬ë¶„ ê°„ ì¡°ìœ¨ ê²€í† '
      })
    }
  }
})

// ê²€ì¦ 2: ì£¼ ê·¼ë¬´ì¼ìˆ˜ ë¯¸ë‹¬/ì´ˆê³¼ ì²´í¬
staffStatus.forEach((status, staffId) => {
  if (status.shortage > 0) {
    validationIssues.push({
      type: 'SHORTAGE',
      severity: 'WARNING',
      staffId,
      staffName: status.staff.name,
      message: `${status.staff.name}: ì£¼ ê·¼ë¬´ì¼ìˆ˜ ${status.shortage}ì¼ ë¶€ì¡± (${status.totalDays}/${status.requiredDays})`,
      canAdjust: true,
      suggestion: 'ë‚¨ì€ ìŠ¬ë¡¯ì— ìš°ì„  ë°°ì¹˜ ë˜ëŠ” ë‹¤ìŒ ì£¼ ë°˜ì˜'
    })
  }

  if (status.totalDays > status.requiredDays) {
    validationIssues.push({
      type: 'EXCESS',
      severity: 'WARNING',
      staffId,
      staffName: status.staff.name,
      message: `${status.staff.name}: ì£¼ ê·¼ë¬´ì¼ìˆ˜ ${status.totalDays - status.requiredDays}ì¼ ì´ˆê³¼ (${status.totalDays}/${status.requiredDays})`,
      canAdjust: true,
      suggestion: 'ì¼ë¶€ ë°°ì¹˜ ì œê±° ë˜ëŠ” ë‹¤ìŒ ì£¼ ë°˜ì˜'
    })
  }
})

// ê²€ì¦ 3: í˜•í‰ì„± ì²´í¬
const fairnessCritical = validationIssues.filter(
  i => i.type === 'UNFAIR' && i.severity === 'CRITICAL'
)
const fairnessWarnings = validationIssues.filter(
  i => i.type === 'UNFAIR' && i.severity === 'WARNING'
)

console.log('\n=== ê²€ì¦ ê²°ê³¼ ===')
console.log(`ğŸ”´ Critical: ${validationIssues.filter(i => i.severity === 'CRITICAL').length}ê±´`)
console.log(`ğŸŸ¡ Warning: ${validationIssues.filter(i => i.severity === 'WARNING').length}ê±´`)
console.log(`ğŸ”µ Info: ${validationIssues.filter(i => i.severity === 'INFO').length}ê±´`)
```

#### **9ë‹¨ê³„: ì¡°ìœ¨ ê°€ëŠ¥ì„± ê²€í†  ë° ì¡°ìœ¨**

```typescript
// Critical ì´ìŠˆë¶€í„° í•´ê²° ì‹œë„
const criticalIssues = validationIssues.filter(i => i.severity === 'CRITICAL')

for (const issue of criticalIssues) {
  console.log(`\nğŸ”´ í•´ê²° ì‹œë„: ${issue.message}`)

  if (issue.type === 'SHORTAGE' && issue.category && issue.date) {
    // ì¸ì› ë¶€ì¡± â†’ Flexible Staff ì¬ì¡°íšŒ ë° ë°°ì¹˜
    const result = await tryFlexibleStaffAssignment(
      issue.category,
      issue.date,
      weeklyAssignments,
      staffStatus
    )

    if (result.success) {
      console.log(`  âœ… í•´ê²°: ${result.assignedStaff.map(s => s.name).join(', ')} ë°°ì¹˜`)
      // ì´ìŠˆ ì œê±°
      const index = validationIssues.indexOf(issue)
      validationIssues.splice(index, 1)
    } else {
      console.log(`  âŒ í•´ê²° ì‹¤íŒ¨: ${result.reason}`)
      issue.canAdjust = false
    }
  }

  if (issue.type === 'SHORTAGE' && issue.staffId) {
    // ê°œì¸ ê·¼ë¬´ì¼ìˆ˜ ë¶€ì¡± â†’ ë¹ˆ ìŠ¬ë¡¯ ì°¾ì•„ì„œ ë°°ì¹˜
    const result = await tryFillStaffShortage(
      issue.staffId,
      dailyRequirements,
      weeklyAssignments,
      staffStatus
    )

    if (result.success) {
      console.log(`  âœ… í•´ê²°: ${result.assignedDates.join(', ')}ì— ë°°ì¹˜`)
      const index = validationIssues.indexOf(issue)
      validationIssues.splice(index, 1)
    } else {
      console.log(`  âŒ í•´ê²° ì‹¤íŒ¨: ${result.reason}`)
      issue.canAdjust = false
    }
  }
}

// Warning ì´ìŠˆëŠ” íƒ€ë‹¹ì„± ê²€í† 
const warningIssues = validationIssues.filter(i => i.severity === 'WARNING')

for (const issue of warningIssues) {
  // íƒ€ë‹¹í•œ ì‚¬ìœ ê°€ ìˆëŠ”ì§€ í™•ì¸
  const isJustified = await checkIfJustified(issue, staffStatus, confirmedLeaves)

  if (isJustified.valid) {
    console.log(`  â„¹ï¸ íƒ€ë‹¹í•¨: ${isJustified.reason}`)
    issue.severity = 'INFO'
  } else {
    console.log(`  âš ï¸ ì¡°ìœ¨ í•„ìš”: ${issue.message}`)
  }
}
```

#### **10ë‹¨ê³„: ë¬¸ì œ í•´ê²° ì—¬ë¶€ íŒë‹¨**

```typescript
const unresolved = validationIssues.filter(i =>
  i.severity === 'CRITICAL' && !i.canAdjust
)

if (unresolved.length === 0) {
  console.log('\nâœ… ëª¨ë“  Critical ì´ìŠˆ í•´ê²° ì™„ë£Œ â†’ ë°°ì¹˜ ì™„ë£Œ')

  // DB ì €ì¥ ì§„í–‰
  await saveWeeklyAssignments(weeklyAssignments, weekInfo)

} else {
  console.log(`\nâŒ ${unresolved.length}ê±´ì˜ ë¯¸í•´ê²° Critical ì´ìŠˆ`)

  // ë¯¸í•´ê²° ì´ìŠˆ ì €ì¥ (ë‹¤ìŒ ì£¼ ë°˜ì˜ìš©)
  await saveUnresolvedIssues({
    weekInfoId,
    issues: unresolved,
    status: 'PENDING_NEXT_WEEK',
    createdAt: new Date()
  })

  console.log('â†’ ì°¨ì£¼ ë°°ì¹˜ ì‹œ ë°˜ì˜ ì˜ˆì •')
}
```

---

### Phase 5: ë°˜ë³µ ë° ë§ˆë¬´ë¦¬ (11-14ë‹¨ê³„)

#### **11ë‹¨ê³„: ë‹¤ìŒ ì£¼ì°¨ ë°°ì¹˜**

```typescript
// ë‹¤ìŒ ì£¼ì°¨ ì •ë³´ ì¡°íšŒ
const nextWeekInfo = await prisma.weekInfo.findFirst({
  where: {
    clinicId,
    year,
    month,
    weekNumber: currentWeekNumber + 1
  }
})

if (nextWeekInfo) {
  console.log(`\n=== ë‹¤ìŒ ì£¼ì°¨ ë°°ì¹˜ ì‹œì‘ (${nextWeekInfo.weekNumber}ì£¼ì°¨) ===`)

  // ì´ì „ ì£¼ ë¯¸í•´ê²° ì´ìŠˆ ë¡œë“œ
  const previousIssues = await loadUnresolvedIssues(weekInfo.id)

  if (previousIssues.length > 0) {
    console.log(`ğŸ“‹ ì´ì „ ì£¼ ë¯¸í•´ê²° ì´ìŠˆ ${previousIssues.length}ê±´ ë°˜ì˜`)
    // ì´ìŠˆë¥¼ ìš°ì„ ìˆœìœ„ë¡œ ë°˜ì˜
  }

  // 11ë‹¨ê³„ë¶€í„° ë°˜ë³µ
  await autoAssignWeeklySchedule({
    clinicId,
    weekInfoId: nextWeekInfo.id,
    previousIssues
  })
}
```

#### **12ë‹¨ê³„: ì›”ë³„ ë°°ì¹˜ ë§ˆë¬´ë¦¬ í›„ ì „ì²´ ê²€í† **

```typescript
// í•´ë‹¹ ì›”ì˜ ëª¨ë“  ì£¼ì°¨ ë°°ì¹˜ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
const monthWeeks = await prisma.weekInfo.findMany({
  where: { clinicId, year, month },
  include: {
    dailySlots: {
      include: {
        staffAssignments: true
      }
    }
  }
})

console.log(`\n=== ${year}ë…„ ${month}ì›” ì „ì²´ ê²€í†  ===`)

// ì›” ì „ì²´ í†µê³„
const monthlyStats = {
  totalWeeks: monthWeeks.length,
  totalDays: monthWeeks.reduce((sum, w) => sum + w.dailySlots.length, 0),
  totalAssignments: monthWeeks.reduce((sum, w) =>
    sum + w.dailySlots.reduce((s, d) => s + d.staffAssignments.length, 0), 0
  ),
  totalStaff: allActiveStaff.length
}

console.log(`ì´ ${monthlyStats.totalWeeks}ì£¼ì°¨, ${monthlyStats.totalDays}ì¼`)
console.log(`ì´ ë°°ì¹˜: ${monthlyStats.totalAssignments}ê±´`)

// ì§ì›ë³„ ì›” ëˆ„ì  ê·¼ë¬´ì¼ìˆ˜ í™•ì¸
const monthlyStaffStats = new Map()

allActiveStaff.forEach(staff => {
  const assignments = monthWeeks.flatMap(w =>
    w.dailySlots.flatMap(d =>
      d.staffAssignments.filter(a => a.staffId === staff.id)
    )
  )

  const workDays = assignments.length
  const requiredPerWeek = staff.workType === 'WEEK_4' ? 4 : 5
  const expectedTotal = requiredPerWeek * monthlyStats.totalWeeks
  const difference = workDays - expectedTotal

  monthlyStaffStats.set(staff.id, {
    staff,
    workDays,
    expectedTotal,
    difference,
    percentageOff: (difference / expectedTotal) * 100
  })
})
```

#### **13ë‹¨ê³„: ë¬¸ì œì  í™•ì¸**

```typescript
const monthlyIssues: ValidationIssue[] = []

// ì›” ì „ì²´ í˜•í‰ì„± ì²´í¬
monthlyStaffStats.forEach((stats, staffId) => {
  const absPercentage = Math.abs(stats.percentageOff)

  if (absPercentage > 20) {  // 20% ì´ìƒ ì°¨ì´
    monthlyIssues.push({
      type: 'UNFAIR',
      severity: 'CRITICAL',
      staffId,
      staffName: stats.staff.name,
      message: `${stats.staff.name}: ì›” ê·¼ë¬´ì¼ìˆ˜ ${stats.difference > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'} ${Math.abs(stats.difference)}ì¼ (${stats.percentageOff.toFixed(1)}%)`,
      canAdjust: true,
      suggestion: 'ìµì›”ì— ë³´ìƒ ë°˜ì˜'
    })
  } else if (absPercentage > 10) {  // 10% ì´ìƒ ì°¨ì´
    monthlyIssues.push({
      type: 'UNFAIR',
      severity: 'WARNING',
      staffId,
      staffName: stats.staff.name,
      message: `${stats.staff.name}: ì›” ê·¼ë¬´ì¼ìˆ˜ ${stats.difference > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'} ${Math.abs(stats.difference)}ì¼ (${stats.percentageOff.toFixed(1)}%)`,
      canAdjust: true,
      suggestion: 'ìµì›”ì— ë³´ìƒ ë°˜ì˜'
    })
  }
})

console.log('\n=== ì›”ë³„ ê²€ì¦ ê²°ê³¼ ===')
console.log(`ğŸ”´ Critical: ${monthlyIssues.filter(i => i.severity === 'CRITICAL').length}ê±´`)
console.log(`ğŸŸ¡ Warning: ${monthlyIssues.filter(i => i.severity === 'WARNING').length}ê±´`)
```

#### **14ë‹¨ê³„: ì¡°ìœ¨ ë˜ëŠ” ìµì›” ë°˜ì˜**

```typescript
// ì¡°ìœ¨ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨
const adjustableIssues = monthlyIssues.filter(i => i.canAdjust)

if (adjustableIssues.length > 0) {
  console.log(`\nğŸ“‹ ì¡°ìœ¨ ê°€ëŠ¥ ì´ìŠˆ ${adjustableIssues.length}ê±´`)

  for (const issue of adjustableIssues) {
    // ì›” ë‚´ì—ì„œ ì¡°ìœ¨ ê°€ëŠ¥í•œì§€ í™•ì¸ (ì•„ì§ ë¯¸ë°°ì¹˜ ì£¼ì°¨ê°€ ìˆëŠ”ì§€)
    const hasUnassignedWeeks = monthWeeks.some(w =>
      w.dailySlots.some(d => d.staffAssignments.length < d.requiredStaff)
    )

    if (hasUnassignedWeeks) {
      console.log(`  âœ… ì›” ë‚´ ì¡°ìœ¨ ê°€ëŠ¥: ${issue.message}`)
      // ì¡°ìœ¨ ë¡œì§ ì‹¤í–‰
    } else {
      console.log(`  â„¹ï¸ ìµì›” ë°˜ì˜: ${issue.message}`)

      // ìµì›” ë³´ìƒ ê³„íš ì €ì¥
      await prisma.fairnessAdjustment.create({
        data: {
          staffId: issue.staffId!,
          year: month === 12 ? year + 1 : year,
          month: month === 12 ? 1 : month + 1,
          adjustmentType: issue.type === 'EXCESS' ? 'REDUCE' : 'INCREASE',
          adjustmentDays: Math.abs(monthlyStaffStats.get(issue.staffId!).difference),
          reason: issue.message,
          status: 'PENDING'
        }
      })
    }
  }
}

// ìµœì¢… ì €ì¥ ë° ì™„ë£Œ
await prisma.weekInfo.updateMany({
  where: {
    clinicId,
    year,
    month
  },
  data: {
    status: 'COMPLETED',
    completedAt: new Date()
  }
})

console.log('\nâœ… ì›”ë³„ ë°°ì¹˜ ì™„ë£Œ')
```

---

## ğŸ—‚ï¸ í•„ìš”í•œ ìƒˆ í…Œì´ë¸”/í•„ë“œ

### 1. UnresolvedIssue (ë¯¸í•´ê²° ì´ìŠˆ í…Œì´ë¸”)

```prisma
model UnresolvedIssue {
  id          String   @id @default(cuid())
  weekInfoId  String
  weekInfo    WeekInfo @relation(...)

  issueType   String   // 'SHORTAGE', 'EXCESS', 'UNFAIR'
  severity    String   // 'CRITICAL', 'WARNING', 'INFO'
  staffId     String?
  staff       Staff?   @relation(...)
  category    String?
  date        DateTime?
  message     String
  suggestion  String?

  status      String   // 'PENDING_NEXT_WEEK', 'RESOLVED', 'CARRY_TO_NEXT_MONTH'
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
}
```

### 2. FairnessAdjustment (í˜•í‰ì„± ë³´ìƒ í…Œì´ë¸”)

```prisma
model FairnessAdjustment {
  id             String   @id @default(cuid())
  staffId        String
  staff          Staff    @relation(...)

  year           Int
  month          Int
  adjustmentType String   // 'INCREASE' (ë” ë°°ì¹˜), 'REDUCE' (ëœ ë°°ì¹˜)
  adjustmentDays Int      // ì¡°ì • ì¼ìˆ˜
  reason         String

  status         String   // 'PENDING', 'APPLIED', 'CANCELLED'
  appliedAt      DateTime?
  createdAt      DateTime @default(now())
}
```

### 3. WeekInfoì— status í•„ë“œ ì¶”ê°€

```prisma
model WeekInfo {
  // ê¸°ì¡´ í•„ë“œë“¤...

  status       String?    // 'DRAFT', 'ASSIGNING', 'COMPLETED', 'APPROVED'
  completedAt  DateTime?
  approvedAt   DateTime?
  approvedBy   String?
}
```

---

## ğŸ“ ë‹¤ìŒ ì‘ì—…

ì´ ì¬ì„¤ê³„ì•ˆì„ ì‹¤ì œ ì½”ë“œë¡œ êµ¬í˜„í• ê¹Œìš”? ì•„ë‹ˆë©´ ë” ë””í…Œì¼í•˜ê²Œ ë³´ì™„í•  ë¶€ë¶„ì´ ìˆë‚˜ìš”?
