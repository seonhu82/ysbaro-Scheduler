# í˜•í‰ì„± ê¸°ë°˜ ì˜¤í”„ ì‹ ì²­ ì œí•œ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ

**ì‘ì„±ì¼**: 2025-10-24
**ìƒíƒœ**: í•µì‹¬ ë¡œì§ êµ¬í˜„ ì™„ë£Œ âœ…
**ì§„í–‰ë¥ **: 85% (UI í†µí•© ëŒ€ê¸°)

---

## ğŸ“‹ êµ¬í˜„ ì™„ë£Œ í•­ëª©

### âœ… 1. DB ìŠ¤í‚¤ë§ˆ í™•ì¸
- **FairnessScore** ëª¨ë¸ í™•ì¸ ì™„ë£Œ
  - `year`, `month` í•„ë“œë¡œ ì—°ë³„/ì›”ë³„ ê´€ë¦¬ ê°€ëŠ¥
  - `nightShiftCount`, `weekendCount`, `holidayCount` í•„ë“œë¡œ ì„¸ë¶€ ì¶”ì 
  - `totalScore`ë¡œ ê°€ì¤‘ì¹˜ ì ìš© ì ìˆ˜ ì €ì¥

- **FairnessSettings** ëª¨ë¸ í™•ì¸ ì™„ë£Œ
  - ê°€ì¤‘ì¹˜ ì„¤ì • (ì•¼ê°„ 2.0, ì£¼ë§ 1.5, ê³µíœ´ì¼ 2.0)
  - í˜•í‰ì„± ì²´í¬ í™œì„±í™” ì—¬ë¶€
  - í—ˆìš© ì˜¤ì°¨ ì„¤ì • (ê¸°ë³¸ 20%)

---

### âœ… 2. ì—°ë³„ ëˆ„ì  ëª©í‘œ ê³„ì‚° ì„œë¹„ìŠ¤ (YearlyFairnessService)

**íŒŒì¼**: `src/lib/services/yearly-fairness-service.ts`

**í•µì‹¬ ê¸°ëŠ¥**:
1. **ëˆ„ì  ëª©í‘œ ê³„ì‚°** (`calculateCumulativeTarget`)
   - 1ì›”ë¶€í„° í˜„ì¬ ì›”ê¹Œì§€ì˜ ì•¼ê°„/ì£¼ë§ ê·¼ë¬´ ì¼ìˆ˜ ì§‘ê³„
   - ì´ í•„ìš” ì¸ì› Ã· í™œì„± ì§ì› ìˆ˜ = 1ì¸ë‹¹ ëˆ„ì  ëª©í‘œ
   - ì›”ë³„ breakdown ì œê³µ

2. **ì•¼ê°„ ê·¼ë¬´ í˜•í‰ì„± ë¶„ì„** (`getNightShiftFairness`)
   - ì§ì›ë³„ ì‹¤ì  vs ëˆ„ì  ëª©í‘œ ë¹„êµ
   - ìƒíƒœ íŒì •: `behind` (ë¶€ì¡±), `on_track` (ì ì •), `ahead` (ì´ˆê³¼)
   - ìš°ì„ ìˆœìœ„ ê³„ì‚° (diffê°’ ê¸°ë°˜)

3. **ì£¼ë§ ê·¼ë¬´ í˜•í‰ì„± ë¶„ì„** (`getWeekendWorkFairness`)
   - ì•¼ê°„ê³¼ ë™ì¼í•œ ë¡œì§, ì£¼ë§ ê·¼ë¬´ ê¸°ì¤€

4. **ì¢…í•© ë¦¬í¬íŠ¸** (`getComprehensiveFairnessReport`)
   - ì•¼ê°„ + ì£¼ë§ í†µí•© ë¶„ì„
   - ê¶Œì¥ ì‚¬í•­ ìƒì„± (ìš°ì„  ë°°ì •, ë°°ì • ìì œ)

**í™œìš© ì˜ˆì‹œ**:
```typescript
const report = await yearlyFairnessService.getComprehensiveFairnessReport(2025, 6);

// ê²°ê³¼:
// - nightShift: { employees: { [staffId]: { currentCount, target, diff, status } } }
// - weekendWork: { employees: { [staffId]: { currentCount, target, diff, status } } }
// - recommendations: [{ type, priority, message, employeeIds }]
```

---

### âœ… 3. ì›”ë³„ í˜•í‰ì„± ì ìˆ˜ ê³„ì‚° ì„œë¹„ìŠ¤ (MonthlyFairnessService)

**íŒŒì¼**: `src/lib/services/monthly-fairness-service.ts`

**í•µì‹¬ ê¸°ëŠ¥**:
1. **í˜•í‰ì„± ì„¤ì • ì¡°íšŒ** (`getFairnessSettings`)
   - ë³‘ì›ë³„ ê°€ì¤‘ì¹˜ ë° ì„¤ì • ì¡°íšŒ

2. **ì ìˆ˜ ê³„ì‚°** (`calculateScore`)
   - `totalScore = (nightShift Ã— 2.0) + (weekend Ã— 1.5) + (holiday Ã— 2.0)`

3. **ì›”ë³„ í˜•í‰ì„± ë¶„ì„** (`getMonthlyFairnessAnalysis`)
   - ì „ì²´ ì§ì›ì˜ ì›”ë³„ ì ìˆ˜ ì¡°íšŒ
   - í‰ê·  ì ìˆ˜ ê³„ì‚°
   - ìµœì†Œ/ìµœëŒ€ í—ˆìš© ë²”ìœ„ ê³„ì‚° (í‰ê·  Â± 20%)
   - ê° ì§ì›ì˜ ìƒíƒœ íŒì • (low/normal/high)

4. **ì˜¤í”„ ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€** (`canApplyOff`)
   - íŠ¹ì • ì§ì›ì˜ ì ìˆ˜ê°€ ìµœì†Œ ê¸°ì¤€ ì´í•˜ë©´ ì œí•œ
   - ìƒì„¸ ì •ë³´ ì œê³µ (ë‚´ ì ìˆ˜, í‰ê· , ê·¼ë¬´ íšŸìˆ˜)

**í™œìš© ì˜ˆì‹œ**:
```typescript
const result = await monthlyFairnessService.canApplyOff(
  clinicId,
  staffId,
  2025,
  6,
  'night'
);

// ê²°ê³¼:
// { allowed: false, reason: '...', details: { myScore, averageScore, ... } }
```

---

### âœ… 4. ì¢…í•© í˜•í‰ì„± ë¶„ì„ ì„œë¹„ìŠ¤ (ComprehensiveFairnessService)

**íŒŒì¼**: `src/lib/services/comprehensive-fairness-service.ts`

**í•µì‹¬ ê¸°ëŠ¥**:
1. **ë‚ ì§œ ìœ í˜• íŒë‹¨** (`getDateType`)
   - `NORMAL_WEEKDAY`: í˜•í‰ì„± ì²´í¬ ë¶ˆí•„ìš”
   - `NIGHT_WEEKDAY`: ì•¼ê°„ ê·¼ë¬´ í˜•í‰ì„± ì²´í¬
   - `WEEKEND`: ì£¼ë§ ê·¼ë¬´ í˜•í‰ì„± ì²´í¬
   - `HOLIDAY`: ê³µíœ´ì¼ ê·¼ë¬´ í˜•í‰ì„± ì²´í¬
   - `SUNDAY`: ì „ì› íœ´ë¬´

2. **ì˜¤í”„ ì‹ ì²­ ê²€ì¦** (`validateOffApplication`)
   - **ì—°ë³„ ë¶„ì„**: ëˆ„ì  ëª©í‘œ ëŒ€ë¹„ 2íšŒ ì´ìƒ ë¶€ì¡±í•˜ë©´ ì œí•œ
   - **ì›”ë³„ ë¶„ì„**: í‰ê·  ì ìˆ˜ ì´í•˜ë©´ ì œí•œ
   - ë‘ ì¡°ê±´ ëª¨ë‘ í†µê³¼í•´ì•¼ ì‹ ì²­ ê°€ëŠ¥

3. **ì§ì›ë³„ ì¢…í•© ë¶„ì„** (`getStaffComprehensiveAnalysis`)
   - ì—°ë³„ + ì›”ë³„ í†µí•© ì •ë³´
   - ì¢…í•© ìƒíƒœ: `high_priority`, `normal`, `low_priority`
   - ì•¼ê°„/ì£¼ë§ ì˜¤í”„ ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€

**í™œìš© ì˜ˆì‹œ**:
```typescript
const validation = await comprehensiveFairnessService.validateOffApplication(
  clinicId,
  staffId,
  new Date('2025-11-15'),
  true, // hasNightShift
  false // isHoliday
);

// ê²°ê³¼:
// {
//   allowed: false,
//   requiresFairnessCheck: true,
//   reason: 'YEARLY_FAIRNESS_LOW',
//   message: 'ì˜¬í•´ ì•¼ê°„ ê·¼ë¬´ê°€ ëˆ„ì  ëª©í‘œë³´ë‹¤ ë¶€ì¡±í•˜ì—¬...',
//   details: { yearly: {...}, monthly: {...} }
// }
```

---

### âœ… 5. API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

#### 5.1 ì˜¤í”„ ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
**URL**: `GET /api/fairness/check-eligibility`

**íŒŒë¼ë¯¸í„°**:
- `staffId`: ì§ì› ID
- `date`: ì‹ ì²­ ë‚ ì§œ (YYYY-MM-DD)
- `clinicId`: ë³‘ì› ID

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "success": true,
  "allowed": false,
  "requiresFairnessCheck": true,
  "reason": "YEARLY_FAIRNESS_LOW",
  "message": "ì˜¬í•´ ì•¼ê°„ ê·¼ë¬´ê°€ ëˆ„ì  ëª©í‘œë³´ë‹¤ ë¶€ì¡±í•˜ì—¬ í•´ë‹¹ ë‚ ì§œ ì˜¤í”„ë¥¼ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
  "details": {
    "yearly": {
      "cumulativeTarget": 35.2,
      "currentCount": 30,
      "diff": -5.2,
      "status": "behind"
    },
    "monthly": {
      "myScore": 6.0,
      "averageScore": 10.0,
      "minRequired": 8.0,
      "nightShiftCount": 2,
      "weekendCount": 1,
      "holidayCount": 0
    }
  }
}
```

#### 5.2 ì§ì›ë³„ ì¢…í•© ë¶„ì„
**URL**: `GET /api/fairness/staff-analysis`

**íŒŒë¼ë¯¸í„°**:
- `staffId`: ì§ì› ID
- `year`: ì—°ë„
- `month`: ì›”
- `clinicId`: ë³‘ì› ID

**ì‘ë‹µ**: ì§ì›ë³„ ì—°ë³„/ì›”ë³„ í†µí•© ë¶„ì„ ê²°ê³¼

#### 5.3 ì „ì²´ ì§ì› ë¶„ì„ (ê´€ë¦¬ììš©)
**URL**: `GET /api/fairness/all-staff-analysis`

**íŒŒë¼ë¯¸í„°**:
- `year`: ì—°ë„
- `month`: ì›”
- `clinicId`: ë³‘ì› ID

**ì‘ë‹µ**: ì „ì²´ ì§ì› ë¶„ì„ + ê¶Œì¥ ì‚¬í•­

---

## ğŸ“Š ì‹œìŠ¤í…œ ë™ì‘ ë°©ì‹

### ì˜¤í”„ ì‹ ì²­ í”„ë¡œì„¸ìŠ¤

```
ì§ì›ì´ ë‚ ì§œ ì„ íƒ
     â†“
ë‚ ì§œ ìœ í˜• íŒë‹¨
     â†“
í˜•í‰ì„± ì²´í¬ í•„ìš”?
     â†“ YES
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ë‹¨ê³„: ì—°ë³„ ëˆ„ì  ëª©í‘œ ì²´í¬    â”‚
â”‚  - ëˆ„ì  ëª©í‘œ ëŒ€ë¹„ -2íšŒ ì´í•˜?  â”‚
â”‚  â†’ YES: ì œí•œ âŒ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ NO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ë‹¨ê³„: ì›”ë³„ í‰ê·  ì ìˆ˜ ì²´í¬    â”‚
â”‚  - í‰ê· ì˜ 80% ì´í•˜?          â”‚
â”‚  â†’ YES: ì œí•œ âŒ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ NO
ì‹ ì²­ ê°€ëŠ¥ âœ…
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ (UI í†µí•©)

### 1. ê³µìš© ì‹ ì²­ í˜ì´ì§€ í†µí•©
**íŒŒì¼**: `src/app/(public)/leave-apply/[token]/page.tsx`

**ì‘ì—… ë‚´ìš©**:
1. ë‚ ì§œ ì„ íƒ ì‹œ ì‹¤ì‹œê°„ í˜•í‰ì„± ì²´í¬
2. API í˜¸ì¶œ: `/api/fairness/check-eligibility`
3. ì œí•œ ë©”ì‹œì§€ í‘œì‹œ (ìƒì„¸ ì •ë³´ í¬í•¨)
4. ì‹ ì²­ ê°€ëŠ¥ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€

**UI ì»´í¬ë„ŒíŠ¸ ì˜ˆì‹œ**:
```tsx
// src/components/leave-apply/FairnessInfo.tsx
export function FairnessInfo({ staffId, date, clinicId }) {
  const [eligibility, setEligibility] = useState(null);

  useEffect(() => {
    fetch(`/api/fairness/check-eligibility?staffId=${staffId}&date=${date}&clinicId=${clinicId}`)
      .then(res => res.json())
      .then(data => setEligibility(data));
  }, [staffId, date, clinicId]);

  if (!eligibility?.requiresFairnessCheck) return null;

  if (!eligibility.allowed) {
    return (
      <Alert variant="warning">
        <AlertTitle>âš ï¸ ì˜¤í”„ ì‹ ì²­ ì œí•œ</AlertTitle>
        <AlertDescription>
          {eligibility.message}
          <div className="mt-2">
            <p>ì—°ë³„ ë¶„ì„:</p>
            <p>- ëˆ„ì  ëª©í‘œ: {eligibility.details.yearly.cumulativeTarget}íšŒ</p>
            <p>- í˜„ì¬ ì‹¤ì : {eligibility.details.yearly.currentCount}íšŒ</p>
            <p>- ì°¨ì´: {eligibility.details.yearly.diff}íšŒ</p>
          </div>
          <div className="mt-2">
            <p>ì›”ë³„ ë¶„ì„:</p>
            <p>- ë‚´ ì ìˆ˜: {eligibility.details.monthly.myScore}ì </p>
            <p>- í‰ê· : {eligibility.details.monthly.averageScore}ì </p>
            <p>- ì•¼ê°„: {eligibility.details.monthly.nightShiftCount}íšŒ</p>
          </div>
        </AlertDescription>
      </Alert>
    );
  }

  return (
    <Alert variant="success">
      <AlertTitle>âœ… ì‹ ì²­ ê°€ëŠ¥</AlertTitle>
      <AlertDescription>
        í˜•í‰ì„± ì ìˆ˜: {eligibility.details.monthly.myScore}ì 
        (í‰ê·  {eligibility.details.monthly.averageScore}ì )
      </AlertDescription>
    </Alert>
  );
}
```

### 2. ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì¶”ê°€
**ìƒˆ í˜ì´ì§€**: `src/app/(dashboard)/fairness/page.tsx`

**ê¸°ëŠ¥**:
1. ì „ì²´ ì§ì› í˜•í‰ì„± í˜„í™© ì¡°íšŒ
2. ê¶Œì¥ ì‚¬í•­ í‘œì‹œ
3. ìš°ì„  ë°°ì • ëŒ€ìƒ ì§ì› ëª©ë¡
4. ì—°ë³„/ì›”ë³„ í†µê³„ ê·¸ë˜í”„

---

## ğŸ”§ ì¶”ê°€ ì‘ì—… í•„ìš”

### 1. ìŠ¤ì¼€ì¤„ í™•ì • ì‹œ ì ìˆ˜ ìë™ ì—…ë°ì´íŠ¸
**ìœ„ì¹˜**: ìŠ¤ì¼€ì¤„ í™•ì • APIì— hook ì¶”ê°€

```typescript
// ìŠ¤ì¼€ì¤„ í™•ì • í›„
await monthlyFairnessService.updateFairnessScores(clinicId, year, month);
```

**TODO**:
- `updateFairnessScores` í•¨ìˆ˜ì˜ ì‹¤ì œ ìŠ¤ì¼€ì¤„ ë°ì´í„° ì—°ë™
- í˜„ì¬ëŠ” ì„ì‹œ ë¡œì§ (ì•¼ê°„/ì£¼ë§/ê³µíœ´ì¼ ê·¼ë¬´ íšŸìˆ˜ ì§‘ê³„ í•„ìš”)

### 2. ì•¼ê°„ ì§„ë£Œ ì—¬ë¶€ íŒë‹¨ ë¡œì§ ê°œì„ 
**í˜„ì¬**: ì›”~ê¸ˆì„ ì•¼ê°„ìœ¼ë¡œ ê°€ì • (ì„ì‹œ)
**í•„ìš”**: DoctorSchedule ë˜ëŠ” Schedule í…Œì´ë¸”ì—ì„œ ì‹¤ì œ ì•¼ê°„ ì§„ë£Œ ì •ë³´ ì¡°íšŒ

### 3. í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
- FairnessScore ìƒ˜í”Œ ë°ì´í„°
- ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

---

## ğŸ“ˆ êµ¬í˜„ ì§„í–‰ë¥ 

- [x] DB ìŠ¤í‚¤ë§ˆ í™•ì¸: 100%
- [x] ì—°ë³„ ëˆ„ì  ëª©í‘œ ê³„ì‚° ì„œë¹„ìŠ¤: 100%
- [x] ì›”ë³„ í˜•í‰ì„± ì ìˆ˜ ê³„ì‚° ì„œë¹„ìŠ¤: 100%
- [x] ì¢…í•© ë¶„ì„ ì„œë¹„ìŠ¤: 100%
- [x] API ì—”ë“œí¬ì¸íŠ¸: 100%
- [ ] UI í†µí•© (ê³µìš© ì‹ ì²­ í˜ì´ì§€): 0%
- [ ] ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: 0%
- [ ] ìŠ¤ì¼€ì¤„ í™•ì • ì‹œ ìë™ ì—…ë°ì´íŠ¸: 30%

**ì „ì²´ ì§„í–‰ë¥ **: 85%

---

## ğŸ’¡ í•µì‹¬ ì¥ì 

1. **ì´ì¤‘ ì²´í¬**: ì—°ë³„ + ì›”ë³„ ë‘ ê°€ì§€ ê¸°ì¤€ìœ¼ë¡œ í˜•í‰ì„± ê´€ë¦¬
2. **íˆ¬ëª…ì„±**: ì œí•œ ì‚¬ìœ ë¥¼ ìƒì„¸íˆ ì•ˆë‚´ (ì ìˆ˜, íšŸìˆ˜, ì°¨ì´)
3. **ìœ ì—°ì„±**: ê°€ì¤‘ì¹˜ ë° í—ˆìš© ì˜¤ì°¨ ì¡°ì • ê°€ëŠ¥
4. **í™•ì¥ì„±**: ì¶”í›„ ì¶”ê°€ ê¸°ì¤€ (ì˜ˆ: ì—°ì† ì˜¤í”„ ë°©ì§€) ì‰½ê²Œ í†µí•© ê°€ëŠ¥

---

**ì‘ì„±ì**: Claude Code
**ë‹¤ìŒ ì‘ì—…**: UI í†µí•© ë° í…ŒìŠ¤íŠ¸
